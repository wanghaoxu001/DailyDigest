# 强制关闭恢复机制 (Force Shutdown Recovery)

## 问题描述

当系统在执行任务时被强制关闭（如按 Ctrl+C、kill命令、系统崩溃等），会导致：

1. **内存状态丢失**: `current_tasks` 字典存储在内存中，重启后会丢失
2. **状态不一致**: 重启后系统认为没有任务在运行，但实际上之前的任务状态没有正确清理
3. **防重复执行失效**: 可能导致重复执行或资源冲突

## 解决方案

### 1. 任务状态持久化

**文件位置**: `task_status.tmp`

**保存时机**:
- 任务开始时 (`status='running'`)
- 任务结束时 (移除任务状态)

**保存内容**:
```json
{
  "running_tasks": ["crawl_sources"],
  "last_update": "2025-06-11T01:51:50.822110",
  "task_details": {
    "crawl_sources": {
      "message": "手动触发新闻源抓取任务",
      "start_time": "2025-06-11T01:51:50.822107"
    }
  }
}
```

### 2. 启动时自动检测与清理

**检测机制**:
- 系统启动时检查是否存在 `task_status.tmp` 文件
- 如果存在，说明上次是异常关闭

**清理流程**:
1. 读取任务状态文件
2. 记录清理日志到执行历史
3. 删除任务状态文件
4. 清空内存中的任务状态

### 3. 正常关闭清理

**触发时机**:
- 应用收到关闭信号时
- 调度器服务停止时

**清理动作**:
- 删除任务状态文件（如果存在）
- 清理内存中的任务状态

## 实现细节

### 核心方法

```python
def _cleanup_on_startup(self):
    """系统启动时清理任务状态"""
    
def _check_and_cleanup_incomplete_tasks(self):
    """检查并清理未完成的任务"""
    
def _save_task_status(self):
    """保存当前任务状态到临时文件"""
```

### 日志记录

**系统重启检测到未完成任务**:
```json
{
  "task_type": "system",
  "status": "warning",
  "message": "系统重启，清理了上次未完成的任务: crawl_sources",
  "details": {
    "cleanup_tasks": ["crawl_sources"],
    "startup_time": "2025-06-11T01:53:24.208273",
    "last_shutdown": "2025-06-11T01:51:50.822110"
  }
}
```

**正常启动**:
```json
{
  "task_type": "system",
  "status": "info",
  "message": "系统正常启动，初始化调度器服务",
  "details": {
    "startup_time": "2025-06-11T01:53:24.208273"
  }
}
```

## 使用场景

### 异常关闭恢复
1. 系统运行时有任务正在执行
2. 用户强制关闭应用 (Ctrl+C, kill, 系统重启等)
3. 重新启动应用
4. 系统自动检测到异常关闭并记录清理信息
5. 清理状态，恢复正常运行

### 防重复执行
- 通过持久化任务状态，即使异常重启也能正确防止重复任务
- 确保系统状态一致性

## 监控与调试

### 查看清理历史
```bash
curl "http://localhost:18899/api/sources/scheduler/history?limit=10"
```

### 手工清理（如需要）
```bash
rm -f task_status.tmp
```

### 日志监控
- 查看应用日志中的 "系统启动，清理前次运行的任务状态" 信息
- 检查是否有 "检测到系统异常关闭" 的警告

## 测试验证

1. **启动任务**: 手动触发新闻源抓取任务
2. **强制关闭**: 使用 `kill -9` 强制终止进程
3. **重新启动**: 启动应用
4. **检查结果**: 查看执行历史，确认有清理记录

预期结果：
- 执行历史中应包含 "系统重启，清理了上次未完成的任务" 的记录
- `task_status.tmp` 文件被清理
- 系统状态恢复正常，可以正常启动新任务

## 注意事项

1. **文件权限**: 确保应用有读写 `task_status.tmp` 文件的权限
2. **磁盘空间**: 临时文件很小，不会占用太多空间
3. **并发安全**: 文件操作有异常处理，确保系统稳定性
4. **性能影响**: 文件操作很轻量，对性能影响微乎其微 