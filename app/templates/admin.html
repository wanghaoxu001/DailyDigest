{% extends "base.html" %} {% block title %}管理 - 每日安全快报系统{% endblock %} {% block extra_css %}
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.5.0/font/bootstrap-icons.css" rel="stylesheet">
<style>
    /* Markdown样式 */
    
    .markdown-body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, Arial, sans-serif;
        line-height: 1.6;
    }
    
    .markdown-body h1,
    .markdown-body h2,
    .markdown-body h3,
    .markdown-body h4,
    .markdown-body h5,
    .markdown-body h6 {
        margin-top: 16px;
        margin-bottom: 16px;
        font-weight: 600;
        line-height: 1.25;
    }
    
    .markdown-body h1 {
        font-size: 2em;
    }
    
    .markdown-body h2 {
        font-size: 1.5em;
    }
    
    .markdown-body h3 {
        font-size: 1.25em;
    }
    
    .markdown-body h4 {
        font-size: 1em;
    }
    
    .markdown-body strong {
        font-weight: 600;
    }
    
    .markdown-body ul,
    .markdown-body ol {
        padding-left: 2em;
        margin-bottom: 16px;
    }
    
    .markdown-body li {
        margin: 0.25em 0;
    }
    
    .markdown-body p {
        margin-top: 0;
        margin-bottom: 16px;
    }
    
    .markdown-body code {
        padding: 0.2em 0.4em;
        margin: 0;
        background-color: rgba(27, 31, 35, 0.05);
        border-radius: 3px;
    }
    
    .markdown-body pre {
        padding: 16px;
        overflow: auto;
        line-height: 1.45;
        background-color: #f6f8fa;
        border-radius: 3px;
    }
</style>
{% endblock %} {% block content %}
<h2>系统管理</h2>

<ul class="nav nav-tabs mb-4" id="adminTabs" role="tablist">
    <li class="nav-item" role="presentation">
        <button class="nav-link active" id="sources-tab" data-bs-toggle="tab" data-bs-target="#sources" type="button" role="tab">
            新闻源管理
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="news-tab" data-bs-toggle="tab" data-bs-target="#news" type="button" role="tab">
            新闻管理
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="scheduler-tab" data-bs-toggle="tab" data-bs-target="#scheduler" type="button" role="tab">
            定时任务
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="system-tab" data-bs-toggle="tab" data-bs-target="#system" type="button" role="tab">
            系统设置
        </button>
    </li>
</ul>

<div class="tab-content" id="adminTabsContent">
    <!-- 新闻源管理 -->
    <div class="tab-pane fade show active" id="sources" role="tabpanel">
        <div class="d-flex justify-content-between mb-3">
            <h3>新闻源管理</h3>
            <button class="btn btn-primary" id="btnAddSource" data-bs-toggle="modal" data-bs-target="#sourceModal">
                <i class="bi bi-plus"></i> 添加新闻源
            </button>
        </div>

        <div class="card mb-4">
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-striped" id="sourcesTable">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>名称</th>
                                <th>类型</th>
                                <th>URL</th>
                                <th>状态</th>
                                <th>配置</th>
                                <th>最后抓取</th>
                                <th>Token使用量</th>
                                <th>操作</th>
                            </tr>
                        </thead>
                        <tbody id="sourcesTableBody">
                            <!-- 数据将通过JavaScript动态加载 -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- 新闻管理 -->
    <div class="tab-pane fade" id="news" role="tabpanel">
        <div class="d-flex justify-content-between mb-3">
            <h3>新闻管理</h3>
            <div>
                <select class="form-select form-select-sm d-inline-block me-2" style="width: auto;" id="newsSourceFilter">
                    <option value="">所有来源</option>
                    <!-- 来源选项将动态加载 -->
                </select>
                <select class="form-select form-select-sm d-inline-block" style="width: auto;" id="newsCategoryFilter">
                    <option value="">所有分类</option>
                    <option value="金融业网络安全事件">金融业网络安全</option>
                    <option value="重大网络安全事件">重大网络安全</option>
                    <option value="重大数据泄露事件">数据泄露</option>
                    <option value="重大漏洞风险提示">漏洞风险</option>
                    <option value="其他">其他</option>
                </select>
            </div>
        </div>

        <div class="card mb-4">
            <div class="card-body">
                <!-- 批量操作按钮 -->
                <div class="mb-3 d-flex justify-content-between">
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="selectAllNews">
                        <label class="form-check-label" for="selectAllNews">全选</label>
                    </div>
                    <div>
                        <button class="btn btn-sm btn-primary me-2" id="btnBatchProcess" disabled>
                            <i class="bi bi-gear"></i> 批量重新处理
                        </button>
                        <button class="btn btn-sm btn-danger" id="btnBatchDelete" disabled>
                            <i class="bi bi-trash"></i> 批量删除
                        </button>
                    </div>
                </div>
                <div class="table-responsive">
                    <table class="table table-striped" id="newsTable">
                        <thead>
                            <tr>
                                <th><input type="checkbox" class="invisible" disabled></th>
                                <th>ID</th>
                                <th>标题</th>
                                <th>来源</th>
                                <th>分类</th>
                                <th>时间</th>
                                <th>已处理</th>
                                <th>已用于快报</th>
                                <th>操作</th>
                            </tr>
                        </thead>
                        <tbody id="newsTableBody">
                            <!-- 数据将通过JavaScript动态加载 -->
                        </tbody>
                    </table>
                    <nav>
                        <ul class="pagination justify-content-center" id="newsPagination">
                            <!-- 分页控件将动态生成 -->
                        </ul>
                    </nav>
                </div>
            </div>
        </div>
    </div>

    <!-- 定时任务管理 -->
    <div class="tab-pane fade" id="scheduler" role="tabpanel">
        <h3>定时任务管理</h3>

        <!-- 任务状态概览 -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="card bg-primary">
                    <div class="card-body">
                        <div class="d-flex justify-content-between">
                            <div>
                                <h5 class="card-title text-white">调度器状态</h5>
                                <div class="card-text text-white" id="schedulerStatus">检查中...</div>
                            </div>
                            <div class="align-self-center">
                                <i class="bi bi-cpu fs-1 text-white"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-white bg-success">
                    <div class="card-body">
                        <div class="d-flex justify-content-between">
                            <div>
                                <h5 class="card-title">24h执行次数</h5>
                                <p class="card-text" id="executionCount">0</p>
                            </div>
                            <div class="align-self-center">
                                <i class="bi bi-clock-history fs-1"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-white bg-warning">
                    <div class="card-body">
                        <div class="d-flex justify-content-between">
                            <div>
                                <h5 class="card-title">24h错误次数</h5>
                                <p class="card-text" id="errorCount">0</p>
                            </div>
                            <div class="align-self-center">
                                <i class="bi bi-exclamation-triangle fs-1"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-white bg-info">
                    <div class="card-body">
                        <div class="d-flex justify-content-between">
                            <div>
                                <h5 class="card-title">活跃任务数</h5>
                                <p class="card-text" id="activeJobs">0</p>
                            </div>
                            <div class="align-self-center">
                                <i class="bi bi-list-task fs-1"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 任务控制面板 -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="card-title mb-0">任务控制</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <h6>手动触发任务</h6>
                        <button class="btn btn-warning me-2 mb-2" id="btnManualCrawl">
                            <i class="bi bi-cloud-download"></i> 立即抓取新闻源
                        </button>
                        <div class="btn-group mb-2" role="group">
                            <button class="btn btn-info" id="btnManualEventGroups">
                                <i class="bi bi-diagram-3"></i> 立即计算相似度和分组
                            </button>
                            <button type="button" class="btn btn-outline-info dropdown-toggle dropdown-toggle-split" data-bs-toggle="dropdown">
                                <span class="visually-hidden">配置选项</span>
                            </button>
                            <ul class="dropdown-menu">
                                <li>
                                    <div class="dropdown-item-text">
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="useMultiprocessSimilarity" checked>
                                            <label class="form-check-label" for="useMultiprocessSimilarity">
                                                使用多进程计算（推荐）
                                            </label>
                                        </div>
                                        <small class="text-muted">多进程计算可大幅提升相似度计算性能</small>
                                    </div>
                                </li>
                                <li>
                                    <hr class="dropdown-divider">
                                </li>
                                <li><a class="dropdown-item" href="#" onclick="showSimilarityHelp()"><i class="bi bi-question-circle"></i> 性能说明</a></li>
                            </ul>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <h6>定时设置</h6>
                        <form id="schedulerSettingsForm">
                            <div class="mb-2">
                                <label for="crawlInterval" class="form-label">新闻源抓取间隔（小时）</label>
                                <input type="number" class="form-control" id="crawlInterval" min="0.25" max="24" step="0.25" value="1">
                            </div>
                            <div class="mb-2">
                                <label for="eventInterval" class="form-label">相似度计算和分组间隔（小时）</label>
                                <input type="number" class="form-control" id="eventInterval" min="1" max="24" step="1" value="1">
                                <small class="text-muted">计算文章相似度并生成事件分组，优化后大幅提升前端响应速度</small>
                            </div>
                            <button type="submit" class="btn btn-primary">更新设置</button>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <!-- 执行历史 -->
        <div class="card mb-4">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="card-title mb-0">执行历史</h5>
                <div>
                    <select class="form-select form-select-sm me-2" id="historyTaskFilter" style="width: auto; display: inline-block;">
                        <option value="">所有任务</option>
                        <option value="crawl_sources">新闻源抓取</option>
                        <option value="event_groups">相似度和分组</option>
                        <option value="cache_cleanup">缓存清理</option>
                        <option value="config">配置更新</option>
                    </select>
                    <button class="btn btn-sm btn-outline-primary" id="btnRefreshHistory">
                        <i class="bi bi-arrow-repeat"></i> 刷新
                    </button>
                </div>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-striped" id="historyTable">
                        <thead>
                            <tr>
                                <th>时间</th>
                                <th>任务类型</th>
                                <th>状态</th>
                                <th>消息</th>
                                <th>执行时间</th>
                                <th>操作</th>
                            </tr>
                        </thead>
                        <tbody id="historyTableBody">
                            <!-- 历史记录将动态加载 -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- 错误记录 -->
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="card-title mb-0">错误记录</h5>
                <button class="btn btn-sm btn-outline-primary" id="btnRefreshErrors">
                    <i class="bi bi-arrow-repeat"></i> 刷新
                </button>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-striped" id="errorsTable">
                        <thead>
                            <tr>
                                <th>时间</th>
                                <th>任务类型</th>
                                <th>错误消息</th>
                                <th>操作</th>
                            </tr>
                        </thead>
                        <tbody id="errorsTableBody">
                            <!-- 错误记录将动态加载 -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- 系统设置 -->
    <div class="tab-pane fade" id="system" role="tabpanel">
        <h3>系统设置</h3>

        <div class="card mb-4">
            <div class="card-body">
                <form id="systemSettingsForm">
                    <div class="mb-3">
                        <label for="apiKey" class="form-label">OpenAI API密钥</label>
                        <input type="password" class="form-control" id="apiKey" placeholder="输入OpenAI API密钥">
                    </div>
                    <div class="mb-3">
                        <label for="fetchInterval" class="form-label">默认抓取间隔（秒）</label>
                        <input type="number" class="form-control" id="fetchInterval" value="3600">
                    </div>
                    <div class="mb-3">
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="enableAutoProcess" checked>
                            <label class="form-check-label" for="enableAutoProcess">自动处理新抓取的文章</label>
                        </div>
                    </div>
                    <button type="submit" class="btn btn-primary">保存设置</button>
                </form>
            </div>
        </div>

        <h3>系统操作</h3>
        <div class="card">
            <div class="card-body">
                <button class="btn btn-warning me-2" id="btnFetchAllSources">
                    <i class="bi bi-cloud-download"></i> 抓取所有新闻源
                </button>
                <button class="btn btn-warning me-2" id="btnProcessAllNews">
                    <i class="bi bi-gear"></i> 处理所有未处理新闻
                </button>
                <button class="btn btn-danger" id="btnClearOldNews">
                    <i class="bi bi-trash"></i> 清理历史数据
                </button>
            </div>
        </div>
    </div>
</div>

<!-- 新闻源模态框 -->
<div class="modal fade" id="sourceModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="sourceModalTitle">添加新闻源</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="sourceForm">
                    <input type="hidden" id="sourceId">
                    <div class="mb-3">
                        <label for="sourceName" class="form-label">名称</label>
                        <input type="text" class="form-control" id="sourceName" required>
                    </div>
                    <div class="mb-3">
                        <label for="sourceUrl" class="form-label">URL</label>
                        <input type="url" class="form-control" id="sourceUrl" required>
                    </div>
                    <div class="mb-3">
                        <label for="sourceType" class="form-label">类型</label>
                        <select class="form-select" id="sourceType" required>
                            <option value="rss">RSS订阅源</option>
                            <option value="webpage">网页抓取</option>
                        </select>
                    </div>
                    <div class="mb-3" id="xpathConfigGroup" style="display: none;">
                        <label for="xpathConfig" class="form-label">XPath配置</label>
                        <textarea class="form-control" id="xpathConfig" rows="3"></textarea>
                        <small class="form-text text-muted">用于网页抓取的XPath表达式，JSON格式</small>
                    </div>
                    <div class="mb-3" id="rssConfigGroup">
                        <div class="form-check">
                            <input type="checkbox" class="form-check-input" id="useRssSummary" checked>
                            <label class="form-check-label" for="useRssSummary">参考RSS原始摘要</label>
                            <small class="form-text text-muted d-block">勾选后，如果RSS条目包含高质量摘要，将优先使用原始摘要而不是LLM生成摘要</small>
                        </div>
                        <div class="form-check mt-3">
                            <input type="checkbox" class="form-check-input" id="useNewspaper" checked>
                            <label class="form-check-label" for="useNewspaper">优先使用Newspaper4k获取文章内容</label>
                            <small class="form-text text-muted d-block">勾选后，将尝试从文章URL获取完整内容，失败时使用RSS条目内容。不勾选则直接使用RSS条目内容</small>
                        </div>
                        <div class="form-check mt-3">
                            <input type="checkbox" class="form-check-input" id="useDescriptionAsSummary">
                            <label class="form-check-label" for="useDescriptionAsSummary">使用description作为备选摘要</label>
                            <small class="form-text text-muted d-block">勾选后，当RSS条目的summary质量不佳时，将使用description字段作为备选摘要</small>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="fetchInterval" class="form-label">抓取间隔（秒）</label>
                        <input type="number" class="form-control" id="sourceFetchInterval" value="3600" required>
                    </div>
                    <div class="mb-3">
                        <label for="sourceMaxFetchDays" class="form-label">最多拉取天数</label>
                        <input type="number" class="form-control" id="sourceMaxFetchDays" value="7" min="1" max="30" required>
                        <small class="form-text text-muted">设置订阅源拉取新闻时最多拉取最近X天的文章，防止拉取时间过久（1-30天）</small>
                    </div>
                    <div class="mb-3">
                        <label for="sourceDescription" class="form-label">描述</label>
                        <textarea class="form-control" id="sourceDescription" rows="2"></textarea>
                    </div>
                    <div class="mb-3 form-check">
                        <input type="checkbox" class="form-check-input" id="sourceActive" checked>
                        <label class="form-check-label" for="sourceActive">启用</label>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn btn-primary" id="btnSaveSource">保存</button>
            </div>
        </div>
    </div>
</div>

<!-- 新闻详情模态框 -->
<div class="modal fade" id="newsModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="newsModalTitle">新闻详情</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div id="newsDetails">
                    <!-- 新闻详情将动态加载 -->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
                <button type="button" class="btn btn-primary" id="btnProcessNews">处理/重新处理</button>
            </div>
        </div>
    </div>
</div>

<!-- 日志查看模态框 -->
<div class="modal fade" id="logsModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">处理日志</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="d-flex justify-content-between mb-2">
                    <span class="text-muted">上次更新: <span id="logTimestamp"></span></span>
                    <div>
                        <button class="btn btn-sm btn-outline-primary me-1" id="btnRefreshLogs">
                            <i class="bi bi-arrow-repeat"></i> 刷新
                        </button>
                        <button class="btn btn-sm btn-outline-danger" id="btnClearLogs">
                            <i class="bi bi-trash"></i> 清空
                        </button>
                    </div>
                </div>
                <div class="bg-dark text-light p-3 rounded" style="height: 500px; overflow-y: auto; font-family: monospace;">
                    <pre id="logContent" class="m-0"></pre>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
            </div>
        </div>
    </div>
</div>
{% endblock %} {% block extra_js %}
<!-- 添加Marked.js库用于Markdown渲染 -->
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<!-- 添加DOMPurify库用于HTML净化，防止XSS攻击 -->
<script src="https://cdn.jsdelivr.net/npm/dompurify@2.3.10/dist/purify.min.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // 配置marked.js
        marked.setOptions({
            breaks: true, // 转换换行符为<br>
            gfm: true // 启用GitHub风格的Markdown
        });

        // 加载新闻源列表
        loadSources();

        // 加载新闻列表
        loadNews();

        // 监听新闻源类型变更
        document.getElementById('sourceType').addEventListener('change', function() {
            const xpathGroup = document.getElementById('xpathConfigGroup');
            const rssGroup = document.getElementById('rssConfigGroup');
            if (this.value === 'webpage') {
                xpathGroup.style.display = 'block';
                rssGroup.style.display = 'none';
            } else {
                xpathGroup.style.display = 'none';
                rssGroup.style.display = 'block';
            }
        });

        // 保存新闻源
        document.getElementById('btnSaveSource').addEventListener('click', saveSource);

        // 添加新闻源按钮
        document.getElementById('btnAddSource').addEventListener('click', function() {
            // 重置表单
            document.getElementById('sourceForm').reset();
            document.getElementById('sourceId').value = '';
            document.getElementById('sourceFetchInterval').value = '3600';
            document.getElementById('sourceMaxFetchDays').value = '7';
            document.getElementById('sourceActive').checked = true;
            document.getElementById('useRssSummary').checked = true;
            document.getElementById('useNewspaper').checked = true;
            document.getElementById('useDescriptionAsSummary').checked = false;

            // 显示/隐藏配置组（默认RSS类型）
            document.getElementById('xpathConfigGroup').style.display = 'none';
            document.getElementById('rssConfigGroup').style.display = 'block';

            // 更新标题
            document.getElementById('sourceModalTitle').textContent = '添加新闻源';
        });

        // 处理新闻
        document.getElementById('btnProcessNews').addEventListener('click', processCurrentNews);

        // 新闻筛选器变更事件
        document.getElementById('newsSourceFilter').addEventListener('change', loadNews);
        document.getElementById('newsCategoryFilter').addEventListener('change', loadNews);

        // 系统操作按钮
        document.getElementById('btnFetchAllSources').addEventListener('click', fetchAllSources);
        document.getElementById('btnProcessAllNews').addEventListener('click', processAllNews);
        document.getElementById('btnClearOldNews').addEventListener('click', clearOldNews);

        // 系统设置表单提交
        document.getElementById('systemSettingsForm').addEventListener('submit', function(e) {
            e.preventDefault();
            saveSystemSettings();
        });

        // 日志相关按钮
        document.getElementById('btnRefreshLogs').addEventListener('click', fetchLogs);
        document.getElementById('btnClearLogs').addEventListener('click', clearLogs);

        // 批量操作相关
        document.getElementById('selectAllNews').addEventListener('change', toggleSelectAllNews);
        document.getElementById('btnBatchProcess').addEventListener('click', batchProcessNews);
        document.getElementById('btnBatchDelete').addEventListener('click', batchDeleteNews);

        // ========== 定时任务相关事件绑定 ==========

        // 手动触发任务按钮
        document.getElementById('btnManualCrawl').addEventListener('click', triggerManualCrawl);
        document.getElementById('btnManualEventGroups').addEventListener('click', triggerManualEventGroups);

        // 定时设置表单提交
        document.getElementById('schedulerSettingsForm').addEventListener('submit', function(e) {
            e.preventDefault();
            updateSchedulerSettings();
        });

        // 历史记录刷新和过滤
        document.getElementById('btnRefreshHistory').addEventListener('click', () => loadSchedulerStatus());
        document.getElementById('historyTaskFilter').addEventListener('change', filterHistory);

        // 错误记录刷新
        document.getElementById('btnRefreshErrors').addEventListener('click', () => loadSchedulerStatus());

        // 监听标签页切换，当切换到定时任务页面时加载数据
        document.getElementById('scheduler-tab').addEventListener('shown.bs.tab', function() {
            loadSchedulerStatus();

            // 设置定时刷新（每30秒）
            if (window.schedulerRefreshInterval) {
                clearInterval(window.schedulerRefreshInterval);
            }
            window.schedulerRefreshInterval = setInterval(loadSchedulerStatus, 30000);
        });

        // 当离开定时任务页面时清除定时刷新
        document.querySelectorAll('#adminTabs button[data-bs-toggle="tab"]').forEach(tab => {
            if (tab.id !== 'scheduler-tab') {
                tab.addEventListener('shown.bs.tab', function() {
                    if (window.schedulerRefreshInterval) {
                        clearInterval(window.schedulerRefreshInterval);
                        window.schedulerRefreshInterval = null;
                    }
                });
            }
        });
    });

    let currentNewsId = null;

    // 加载新闻源列表
    function loadSources() {
        axios.get('/api/sources')
            .then(response => {
                const sources = response.data;
                const tbody = document.getElementById('sourcesTableBody');
                tbody.innerHTML = '';

                const sourceFilter = document.getElementById('newsSourceFilter');
                sourceFilter.innerHTML = '<option value="">所有来源</option>';

                sources.forEach(source => {
                    // 添加到表格
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${source.id}</td>
                        <td>${source.name}</td>
                        <td>${source.type === 'rss' ? 'RSS订阅源' : '网页抓取'}</td>
                        <td><a href="${source.url}" target="_blank">${source.url.substring(0, 30)}...</a></td>
                        <td>${source.active ? '<span class="badge bg-success">激活</span>' : '<span class="badge bg-secondary">停用</span>'}</td>
                        <td>
                            <small class="text-muted">
                                间隔: ${Math.round(source.fetch_interval / 3600)}h<br>
                                天数: ${source.max_fetch_days || 7}天<br>
                                ${source.type === 'rss' ? (source.use_description_as_summary ? '使用备选摘要' : '仅summary') : ''}
                            </small>
                        </td>
                        <td>${source.last_fetch || '从未'}</td>
                        <td>${source.tokens_used ? source.tokens_used.toLocaleString() : '0'} 
                            <button class="btn btn-sm btn-outline-secondary" title="重置Token计数" onclick="resetTokens(${source.id})">
                                <i class="bi bi-arrow-counterclockwise"></i>
                            </button>
                            <br>
                            <small class="text-muted">
                                输入: ${source.prompt_tokens ? source.prompt_tokens.toLocaleString() : '0'} | 
                                输出: ${source.completion_tokens ? source.completion_tokens.toLocaleString() : '0'}
                            </small>
                        </td>
                        <td>
                            <button class="btn btn-sm btn-outline-primary me-1" onclick="editSource(${source.id})">
                                <i class="bi bi-pencil"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-success me-1" onclick="fetchSource(${source.id})">
                                <i class="bi bi-cloud-download"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-info me-1" onclick="viewLogs()">
                                <i class="bi bi-file-text"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-danger" onclick="deleteSource(${source.id})">
                                <i class="bi bi-trash"></i>
                            </button>
                        </td>
                    `;
                    tbody.appendChild(row);

                    // 添加到过滤器
                    const option = document.createElement('option');
                    option.value = source.id;
                    option.textContent = source.name;
                    sourceFilter.appendChild(option);
                });
            })
            .catch(error => {
                console.error('Error loading sources:', error);
                alert('加载新闻源失败');
            });
    }

    // 加载新闻列表
    function loadNews(page = 1) {
        // 确保page是有效数字
        page = Number(page) || 1;
        page = Math.max(1, page);

        const sourceId = document.getElementById('newsSourceFilter').value;
        const category = document.getElementById('newsCategoryFilter').value;

        // 确保skip是有效的非负整数
        const skip = (page - 1) * 20;
        let url = `/api/news?skip=${skip}&limit=20&enable_similarity_filter=false`;
        if (sourceId) url += `&source_id=${sourceId}`;
        if (category) url += `&category=${category}`;

        axios.get(url)
            .then(response => {
                const {
                    items,
                    total
                } = response.data;
                const tbody = document.getElementById('newsTableBody');
                tbody.innerHTML = '';

                // 清空已选状态
                selectedNewsIds = new Set();
                updateBatchButtons();

                items.forEach(news => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>
                            <input type="checkbox" class="form-check-input news-checkbox" 
                                   data-id="${news.id}" ${selectedNewsIds.has(news.id) ? 'checked' : ''}>
                        </td>
                        <td>${news.id}</td>
                        <td>${news.title.substring(0, 30)}${news.title.length > 30 ? '...' : ''}</td>
                        <td>${news.source_id}</td>
                        <td>${getCategoryLabel(news.category)}</td>
                        <td>${formatDate(news.created_at)}</td>
                        <td>${news.is_processed ? '<span class="badge bg-success">是</span>' : '<span class="badge bg-warning">否</span>'}</td>
                        <td>${news.is_used_in_digest ? '<span class="badge bg-success">是</span>' : '<span class="badge bg-secondary">否</span>'}</td>
                        <td>
                            <button class="btn btn-sm btn-outline-primary" onclick="viewNews(${news.id})">
                                <i class="bi bi-eye"></i>
                            </button>
                        </td>
                    `;
                    tbody.appendChild(row);

                    // 绑定复选框事件
                    const checkbox = row.querySelector('.news-checkbox');
                    checkbox.addEventListener('change', function() {
                        const newsId = parseInt(this.getAttribute('data-id'));
                        if (this.checked) {
                            selectedNewsIds.add(newsId);
                        } else {
                            selectedNewsIds.delete(newsId);
                        }
                        updateBatchButtons();
                    });
                });

                // 生成分页控件
                const pagination = document.getElementById('newsPagination');
                pagination.innerHTML = '';

                const totalPages = Math.ceil(total / 20);

                // 上一页
                const prevLi = document.createElement('li');
                prevLi.className = `page-item ${page === 1 ? 'disabled' : ''}`;
                prevLi.innerHTML = `<a class="page-link" href="#" onclick="loadNews(${page - 1}); return false;">上一页</a>`;
                pagination.appendChild(prevLi);

                // 页码
                for (let i = 1; i <= totalPages; i++) {
                    if (
                        i === 1 ||
                        i === totalPages ||
                        (i >= page - 2 && i <= page + 2)
                    ) {
                        const li = document.createElement('li');
                        li.className = `page-item ${i === page ? 'active' : ''}`;
                        li.innerHTML = `<a class="page-link" href="#" onclick="loadNews(${i}); return false;">${i}</a>`;
                        pagination.appendChild(li);
                    } else if (
                        (i === page - 3 && page > 4) ||
                        (i === page + 3 && page < totalPages - 3)
                    ) {
                        const li = document.createElement('li');
                        li.className = 'page-item disabled';
                        li.innerHTML = '<a class="page-link" href="#">...</a>';
                        pagination.appendChild(li);
                    }
                }

                // 下一页
                const nextLi = document.createElement('li');
                nextLi.className = `page-item ${page === totalPages ? 'disabled' : ''}`;
                nextLi.innerHTML = `<a class="page-link" href="#" onclick="loadNews(${page + 1}); return false;">下一页</a>`;
                pagination.appendChild(nextLi);
            })
            .catch(error => {
                console.error('Error loading news:', error);
                alert('加载新闻失败');
            });
    }

    // 查看新闻详情
    function viewNews(newsId) {
        currentNewsId = newsId;

        axios.get(`/api/news/${newsId}`)
            .then(response => {
                    const news = response.data;
                    const details = document.getElementById('newsDetails');

                    let entitiesHtml = '';
                    if (news.entities) {
                        entitiesHtml = '<div class="mt-3"><h6><strong>提取的实体</strong></h6><ul>';

                        // 检查实体是否为数组格式
                        if (Array.isArray(news.entities)) {
                            news.entities.forEach(entity => {
                                if (typeof entity === 'object' && entity !== null) {
                                    // 处理不同格式的实体对象
                                    if (entity.type && entity.value) {
                                        // 标准格式 {type: "...", value: "..."}
                                        entitiesHtml += `<li><strong>${entity.type}:</strong> ${entity.value}</li>`;
                                    } else {
                                        // 处理其他格式 {key: value}
                                        const entityType = Object.keys(entity)[0] || '未知类型';
                                        const entityValue = entity[entityType] || '未知';
                                        entitiesHtml += `<li><strong>${entityType}:</strong> ${entityValue}</li>`;
                                    }
                                } else {
                                    entitiesHtml += `<li>${entity}</li>`;
                                }
                            });
                        }
                        // 检查实体是否为对象格式
                        else if (typeof news.entities === 'object') {
                            // 检查是否有type和value字段的特殊对象
                            if (news.entities.type && news.entities.value) {
                                entitiesHtml += `<li><strong>${news.entities.type}:</strong> ${news.entities.value}</li>`;
                            } else {
                                // 常规对象格式 {key1: value1, key2: value2}
                                for (const [key, value] of Object.entries(news.entities)) {
                                    if (key !== 'error') {
                                        entitiesHtml += `<li><strong>${key}:</strong> ${value}</li>`;
                                    }
                                }
                            }
                        }

                        entitiesHtml += '</ul></div>';
                    }

                    details.innerHTML = `
                    <h4>${news.title}</h4>
                    <div class="text-muted mb-2">来源: ${news.source_id} | 时间: ${formatDate(news.created_at)}</div>
                    
                    <div class="card mb-3">
                        <div class="card-header bg-light">原始内容摘要</div>
                        <div class="card-body">
                            <p>${news.summary}</p>
                            <a href="${news.original_url}" target="_blank" class="btn btn-sm btn-outline-primary">查看原文</a>
                        </div>
                    </div>
                    
                    <div class="card mb-3">
                        <div class="card-header bg-light">处理结果</div>
                        <div class="card-body">
                            ${news.is_processed ? `
                                <div class="mb-2"><strong>一句话标题:</strong> ${news.generated_title || '暂无'}</div>
                                <div class="mb-2"><strong>摘要:</strong> ${news.generated_summary || '暂无'}</div>
                                
                                <!-- 详细文章总结部分 -->
                                <div class="mb-2"><strong>文章总结状态:</strong> ${news.article_summary ? '已生成' : '未生成'}</div>
                                ${news.article_summary ? `
                                <div class="card mb-3 mt-3">
                                    <div class="card-header bg-light">详细文章总结</div>
                                    <div class="card-body">
                                        <div class="article-summary markdown-body" id="articleSummaryContent">${DOMPurify.sanitize(marked.parse(news.article_summary))}</div>
                                    </div>
                                </div>
                                ` : '<div class="alert alert-info mt-2">该新闻还没有生成详细文章总结，请使用"处理/重新处理"功能重新处理此新闻</div>'}
                                
                                <div class="mb-2"><strong>分类:</strong> ${getCategoryLabel(news.category)}</div>
                                ${entitiesHtml}
                            ` : '<div class="alert alert-warning">该新闻尚未处理</div>'}
                        </div>
                    </div>

                    <!-- 调试信息 -->
                    <div class="card mb-3">
                        <div class="card-header bg-light">调试信息</div>
                        <div class="card-body">
                            <pre class="bg-light p-2 border rounded"><code>${JSON.stringify({
                                id: news.id,
                                is_processed: news.is_processed,
                                has_article_summary: news.article_summary ? true : false,
                                article_summary_length: news.article_summary ? news.article_summary.length : 0
                            }, null, 2)}</code></pre>
                        </div>
                    </div>
                `;
                
                // 显示模态框
                const modal = new bootstrap.Modal(document.getElementById('newsModal'));
                modal.show();
            })
            .catch(error => {
                console.error('Error loading news details:', error);
                alert('加载新闻详情失败');
            });
    }
    
    // 添加新闻源
    function addSource() {
        // 重置表单
        document.getElementById('sourceForm').reset();
        document.getElementById('sourceId').value = '';
        document.getElementById('sourceModalTitle').textContent = '添加新闻源';
        
        // 显示模态框
        const modal = new bootstrap.Modal(document.getElementById('sourceModal'));
        modal.show();
    }
    
    // 编辑新闻源
    function editSource(sourceId) {
        // 获取新闻源信息
        axios.get(`/api/sources/${sourceId}`)
            .then(response => {
                const source = response.data;
                
                // 填充表单
                document.getElementById('sourceId').value = source.id;
                document.getElementById('sourceName').value = source.name;
                document.getElementById('sourceUrl').value = source.url;
                document.getElementById('sourceType').value = source.type;
                document.getElementById('sourceFetchInterval').value = source.fetch_interval;
                document.getElementById('sourceMaxFetchDays').value = source.max_fetch_days || 7;
                document.getElementById('sourceDescription').value = source.description || '';
                document.getElementById('sourceActive').checked = source.active;
                document.getElementById('xpathConfig').value = source.xpath_config || '';
                document.getElementById('useRssSummary').checked = source.use_rss_summary !== undefined ? source.use_rss_summary : true;
                document.getElementById('useNewspaper').checked = source.use_newspaper !== undefined ? source.use_newspaper : true;
                document.getElementById('useDescriptionAsSummary').checked = source.use_description_as_summary !== undefined ? source.use_description_as_summary : false;
                
                // 显示/隐藏配置组
                const xpathGroup = document.getElementById('xpathConfigGroup');
                const rssGroup = document.getElementById('rssConfigGroup');
                if (source.type === 'webpage') {
                    xpathGroup.style.display = 'block';
                    rssGroup.style.display = 'none';
                } else {
                    xpathGroup.style.display = 'none';
                    rssGroup.style.display = 'block';
                }
                
                // 更新标题
                document.getElementById('sourceModalTitle').textContent = '编辑新闻源';
                
                // 显示模态框
                const modal = new bootstrap.Modal(document.getElementById('sourceModal'));
                modal.show();
            })
            .catch(error => {
                console.error('Error loading source:', error);
                alert('加载新闻源信息失败');
            });
    }
    
    // 保存新闻源
    function saveSource() {
        const sourceId = document.getElementById('sourceId').value;
        const sourceData = {
            name: document.getElementById('sourceName').value,
            url: document.getElementById('sourceUrl').value,
            type: document.getElementById('sourceType').value,
            fetch_interval: parseInt(document.getElementById('sourceFetchInterval').value),
            max_fetch_days: parseInt(document.getElementById('sourceMaxFetchDays').value),
            description: document.getElementById('sourceDescription').value,
            active: document.getElementById('sourceActive').checked,
            xpath_config: document.getElementById('xpathConfig').value,
            use_rss_summary: document.getElementById('useRssSummary').checked,
            use_newspaper: document.getElementById('useNewspaper').checked,
            use_description_as_summary: document.getElementById('useDescriptionAsSummary').checked
        };
        
        if (sourceId) {
            // 更新
            axios.put(`/api/sources/${sourceId}`, sourceData)
                .then(() => {
                    // 关闭模态框
                    const modal = bootstrap.Modal.getInstance(document.getElementById('sourceModal'));
                    modal.hide();
                    
                    // 重新加载列表
                    loadSources();
                })
                .catch(error => {
                    console.error('Error updating source:', error);
                    alert('更新新闻源失败');
                });
        } else {
            // 创建
            axios.post('/api/sources', sourceData)
                .then(() => {
                    // 关闭模态框
                    const modal = bootstrap.Modal.getInstance(document.getElementById('sourceModal'));
                    modal.hide();
                    
                    // 重新加载列表
                    loadSources();
                })
                .catch(error => {
                    console.error('Error creating source:', error);
                    alert('创建新闻源失败');
                });
        }
    }
    
    // 删除新闻源
    function deleteSource(sourceId) {
        if (confirm('确定要删除此新闻源吗？')) {
            axios.delete(`/api/sources/${sourceId}`)
                .then(() => {
                    loadSources();
                })
                .catch(error => {
                    console.error('Error deleting source:', error);
                    alert('删除新闻源失败');
                });
        }
    }
    
    // 重置token统计
    function resetTokens(sourceId) {
        if (confirm('确定要重置此新闻源的Token使用统计吗？')) {
            axios.post(`/api/sources/${sourceId}/reset-tokens`)
                .then(response => {
                    alert('Token统计已重置');
                    // 重新加载源列表
                    loadSources();
                })
                .catch(error => {
                    console.error('Error resetting tokens:', error);
                    alert('重置Token统计失败');
                });
        }
    }
    
    // 手动触发抓取
    function fetchSource(sourceId) {
        if (confirm('确定要手动抓取该新闻源吗？这可能需要一些时间')) {
            // 显示加载状态
            const btn = document.querySelector(`button[onclick="fetchSource(${sourceId})"]`);
            const originalHtml = btn.innerHTML;
            btn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> 抓取中...';
            btn.disabled = true;
            
            axios.post(`/api/sources/${sourceId}/crawl`)
                .then(() => {
                    // 恢复按钮状态
                    btn.innerHTML = originalHtml;
                    btn.disabled = false;
                    
                    // 显示成功消息
                    alert('抓取任务已触发，请查看日志了解详情');
                    
                    // 自动打开日志查看器
                    setTimeout(() => {
                        viewLogs();
                    }, 500);
                })
                .catch(error => {
                    // 恢复按钮状态
                    btn.innerHTML = originalHtml;
                    btn.disabled = false;
                    
                    console.error('Error triggering crawl:', error);
                    alert('触发抓取任务失败');
                });
        }
    }
    
    // 处理当前查看的新闻
    function processCurrentNews() {
        if (!currentNewsId) return;
        
        // 显示处理中状态
        const btn = document.getElementById('btnProcessNews');
        const originalText = btn.textContent;
        btn.disabled = true;
        btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> 处理中...';
        
        axios.post(`/api/news/${currentNewsId}/process`)
            .then(() => {
                // 恢复按钮状态
                btn.disabled = false;
                btn.textContent = originalText;
                
                // 关闭当前模态框
                const modal = bootstrap.Modal.getInstance(document.getElementById('newsModal'));
                if (modal) {
                    modal.hide();
                }
                
                // 显示成功消息
                alert('处理完成');
                
                // 刷新新闻列表
                loadNews();
            })
            .catch(error => {
                // 恢复按钮状态
                btn.disabled = false;
                btn.textContent = originalText;
                
                console.error('Error processing news:', error);
                alert('处理新闻失败');
            });
    }
    
    // 抓取所有新闻源
    function fetchAllSources() {
        if (confirm('确定要抓取所有活跃的新闻源吗？')) {
            // 实际项目中这里应该有一个API来触发批量抓取
            alert('批量抓取功能尚未实现');
        }
    }
    
    // 处理所有未处理新闻
    function processAllNews() {
        if (confirm('确定要处理所有未处理的新闻吗？')) {
            // 实际项目中这里应该有一个API来触发批量处理
            alert('批量处理功能尚未实现');
        }
    }
    
    // 清理历史数据
    function clearOldNews() {
        if (confirm('确定要清理历史新闻数据吗？')) {
            // 实际项目中这里应该有一个API来清理数据
            alert('数据清理功能尚未实现');
        }
    }
    
    // 保存系统设置
    function saveSystemSettings() {
        const settings = {
            api_key: document.getElementById('apiKey').value,
            fetch_interval: parseInt(document.getElementById('fetchInterval').value),
            enable_auto_process: document.getElementById('enableAutoProcess').checked
        };
        
        // 实际项目中这里应该有一个API来保存设置
        alert('设置保存功能尚未实现');
        console.log('Settings:', settings);
    }
    
    // 辅助函数 - 格式化日期
    function formatDate(dateStr) {
        if (!dateStr) return '';
        const date = new Date(dateStr);
        return date.toLocaleString();
    }
    
    // 辅助函数 - 获取分类标签
    function getCategoryLabel(category) {
        const categories = {
            '金融业网络安全事件': '<span class="badge bg-info">金融业</span>',
            '重大网络安全事件': '<span class="badge bg-danger">重大事件</span>',
            '重大数据泄露事件': '<span class="badge bg-warning">数据泄露</span>',
            '重大漏洞风险提示': '<span class="badge bg-primary">漏洞风险</span>',
            '其他': '<span class="badge bg-secondary">其他</span>'
        };
        
        return categories[category] || categories['其他'];
    }
    
    // 日志查看功能
    function viewLogs() {
        fetchLogs();
        const modal = new bootstrap.Modal(document.getElementById('logsModal'));
        modal.show();
    }
    
    function fetchLogs() {
        axios.get('/api/sources/logs')
            .then(response => {
                const { logs, timestamp } = response.data;
                document.getElementById('logContent').textContent = logs.join('\n');
                document.getElementById('logTimestamp').textContent = new Date(timestamp).toLocaleString();
                
                // 滚动到底部
                const logContainer = document.getElementById('logContent').parentNode;
                logContainer.scrollTop = logContainer.scrollHeight;
            })
            .catch(error => {
                console.error('获取日志失败:', error);
                document.getElementById('logContent').textContent = '获取日志失败: ' + error.message;
            });
    }
    
    function clearLogs() {
        if (confirm('确定要清空日志吗？')) {
            axios.post('/api/sources/logs/clear')
                .then(() => {
                    document.getElementById('logContent').textContent = '日志已清空';
                    document.getElementById('logTimestamp').textContent = new Date().toLocaleString();
                })
                .catch(error => {
                    console.error('清空日志失败:', error);
                    alert('清空日志失败');
                });
        }
    }
    
    // 存储选中的新闻ID
    let selectedNewsIds = new Set();
    
    // 切换全选/取消全选
    function toggleSelectAllNews() {
        const selectAll = document.getElementById('selectAllNews').checked;
        
        // 获取当前筛选条件
        const sourceId = document.getElementById('newsSourceFilter').value;
        const category = document.getElementById('newsCategoryFilter').value;
        
        // 构建API URL
        let url = `/api/news?limit=1000&enable_similarity_filter=false`; // 使用较大的limit值获取所有符合条件的新闻
        if (sourceId) url += `&source_id=${sourceId}`;
        if (category) url += `&category=${category}`;
        
        // 获取所有符合条件的新闻ID
        axios.get(url)
            .then(response => {
                const { items } = response.data;
                
                // 更新选中状态
            if (selectAll) {
                    items.forEach(news => {
                        selectedNewsIds.add(news.id);
                    });
            } else {
                    selectedNewsIds.clear();
            }
                
                // 更新当前页面的复选框状态
                const checkboxes = document.querySelectorAll('.news-checkbox');
                checkboxes.forEach(checkbox => {
                    checkbox.checked = selectAll;
        });
        
        updateBatchButtons();
            })
            .catch(error => {
                console.error('获取新闻列表失败:', error);
                alert('获取新闻列表失败，请重试');
            });
    }
    
    // 更新批量操作按钮状态
    function updateBatchButtons() {
        const count = selectedNewsIds.size;
        const batchProcess = document.getElementById('btnBatchProcess');
        const batchDelete = document.getElementById('btnBatchDelete');
        
        batchProcess.disabled = count === 0;
        batchDelete.disabled = count === 0;
        
        // 更新按钮文本，显示选中数量
        batchProcess.innerHTML = `<i class="bi bi-gear"></i> 批量重新处理 (${count})`;
        batchDelete.innerHTML = `<i class="bi bi-trash"></i> 批量删除 (${count})`;
        
        // 同步全选框状态
        const selectAllCheckbox = document.getElementById('selectAllNews');
        const allCheckboxes = document.querySelectorAll('.news-checkbox');
        
        if (allCheckboxes.length > 0) {
            selectAllCheckbox.checked = count === allCheckboxes.length;
            selectAllCheckbox.indeterminate = count > 0 && count < allCheckboxes.length;
        } else {
            selectAllCheckbox.checked = false;
            selectAllCheckbox.indeterminate = false;
        }
    }
    
    // 批量处理新闻
    function batchProcessNews() {
        if (selectedNewsIds.size === 0) return;
        
        if (!confirm(`确定要重新处理 ${selectedNewsIds.size} 条新闻吗？这可能需要一些时间。`)) return;
        
        // 禁用按钮，显示处理中状态
        const btn = document.getElementById('btnBatchProcess');
        const originalText = btn.innerHTML;
        btn.disabled = true;
        btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> 处理中...';
        
        // 创建处理队列
        const newsIds = Array.from(selectedNewsIds);
        let processed = 0;
        let failed = 0;
        
        // 定义递归处理函数
        function processNext(index) {
            if (index >= newsIds.length) {
                // 处理完成
                btn.disabled = false;
                btn.innerHTML = originalText;
                alert(`处理完成：成功${processed}条，失败${failed}条`);
                loadNews(); // 刷新列表
                return;
            }
            
            const newsId = newsIds[index];
            axios.post(`/api/news/${newsId}/process`)
                .then(() => {
                    processed++;
                    processNext(index + 1);
                })
                .catch(error => {
                    console.error(`处理新闻 ID ${newsId} 失败:`, error);
                    failed++;
                    processNext(index + 1);
                });
        }
        
        // 开始处理
        processNext(0);
    }
    
    // 批量删除新闻
    function batchDeleteNews() {
        if (selectedNewsIds.size === 0) return;
        
        if (!confirm(`确定要删除 ${selectedNewsIds.size} 条新闻吗？此操作不可撤销！`)) return;
        
        // 禁用按钮，显示处理中状态
        const btn = document.getElementById('btnBatchDelete');
        const originalText = btn.innerHTML;
        btn.disabled = true;
        btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> 删除中...';
        
        // 调用批量删除API
        axios.delete('/api/news/batch', {
            data: { news_ids: Array.from(selectedNewsIds) }
        })
        .then(response => {
            // 恢复按钮状态
            btn.disabled = false;
            btn.innerHTML = originalText;
            
            // 显示成功消息
            alert(`删除成功: ${selectedNewsIds.size}条新闻已删除`);
            
            // 刷新新闻列表
            selectedNewsIds.clear();
            loadNews();
        })
        .catch(error => {
            // 恢复按钮状态
            btn.disabled = false;
            btn.innerHTML = originalText;
            
            console.error('批量删除失败:', error);
            alert(`批量删除失败: ${error.response?.data?.detail || error.message}`);
        });
    }

    // ========== 定时任务管理功能 ==========
    
    // 定时任务状态数据
    let schedulerData = {
        status: null,
        statistics: null,
        history: [],
        errors: []
    };

    // 加载定时任务状态
    function loadSchedulerStatus() {
        Promise.all([
            axios.get('/api/sources/scheduler/status'),
            axios.get('/api/sources/scheduler/statistics'),
            axios.get('/api/sources/scheduler/history?limit=20'),
            axios.get('/api/sources/scheduler/errors?limit=10')
        ])
        .then(responses => {
            schedulerData.status = responses[0].data;
            schedulerData.statistics = responses[1].data;
            schedulerData.history = responses[2].data.history;
            schedulerData.errors = responses[3].data.errors;
            
            updateSchedulerDisplay();
        })
        .catch(error => {
            console.error('加载定时任务状态失败:', error);
            showSchedulerError('加载定时任务状态失败');
        });
    }

    // 更新定时任务显示
    function updateSchedulerDisplay() {
        updateStatusCards();
        updateSchedulerSettingsForm();
        updateHistoryTable();
        updateErrorsTable();
    }

            // 更新状态卡片
        function updateStatusCards() {
            const status = schedulerData.status;
            const stats = schedulerData.statistics;
            
            // 更新调度器状态
            const statusEl = document.getElementById('schedulerStatus');
            if (status.is_running) {
                let statusText = '<i class="bi bi-check-circle"></i> 运行中';
                
                // 如果有正在执行的任务，显示当前任务信息和进度
                if (status.current_tasks && Object.keys(status.current_tasks).length > 0) {
                    const currentTasks = Object.entries(status.current_tasks);
                    const taskInfo = currentTasks.map(([taskType, taskData]) => {
                        let taskStr = `${getTaskTypeLabel(taskType)}: ${taskData.message || '执行中'}`;
                        
                                        // 如果有进度信息，添加进度条
                if (taskData.progress && (taskData.progress.percentage !== undefined || (taskData.progress.current && taskData.progress.total))) {
                    const percentage = taskData.progress.percentage || 0;
                    const current = taskData.progress.current || 0;
                    const total = taskData.progress.total || 0;
                    
                    taskStr += `<br><div class="progress mt-1" style="height: 15px;">
                        <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" 
                             style="width: ${percentage}%" aria-valuenow="${percentage}" aria-valuemin="0" aria-valuemax="100">
                            ${percentage.toFixed(1)}%
                        </div>
                    </div>`;
                    
                    if (current && total) {
                        taskStr += `<small class="text-light">${current}/${total}</small>`;
                    }
                }
                        
                        return taskStr;
                    }).join('<br><br>');
                    statusText += `<br><div class="mt-2"><small class="text-muted">当前任务:</small><br>${taskInfo}</div>`;
                }
                
                statusEl.innerHTML = statusText;
                statusEl.className = 'card-text text-white';
            } else {
                statusEl.innerHTML = '<i class="bi bi-x-circle"></i> 已停止';
                statusEl.className = 'card-text text-white';
            }
            
            // 更新统计数据
            document.getElementById('executionCount').textContent = stats.total_executions_24h || 0;
            document.getElementById('errorCount').textContent = stats.total_errors_24h || 0;
            document.getElementById('activeJobs').textContent = status.scheduled_jobs_count || 0;
            
            // 更新当前任务数量
            const currentTasksCount = status.current_tasks ? Object.keys(status.current_tasks).length : 0;
            if (currentTasksCount > 0) {
                document.getElementById('activeJobs').innerHTML = `${status.scheduled_jobs_count || 0} <small class="text-info">(${currentTasksCount} 运行中)</small>`;
            }
        }

    // 更新定时设置表单显示
    function updateSchedulerSettingsForm() {
        const status = schedulerData.status;
        document.getElementById('crawlInterval').value = status.crawl_sources_interval || 1;
        document.getElementById('eventInterval').value = status.event_generation_interval || 1;
    }

    // 更新历史记录表
    function updateHistoryTable() {
        const tbody = document.getElementById('historyTableBody');
        tbody.innerHTML = '';
        
        schedulerData.history.forEach(record => {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${formatDateTime(record.timestamp)}</td>
                <td>${getTaskTypeLabel(record.task_type)}</td>
                <td>${getStatusBadge(record.status)}</td>
                <td class="text-truncate" style="max-width: 300px;" title="${record.message}">${record.message}</td>
                <td>${record.details?.execution_time ? (record.details.execution_time).toFixed(2) + 's' : '-'}</td>
                <td>
                    <button class="btn btn-sm btn-outline-info" onclick="showTaskDetails('${record.timestamp}')">
                        <i class="bi bi-eye"></i> 详情
                    </button>
                </td>
            `;
            tbody.appendChild(row);
        });
    }
    
    // 显示任务详情
    function showTaskDetails(timestamp) {
        // 显示加载状态
        const modal = new bootstrap.Modal(document.getElementById('taskDetailsModal'));
        document.getElementById('taskDetailsBody').innerHTML = '<div class="text-center"><div class="spinner-border" role="status"></div><p class="mt-2">加载中...</p></div>';
        modal.show();
        
        // 获取任务详情
        axios.get(`/api/sources/scheduler/task-details/${encodeURIComponent(timestamp)}`)
            .then(response => {
                const details = response.data.task_details;
                displayTaskDetails(details);
            })
            .catch(error => {
                console.error('获取任务详情失败:', error);
                document.getElementById('taskDetailsBody').innerHTML = `
                    <div class="alert alert-danger">
                        <i class="bi bi-exclamation-triangle"></i> 
                        获取任务详情失败: ${error.response?.data?.detail || error.message}
                    </div>
                `;
            });
    }
    
    // 显示任务详情内容
    function displayTaskDetails(details) {
        const body = document.getElementById('taskDetailsBody');
        
        let detailsHtml = `
            <div class="row">
                <div class="col-md-6">
                    <h6>基本信息</h6>
                    <table class="table table-sm">
                        <tr><th width="30%">执行时间:</th><td>${formatDateTime(details.timestamp)}</td></tr>
                        <tr><th>任务类型:</th><td>${getTaskTypeLabel(details.task_type)}</td></tr>
                        <tr><th>状态:</th><td>${getStatusBadge(details.status)}</td></tr>
                        <tr><th>耗时:</th><td>${details.details?.execution_time ? (details.details.execution_time).toFixed(2) + '秒' : '未知'}</td></tr>
                    </table>
                </div>
                <div class="col-md-6">
                    <h6>执行信息</h6>
                    <p class="border p-2 bg-light rounded" style="word-break: break-word;">${details.message}</p>
                </div>
            </div>
        `;
        
        // 根据任务类型显示特定详情
        if (details.details && Object.keys(details.details).length > 0) {
            detailsHtml += '<hr><h6>详细信息</h6>';
            
            if (details.task_type === 'event_groups') {
                detailsHtml += renderEventGroupsDetails(details.details);
            } else if (details.task_type === 'crawl_sources') {
                detailsHtml += renderCrawlSourcesDetails(details.details);
            } else if (details.task_type === 'cache_cleanup') {
                detailsHtml += renderCacheCleanupDetails(details.details);
            } else {
                detailsHtml += renderGenericDetails(details.details);
            }
        }
        
        body.innerHTML = detailsHtml;
    }
    
    // 渲染事件分组任务详情
    function renderEventGroupsDetails(details) {
        let html = '<div class="row">';
        
        if (details.stage_details) {
            const stages = details.stage_details;
            html += `
                <div class="col-md-12">
                    <h6>执行阶段详情</h6>
                    <div class="accordion" id="stageAccordion">
                        <div class="accordion-item">
                            <h2 class="accordion-header">
                                <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#similarity">
                                    相似度计算
                                </button>
                            </h2>
                            <div id="similarity" class="accordion-collapse collapse show" data-bs-parent="#stageAccordion">
                                <div class="accordion-body">
                                    <p>新增相似度记录: <strong>${stages.similarity_computation?.new_similarities || 0}</strong> 条</p>
                                    <p>总处理新闻: <strong>${stages.similarity_computation?.total_news || 0}</strong> 条</p>
                                    <p>执行时间: <strong>${stages.similarity_computation?.execution_time ? stages.similarity_computation.execution_time.toFixed(2) + '秒' : '未知'}</strong></p>
                                </div>
                            </div>
                        </div>
                        <div class="accordion-item">
                            <h2 class="accordion-header">
                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#grouping">
                                    事件分组计算
                                </button>
                            </h2>
                            <div id="grouping" class="accordion-collapse collapse" data-bs-parent="#stageAccordion">
                                <div class="accordion-body">
                                    <p>创建分组数量: <strong>${stages.group_computation?.groups_created || 0}</strong> 个</p>
                                    <p>处理新闻: <strong>${stages.group_computation?.total_news || 0}</strong> 条</p>
                                    <p>执行时间: <strong>${stages.group_computation?.execution_time ? stages.group_computation.execution_time.toFixed(2) + '秒' : '未知'}</strong></p>
                                </div>
                            </div>
                        </div>
                        <div class="accordion-item">
                            <h2 class="accordion-header">
                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#cache">
                                    缓存生成
                                </button>
                            </h2>
                            <div id="cache" class="accordion-collapse collapse" data-bs-parent="#stageAccordion">
                                <div class="accordion-body">
                                    <p>生成缓存分组: <strong>${stages.cache_generation || 0}</strong> 个</p>
                                </div>
                            </div>
                        </div>
                        <div class="accordion-item">
                            <h2 class="accordion-header">
                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#cleanup">
                                    清理记录
                                </button>
                            </h2>
                            <div id="cleanup" class="accordion-collapse collapse" data-bs-parent="#stageAccordion">
                                <div class="accordion-body">
                                    <p>清理记录数: <strong>${stages.cleanup || 0}</strong> 条</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }
        
        if (details.error_details) {
            html += `
                <div class="col-md-12 mt-3">
                    <h6 class="text-danger">错误详情</h6>
                    <div class="alert alert-danger">
                        <pre style="white-space: pre-wrap; margin: 0;">${details.error_details}</pre>
                    </div>
                </div>
            `;
        }
        
        html += '</div>';
        return html;
    }
    
    // 渲染新闻源抓取任务详情
    function renderCrawlSourcesDetails(details) {
        return `
            <div class="row">
                <div class="col-md-6">
                    <h6>抓取统计</h6>
                    <table class="table table-sm">
                        <tr><th>总源数:</th><td>${details.total_sources || 0}</td></tr>
                        <tr><th>处理源数:</th><td>${details.processed_sources || 0}</td></tr>
                        <tr><th>成功抓取:</th><td class="text-success">${details.successful_crawls || 0}</td></tr>
                        <tr><th>跳过源数:</th><td class="text-secondary">${details.skipped_sources || 0}</td></tr>
                    </table>
                </div>
                ${details.error_details ? `
                <div class="col-md-6">
                    <h6 class="text-danger">错误详情</h6>
                    <div class="alert alert-danger">
                        <pre style="white-space: pre-wrap; margin: 0;">${details.error_details}</pre>
                    </div>
                </div>
                ` : ''}
            </div>
        `;
    }
    
    // 渲染缓存清理任务详情
    function renderCacheCleanupDetails(details) {
        return `
            <div class="row">
                <div class="col-md-6">
                    <h6>清理统计</h6>
                    <table class="table table-sm">
                        <tr><th>删除记录数:</th><td>${details.deleted_count || 0}</td></tr>
                        <tr><th>截止时间:</th><td>${details.cutoff_time ? formatDateTime(details.cutoff_time) : '未知'}</td></tr>
                    </table>
                </div>
                ${details.error_details ? `
                <div class="col-md-6">
                    <h6 class="text-danger">错误详情</h6>
                    <div class="alert alert-danger">
                        <pre style="white-space: pre-wrap; margin: 0;">${details.error_details}</pre>
                    </div>
                </div>
                ` : ''}
            </div>
        `;
    }
    
    // 渲染通用详情
    function renderGenericDetails(details) {
        return `
            <div class="col-md-12">
                <pre class="bg-light p-3 rounded" style="white-space: pre-wrap;">${JSON.stringify(details, null, 2)}</pre>
            </div>
        `;
    }

    // 更新错误记录表
    function updateErrorsTable() {
        const tbody = document.getElementById('errorsTableBody');
        tbody.innerHTML = '';
        
        schedulerData.errors.forEach(error => {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${formatDateTime(error.timestamp)}</td>
                <td>${getTaskTypeLabel(error.task_type)}</td>
                <td class="text-truncate" style="max-width: 400px;" title="${error.message}">${error.message}</td>
                <td>
                    <button class="btn btn-sm btn-outline-info" onclick="showTaskDetails('${error.timestamp}')">
                        <i class="bi bi-eye"></i> 详情
                    </button>
                </td>
            `;
            tbody.appendChild(row);
        });
    }



    // 手动触发新闻源抓取
    function triggerManualCrawl() {
        const btn = document.getElementById('btnManualCrawl');
        const originalText = btn.innerHTML;
        
        btn.disabled = true;
        btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> 执行中...';
        
        axios.post('/api/sources/scheduler/crawl-now')
            .then(response => {
                showSchedulerSuccess('已手动触发新闻源抓取任务');
                setTimeout(() => loadSchedulerStatus(), 1000); // 1秒后刷新状态
            })
            .catch(error => {
                showSchedulerError('手动触发抓取失败: ' + (error.response?.data?.detail || error.message));
            })
            .finally(() => {
                btn.disabled = false;
                btn.innerHTML = originalText;
            });
    }

    // 手动触发事件分组生成
    function triggerManualEventGroups() {
        const btn = document.getElementById('btnManualEventGroups');
        const originalText = btn.innerHTML;
        const useMultiprocess = document.getElementById('useMultiprocessSimilarity').checked;
        
        btn.disabled = true;
        if (useMultiprocess) {
            btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> 多进程计算中...';
        } else {
            btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> 单进程计算中...';
        }
        
        axios.post('/api/sources/scheduler/event-groups-now', {
            use_multiprocess: useMultiprocess
        })
            .then(response => {
                const method = useMultiprocess ? '多进程' : '单进程';
                showSchedulerSuccess(`已手动触发事件分组生成任务（${method}计算）`);
                setTimeout(() => loadSchedulerStatus(), 1000);
            })
            .catch(error => {
                showSchedulerError('手动触发事件分组生成失败: ' + (error.response?.data?.detail || error.message));
            })
            .finally(() => {
                btn.disabled = false;
                btn.innerHTML = originalText;
            });
    }

    // 显示相似度计算性能说明
    function showSimilarityHelp() {
        const helpContent = `
            <div class="alert alert-info">
                <h6><i class="bi bi-info-circle"></i> 相似度计算性能对比</h6>
                <div class="row">
                    <div class="col-md-6">
                        <h6>单进程模式</h6>
                        <ul class="mb-0">
                            <li>顺序计算，使用1个CPU核心</li>
                            <li>内存占用较低</li>
                            <li>计算时间较长</li>
                            <li>适用于小规模数据</li>
                        </ul>
                    </div>
                    <div class="col-md-6">
                        <h6>多进程模式（推荐）</h6>
                        <ul class="mb-0">
                            <li>并行计算，使用多个CPU核心</li>
                            <li>内存占用稍高</li>
                            <li>计算时间大幅缩短（3-8倍提升）</li>
                            <li>适用于大规模数据</li>
                        </ul>
                    </div>
                </div>
                <hr>
                <small class="text-muted">
                    <strong>建议：</strong>对于超过100条新闻的计算，强烈建议使用多进程模式。
                    系统会自动使用最多8个进程，每个进程处理100个新闻对的批次。
                </small>
            </div>
        `;
        
        // 创建临时模态框显示帮助信息
        const helpModal = document.createElement('div');
        helpModal.className = 'modal fade';
        helpModal.innerHTML = `
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">相似度计算性能说明</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">${helpContent}</div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
                    </div>
                </div>
            </div>
        `;
        document.body.appendChild(helpModal);
        
        const modal = new bootstrap.Modal(helpModal);
        modal.show();
        
        // 模态框关闭后移除DOM元素
        helpModal.addEventListener('hidden.bs.modal', () => {
            document.body.removeChild(helpModal);
        });
    }

    // 更新定时设置
    function updateSchedulerSettings() {
        const crawlInterval = parseFloat(document.getElementById('crawlInterval').value);
        const eventInterval = parseInt(document.getElementById('eventInterval').value);
        
        if (isNaN(crawlInterval) || crawlInterval < 0.25 || crawlInterval > 24) {
            showSchedulerError('新闻源抓取间隔必须在0.25-24小时之间');
            return;
        }
        
        if (isNaN(eventInterval) || eventInterval < 1 || eventInterval > 24) {
            showSchedulerError('事件分组生成间隔必须在1-24小时之间');
            return;
        }
        
        const settings = {
            crawl_sources_interval: crawlInterval,
            event_generation_interval: eventInterval
        };
        
        axios.put('/api/sources/scheduler/settings', settings)
            .then(response => {
                showSchedulerSuccess('定时任务设置已更新');
                loadSchedulerStatus();
            })
            .catch(error => {
                showSchedulerError('更新设置失败: ' + (error.response?.data?.detail || error.message));
            });
    }

    // 过滤历史记录
    function filterHistory() {
        const taskType = document.getElementById('historyTaskFilter').value;
        
        axios.get(`/api/sources/scheduler/history?limit=50${taskType ? '&task_type=' + taskType : ''}`)
            .then(response => {
                schedulerData.history = response.data.history;
                updateHistoryTable();
            })
            .catch(error => {
                console.error('过滤历史记录失败:', error);
                showSchedulerError('过滤历史记录失败');
            });
    }

    // 辅助函数
    function formatDateTime(timestamp) {
        return new Date(timestamp).toLocaleString();
    }

    function getTaskTypeLabel(taskType) {
        const labels = {
            'crawl_sources': '新闻源抓取',
            'event_groups': '事件分组生成',
            'cache_cleanup': '缓存清理',
            'config': '配置更新',
            'scheduler': '调度器控制'
        };
        return labels[taskType] || taskType;
    }

    function getStatusBadge(status) {
        const badges = {
            'success': '<span class="badge bg-success">成功</span>',
            'error': '<span class="badge bg-danger">错误</span>',
            'warning': '<span class="badge bg-warning">警告</span>',
            'running': '<span class="badge bg-info">运行中</span>'
        };
        return badges[status] || `<span class="badge bg-secondary">${status}</span>`;
    }

    function showSchedulerSuccess(message) {
        // 简单的成功提示，实际项目中可以使用toast组件
        const alertDiv = document.createElement('div');
        alertDiv.className = 'alert alert-success alert-dismissible fade show position-fixed';
        alertDiv.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
        alertDiv.innerHTML = `
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        document.body.appendChild(alertDiv);
        setTimeout(() => alertDiv.remove(), 5000);
    }

    function showSchedulerError(message) {
        const alertDiv = document.createElement('div');
        alertDiv.className = 'alert alert-danger alert-dismissible fade show position-fixed';
        alertDiv.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
        alertDiv.innerHTML = `
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        document.body.appendChild(alertDiv);
        setTimeout(() => alertDiv.remove(), 8000);
    }
</script>

<!-- 任务详情模态框 -->
<div class="modal fade" id="taskDetailsModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="taskDetailsModalTitle">任务详情</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div id="taskDetailsBody">
                    <!-- 任务详情内容将动态加载 -->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
            </div>
        </div>
    </div>
</div>

{% endblock %}