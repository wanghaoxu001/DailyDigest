{% extends "base.html" %} {% block title %}ä»Šæ—¥æ–°é—» - æ¯æ—¥å®‰å…¨å¿«æŠ¥ç³»ç»Ÿ{% endblock %} {% block extra_css %}
<style>
    /* ç°ä»£åŒ–æ ¹å˜é‡å®šä¹‰ */
    :root {
        --primary-color: #2563eb;
        --primary-hover: #1d4ed8;
        --secondary-color: #64748b;
        --success-color: #059669;
        --warning-color: #d97706;
        --danger-color: #dc2626;
        --info-color: #0891b2;
        --dark-color: #1e293b;
        --light-color: #f8fafc;
        
        --gradient-primary: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        --gradient-success: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
        --gradient-warning: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        --gradient-info: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        
        --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
        --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
        --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
        --shadow-xl: 0 20px 25px -5px rgb(0 0 0 / 0.1), 0 8px 10px -6px rgb(0 0 0 / 0.1);
        
        --radius-sm: 0.375rem;
        --radius-md: 0.5rem;
        --radius-lg: 0.75rem;
        --radius-xl: 1rem;
    }
    
    /* ç°ä»£åŒ–é¡µé¢èƒŒæ™¯ */
    body {
        background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
        min-height: 100vh;
        font-family: 'Inter', 'SF Pro Display', -apple-system, BlinkMacSystemFont, sans-serif;
    }
    
    /* ç°ä»£åŒ–æ–°é—»å¡ç‰‡ */
    .news-card {
        margin-bottom: 1.5rem;
        transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        border: none;
        border-radius: var(--radius-xl);
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(10px);
        box-shadow: var(--shadow-md);
        overflow: hidden;
        position: relative;
    }
    
    .news-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 4px;
        background: var(--gradient-primary);
        opacity: 0;
        transition: opacity 0.3s ease;
    }
    
    /* ç§»é™¤æ‚¬åœæ•ˆæœ */
    .news-card:hover {
        /* å–æ¶ˆæ‚¬åœæ—¶çš„å˜æ¢å’Œé˜´å½±æ•ˆæœ */
    }
    
    .news-card:hover::before {
        /* å–æ¶ˆæ‚¬åœæ—¶çš„è“è‰²æ¡æ˜¾ç¤º */
    }
    
    .news-card.selected {
        border: 2px solid var(--primary-color);
        box-shadow: 0 0 0 4px rgba(37, 99, 235, 0.1), var(--shadow-xl);
        transform: translateY(-4px);
    }
    
    .news-card.selected::before {
        opacity: 1;
        background: var(--gradient-success);
    }
    
    .category-badge {
        position: absolute;
        top: 1rem;
        right: 1rem;
        z-index: 10;
    }
    
    .card-footer {
        display: flex;
        justify-content: space-between;
        align-items: center;
        background: rgba(248, 250, 252, 0.8);
        backdrop-filter: blur(10px);
        border-top: 1px solid rgba(226, 232, 240, 0.5);
    }
    /* Markdownæ ·å¼ */
    
    .markdown-body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, Arial, sans-serif;
        line-height: 1.6;
    }
    
    .markdown-body h1,
    .markdown-body h2,
    .markdown-body h3,
    .markdown-body h4,
    .markdown-body h5,
    .markdown-body h6 {
        margin-top: 16px;
        margin-bottom: 16px;
        font-weight: 600;
        line-height: 1.25;
    }
    
    .markdown-body h1 {
        font-size: 2em;
    }
    
    .markdown-body h2 {
        font-size: 1.5em;
    }
    
    .markdown-body h3 {
        font-size: 1.25em;
    }
    
    .markdown-body h4 {
        font-size: 1em;
    }
    
    .markdown-body strong {
        font-weight: 600;
    }
    
    .markdown-body ul,
    .markdown-body ol {
        padding-left: 2em;
        margin-bottom: 16px;
    }
    
    .markdown-body li {
        margin: 0.25em 0;
    }
    
    .markdown-body p {
        margin-top: 0;
        margin-bottom: 16px;
    }
    
    .markdown-body code {
        padding: 0.2em 0.4em;
        margin: 0;
        background-color: rgba(27, 31, 35, 0.05);
        border-radius: 3px;
    }
    
    .markdown-body pre {
        padding: 16px;
        overflow: auto;
        line-height: 1.45;
        background-color: #f6f8fa;
        border-radius: 3px;
    }
    /* ç°ä»£åŒ–ç­›é€‰å™¨æ ·å¼ */
    .filter-card {
        background: rgba(255, 255, 255, 0.9);
        backdrop-filter: blur(15px);
        border: 1px solid rgba(255, 255, 255, 0.3);
        border-radius: var(--radius-xl);
        box-shadow: var(--shadow-lg);
        overflow: hidden;
    }
    
    .filter-card .card-body {
        padding: 2rem;
    }
    
    .form-label {
        font-weight: 600;
        margin-bottom: 0.75rem;
        color: #374151;
        font-size: 0.875rem;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }
    
    .form-label.fw-bold {
        font-weight: 700;
        color: #1f2937;
        font-size: 1rem;
    }
    
    .badge {
        cursor: pointer;
        transition: all 0.2s ease;
        border-radius: var(--radius-md);
        padding: 0.5rem 1rem;
        font-weight: 500;
        letter-spacing: 0.015em;
    }
    
    .badge:hover {
        opacity: 0.9;
        box-shadow: var(--shadow-sm);
    }
    
    .form-select, .form-control {
        border: 2px solid rgba(226, 232, 240, 0.6);
        border-radius: var(--radius-lg);
        padding: 0.75rem 1rem;
        font-size: 0.875rem;
        transition: all 0.3s ease;
        background: rgba(255, 255, 255, 0.8);
        backdrop-filter: blur(10px);
    }
    
    .form-select:focus, .form-control:focus {
        border-color: var(--primary-color);
        box-shadow: 0 0 0 4px rgba(37, 99, 235, 0.1);
        background: rgba(255, 255, 255, 0.95);
        transform: translateY(-1px);
    }
    
    .form-check-input {
        border-radius: var(--radius-sm);
        border: 2px solid rgba(226, 232, 240, 0.8);
        transition: all 0.3s ease;
    }
    
    .form-check-input:checked {
        background-color: var(--primary-color);
        border-color: var(--primary-color);
        box-shadow: 0 0 0 4px rgba(37, 99, 235, 0.1);
    }
    
    .form-switch .form-check-input {
        border-radius: 2rem;
    }
    
    /* ä¸“ä¸šåŒ–æŒ‰é’®æ ·å¼ */
    .btn {
        border-radius: var(--radius-md);
        font-weight: 600;
        letter-spacing: 0.015em;
        transition: all 0.2s ease;
        border: none;
        padding: 0.75rem 1.5rem;
    }
    
    .btn-primary {
        background-color: var(--primary-color);
        color: white;
        box-shadow: var(--shadow-sm);
    }
    
    .btn-primary:hover {
        background-color: var(--primary-hover);
        box-shadow: var(--shadow-md);
    }
    
    .btn-success {
        background-color: var(--success-color);
        color: white;
        box-shadow: var(--shadow-sm);
    }
    
    .btn-success:hover {
        background-color: #047857;
        box-shadow: var(--shadow-md);
    }
    
    .btn-outline-primary {
        border: 2px solid var(--primary-color);
        color: var(--primary-color);
        background: transparent;
    }
    
    .btn-outline-primary:hover {
        background-color: var(--primary-color);
        color: white;
        box-shadow: var(--shadow-sm);
    }
    
    .btn-outline-secondary {
        border: 2px solid var(--secondary-color);
        color: var(--secondary-color);
        background: transparent;
    }
    
    .btn-outline-secondary:hover {
        background-color: var(--secondary-color);
        color: white;
        box-shadow: var(--shadow-sm);
    }
    
    /* ç°ä»£åŒ–æ»šåŠ¨è¿›åº¦æŒ‡ç¤ºå™¨ */
    .progress-indicator {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        z-index: 1030;
        background: rgba(255, 255, 255, 0.9);
        backdrop-filter: blur(20px);
        border-bottom: 1px solid rgba(226, 232, 240, 0.5);
        padding: 1rem 2rem;
        display: flex;
        align-items: center;
        justify-content: space-between;
        transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        transform: translateY(-100%);
        box-shadow: var(--shadow-lg);
    }
    
    .progress-indicator.visible {
        transform: translateY(0);
    }
    
    .progress-bar-container {
        flex: 1;
        height: 8px;
        background: rgba(209, 213, 219, 0.8);
        border-radius: var(--radius-lg);
        margin: 0 1.5rem;
        overflow: hidden;
        position: relative;
    }
    
    .progress-bar {
        height: 100%;
        background: linear-gradient(90deg, #ffffff 0%, #f0fdf4 30%, #bbf7d0 70%, #86efac 100%);
        border-radius: var(--radius-lg);
        transition: width 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        width: 0%;
        position: relative;
        /* æ·»åŠ å¾®å¦™çš„é˜´å½±å¢å¼ºç«‹ä½“æ„Ÿ */
        box-shadow: inset 0 1px 2px rgba(0, 0, 0, 0.1);
    }
    
    /* ç§»é™¤é—ªçƒåŠ¨ç”»æ•ˆæœ */
    
    .progress-text {
        font-weight: 700;
        color: #1f2937;
        min-width: 140px;
        text-align: center;
        font-size: 0.875rem;
        background: rgba(134, 239, 172, 0.15);
        padding: 0.5rem 1rem;
        border-radius: var(--radius-lg);
        border: 1px solid rgba(134, 239, 172, 0.3);
    }
    
    .scroll-hint {
        font-size: 0.8rem;
        color: var(--secondary-color);
        font-weight: 500;
        min-width: 180px;
        text-align: right;
        opacity: 0.8;
        transition: opacity 0.3s ease;
    }
    
    /* ç°ä»£åŒ–å¡ç‰‡å†…å®¹æ ·å¼ */
    .news-card .card-body {
        padding: 2rem;
        position: relative;
    }
    
    .news-card .card-title {
        font-size: 1.25rem;
        font-weight: 700;
        line-height: 1.5;
        margin-bottom: 1.25rem;
        color: #1f2937;
        word-wrap: break-word;
        hyphens: auto;
        /* æ”¹å–„æ ‡é¢˜å¯è¯»æ€§ */
        letter-spacing: -0.025em;
        font-family: 'Inter', 'PingFang SC', 'Microsoft YaHei', sans-serif;
    }
    
    .card-text {
        color: #1f2937;
        line-height: 1.7;
        font-size: 1rem;
        margin-bottom: 0;
        /* æ”¹å–„æ€»ç»“å¯è¯»æ€§ */
        letter-spacing: 0.01em;
        word-spacing: 0.1em;
        font-family: 'Inter', 'PingFang SC', 'Microsoft YaHei', sans-serif;
        /* æ›´å¥½çš„æ–‡æœ¬æ¸²æŸ“ */
        text-rendering: optimizeLegibility;
        -webkit-font-smoothing: antialiased;
        -moz-osx-font-smoothing: grayscale;
    }
    
    /* æ€»ç»“æ–‡æœ¬çš„ä¼˜åŒ–æ ·å¼ */
    .card-text.summary-text {
        font-size: 1.05rem;
        line-height: 1.75;
        color: #111827;
        margin-top: 0.5rem;
        text-align: justify;
        text-justify: inter-ideograph;
    }
    
    /* æ·»åŠ é˜…è¯»æŒ‡ç¤ºå™¨ */
    .reading-indicator {
        position: absolute;
        left: 0;
        top: 0;
        bottom: 0;
        width: 4px;
        background: linear-gradient(180deg, transparent 0%, var(--primary-color) 20%, var(--primary-color) 80%, transparent 100%);
        opacity: 0;
        transition: opacity 0.3s ease;
        border-radius: 0 2px 2px 0;
    }
    
    .news-card:hover .reading-indicator {
        /* å–æ¶ˆæ‚¬åœæ—¶çš„é˜…è¯»æŒ‡ç¤ºå™¨æ˜¾ç¤º */
    }
    
    .news-card.selected .reading-indicator {
        opacity: 1;
        background: linear-gradient(180deg, transparent 0%, var(--success-color) 20%, var(--success-color) 80%, transparent 100%);
    }
    
    /* ç°ä»£åŒ–äº‹ä»¶ç»„æ ·å¼ */
    .event-group {
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(15px);
        border-radius: var(--radius-xl);
        box-shadow: var(--shadow-lg);
        margin-bottom: 2rem;
        overflow: hidden;
        transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        border: 1px solid rgba(255, 255, 255, 0.3);
    }
    
    .event-group:hover {
        /* å–æ¶ˆäº‹ä»¶åˆ†ç»„çš„æ‚¬åœæ•ˆæœ */
    }
    
    .event-header {
        background: rgba(37, 99, 235, 0.05);
        padding: 1.5rem 2rem;
        border-bottom: 1px solid rgba(226, 232, 240, 0.5);
        cursor: pointer;
        transition: all 0.3s ease;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    
    .event-header:hover {
        /* å–æ¶ˆäº‹ä»¶å¤´éƒ¨çš„æ‚¬åœèƒŒæ™¯å˜åŒ– */
    }
    
    .event-label {
        font-size: 1.125rem;
        font-weight: 700;
        color: #1f2937;
        margin-bottom: 0.5rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }
    
    .event-entities {
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem;
        margin-top: 0.5rem;
    }
    
    .entity-tag {
        background-color: var(--info-color);
        color: white;
        padding: 0.25rem 0.75rem;
        border-radius: var(--radius-md);
        font-size: 0.8rem;
        font-weight: 500;
        box-shadow: var(--shadow-sm);
    }
    
    .event-meta {
        display: flex;
        align-items: center;
        gap: 1rem;
        color: var(--secondary-color);
        font-size: 0.875rem;
        font-weight: 500;
    }
    
    .event-meta span {
        display: flex;
        align-items: center;
        gap: 0.25rem;
    }
    
    .toggle-icon {
        transition: transform 0.3s ease;
        font-size: 1.2rem;
        color: var(--primary-color);
    }
    
    .toggle-icon.rotated {
        transform: rotate(180deg);
    }
    
    .event-content {
        padding: 2rem;
        transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        max-height: 2000px;
        overflow: hidden;
    }
    
    .event-content.collapsed {
        max-height: 0;
        padding: 0 2rem;
    }
    
    .primary-news {
        background: rgba(34, 197, 94, 0.05);
        border-left: 4px solid var(--success-color);
        padding: 1.75rem;
        border-radius: var(--radius-lg);
        margin-bottom: 1.5rem;
        position: relative;
    }
    
    .primary-news h5 {
        font-size: 1.2rem;
        font-weight: 700;
        line-height: 1.5;
        margin-bottom: 1rem;
        color: #1f2937;
        letter-spacing: -0.025em;
        font-family: 'Inter', 'PingFang SC', 'Microsoft YaHei', sans-serif;
    }
    
    .primary-news p {
        font-size: 1rem;
        line-height: 1.75;
        color: #111827;
        margin-bottom: 1rem;
        font-family: 'Inter', 'PingFang SC', 'Microsoft YaHei', sans-serif;
        text-rendering: optimizeLegibility;
    }
    
    .related-news {
        margin-top: 1.5rem;
    }
    
    .related-news-item {
        background: rgba(248, 250, 252, 0.8);
        border-radius: var(--radius-lg);
        padding: 1.25rem;
        margin-bottom: 1rem;
        border: 1px solid rgba(226, 232, 240, 0.5);
        transition: all 0.3s ease;
    }
    
    .related-news-item:hover {
        /* å–æ¶ˆç›¸å…³æ–°é—»é¡¹çš„æ‚¬åœæ•ˆæœ */
    }
    
    /* ä¸“ä¸šåŒ–åº•éƒ¨æ“ä½œæ  */
    #bottomActionBar .card {
        background: var(--primary-color);
        border: none;
        box-shadow: var(--shadow-lg);
        color: white;
    }
    
    #bottomActionBar .card-body {
        padding: 2.5rem 2rem;
    }
    
    #bottomActionBar h5 {
        color: white;
        font-weight: 700;
        margin-bottom: 0.5rem;
    }
    
    #bottomActionBar .text-muted {
        color: rgba(255, 255, 255, 0.9) !important;
        font-size: 1rem;
    }
    
    #bottomActionBar .btn-primary {
        background-color: white;
        color: var(--primary-color);
        border: none;
        font-weight: 700;
        padding: 1rem 2rem;
        font-size: 1.1rem;
        box-shadow: var(--shadow-md);
    }
    
    #bottomActionBar .btn-primary:hover {
        background-color: #f8fafc;
        box-shadow: var(--shadow-lg);
    }
    
    #bottomActionBar .btn-outline-secondary {
        border: 2px solid rgba(255, 255, 255, 0.8);
        color: white;
        background: transparent;
        font-weight: 600;
    }
    
    #bottomActionBar .btn-outline-secondary:hover {
        background-color: rgba(255, 255, 255, 0.1);
        border-color: white;
    }
    
    /* ç°ä»£åŒ–åŠ è½½åŠ¨ç”» */
    .spinner-border {
        width: 3rem;
        height: 3rem;
        border-width: 0.3em;
        animation: spinner-border 0.8s linear infinite;
    }
    
    .loading-container {
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(15px);
        border-radius: var(--radius-xl);
        padding: 4rem 2rem;
        box-shadow: var(--shadow-lg);
        margin: 2rem 0;
    }
    
    /* ä¸“ä¸šåŒ–åˆ†ç±»å¾½ç« æ ·å¼ */
    .bg-info {
        background-color: var(--info-color) !important;
    }
    
    .bg-danger {
        background-color: var(--danger-color) !important;
    }
    
    .bg-warning {
        background-color: var(--warning-color) !important;
    }
    
    .bg-primary {
        background-color: var(--primary-color) !important;
    }
    
    .bg-secondary {
        background-color: var(--secondary-color) !important;
    }
    
    .bg-success {
        background-color: var(--success-color) !important;
    }
    
    /* ç°ä»£åŒ–è­¦å‘Šæ¡†æ ·å¼ */
    .alert {
        border: none;
        border-radius: var(--radius-lg);
        backdrop-filter: blur(10px);
        box-shadow: var(--shadow-md);
        border-left: 4px solid;
    }
    
    .alert-warning {
        background: rgba(251, 191, 36, 0.1);
        color: var(--warning-color);
        border-left-color: var(--warning-color);
    }
    
    .alert-info {
        background: rgba(14, 165, 233, 0.1);
        color: var(--info-color);
        border-left-color: var(--info-color);
    }
    
    /* ç°ä»£åŒ–æ¨¡æ€æ¡†æ ·å¼ */
    .modal-content {
        border: none;
        border-radius: var(--radius-xl);
        box-shadow: var(--shadow-xl);
        backdrop-filter: blur(20px);
        background: rgba(255, 255, 255, 0.95);
    }
    
    .modal-header {
        background: rgba(37, 99, 235, 0.05);
        border-bottom: 1px solid rgba(226, 232, 240, 0.5);
        padding: 1.5rem 2rem;
        border-top-left-radius: var(--radius-xl);
        border-top-right-radius: var(--radius-xl);
    }
    
    .modal-title {
        color: #1f2937;
        font-weight: 700;
    }
    
    .modal-body {
        padding: 2rem;
    }
    
    .modal-footer {
        background: rgba(248, 250, 252, 0.8);
        border-top: 1px solid rgba(226, 232, 240, 0.5);
        padding: 1.5rem 2rem;
        border-bottom-left-radius: var(--radius-xl);
        border-bottom-right-radius: var(--radius-xl);
    }
    
    /* å“åº”å¼è®¾è®¡ä¼˜åŒ– */
    @media (max-width: 768px) {
        .news-card .card-body {
            padding: 1.5rem;
        }
        
        .news-card .card-title {
            font-size: 1.15rem;
            line-height: 1.6;
            margin-bottom: 1rem;
        }
        
        .card-text.summary-text {
            font-size: 1rem;
            line-height: 1.65;
        }
        
        .filter-card .card-body {
            padding: 1.5rem;
        }
        
        .event-header {
            padding: 1rem 1.5rem;
            flex-direction: column;
            align-items: flex-start;
            gap: 1rem;
        }
        
        .event-content {
            padding: 1.5rem;
        }
        
        .primary-news {
            padding: 1.5rem;
        }
        
        .primary-news h5 {
            font-size: 1.1rem;
            line-height: 1.6;
        }
        
        .progress-indicator {
            padding: 0.75rem 1rem;
        }
        
        .progress-text {
            min-width: 100px;
            font-size: 0.8rem;
        }
        
        .scroll-hint {
            min-width: 120px;
            font-size: 0.75rem;
        }
        
        #bottomActionBar .card-body {
            padding: 2rem 1.5rem;
        }
        
        #bottomActionBar .d-flex {
            flex-direction: column;
            gap: 1rem;
            text-align: center;
        }
        
        .btn-lg {
            width: 100%;
            margin-bottom: 1rem;
        }
    }
    
    /* æš—é»‘æ¨¡å¼æ”¯æŒï¼ˆæœªæ¥æ‰©å±•ï¼‰ */
    @media (prefers-color-scheme: dark) {
        :root {
            --dark-color: #f8fafc;
            --light-color: #1e293b;
            --secondary-color: #94a3b8;
        }
    }
    
    /* åŠ¨ç”»æ•ˆæœä¼˜åŒ– */
    @keyframes fadeInUp {
        from {
            opacity: 0;
            transform: translateY(30px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
    
    .news-card {
        animation: fadeInUp 0.6s ease-out;
    }
    
    .event-group {
        animation: fadeInUp 0.6s ease-out;
    }
    
    /* æ€§èƒ½ä¼˜åŒ– */
    * {
        box-sizing: border-box;
    }
    
    .news-card,
    .event-group,
    .btn,
    .form-select,
    .form-control {
        will-change: transform;
    }
    
    .news-card .card-text {
        color: #1f2937;
        line-height: 1.5;
    }
    
    .news-card .card-footer {
        background-color: #f8f9fa;
        border-top: 1px solid #dee2e6;
        padding: 0.75rem 1.5rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    
    /* ç»™é¡µé¢é¡¶éƒ¨ç•™å‡ºç©ºé—´é¿å…è¢«è¿›åº¦æ¡é®æŒ¡ */
    body {
        padding-top: 0;
        transition: padding-top 0.3s ease;
    }
    
    body.progress-visible {
        padding-top: 60px;
    }
    
    .form-check {
        margin-bottom: 8px;
    }
    
    .form-check-label {
        cursor: pointer;
        transition: all 0.2s ease;
    }
    
    .form-check-label:hover .badge {
        transform: scale(1.05);
    }
    
    .form-check-input:checked+.form-check-label .badge {
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
    }
    
    .category-controls {
        border-top: 1px solid #dee2e6;
        padding-top: 10px;
        margin-top: 10px;
    }
    /* äº‹ä»¶åˆ†ç»„æ ·å¼ */
    
    .event-group {
        margin-bottom: 30px;
        border: 1px solid #e9ecef;
        border-radius: 10px;
        overflow: hidden;
        transition: all 0.3s ease;
    }
    
    .event-group:hover {
        /* å–æ¶ˆäº‹ä»¶åˆ†ç»„çš„æ‚¬åœé˜´å½±æ•ˆæœ */
    }
    
    .event-header {
        background-color: #f8f9fa;
        padding: 15px 20px;
        cursor: pointer;
        user-select: none;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    
    .event-header:hover {
        /* å–æ¶ˆäº‹ä»¶å¤´éƒ¨çš„æ‚¬åœèƒŒæ™¯å˜åŒ– */
    }
    
    .event-label {
        font-size: 1.1rem;
        font-weight: 600;
        color: #333;
    }
    
    .event-meta {
        display: flex;
        gap: 15px;
        align-items: center;
        font-size: 0.9rem;
        color: #6c757d;
    }
    
    .event-entities {
        margin-top: 10px;
        display: flex;
        flex-wrap: wrap;
        gap: 5px;
    }
    
    .entity-tag {
        background-color: #e7f1ff;
        color: #0066cc;
        padding: 2px 8px;
        border-radius: 12px;
        font-size: 0.85rem;
    }
    
    .event-content {
        padding: 20px;
        background-color: #fff;
    }
    
    .event-content.collapsed {
        display: none;
    }
    
    .primary-news {
        border-left: 4px solid #0d6efd;
        padding-left: 15px;
        margin-bottom: 20px;
    }
    
    .related-news {
        margin-top: 15px;
        padding-top: 15px;
        border-top: 1px solid #e9ecef;
    }
    
    .related-news-item {
        margin-bottom: 10px;
        padding: 10px;
        background-color: #f8f9fa;
        border-radius: 5px;
        position: relative;
    }
    
    .similarity-badge {
        position: absolute;
        top: 10px;
        right: 10px;
        background-color: #28a745;
        color: white;
        padding: 2px 8px;
        border-radius: 12px;
        font-size: 0.75rem;
    }
    
    .toggle-icon {
        transition: transform 0.3s ease;
    }
    
    .toggle-icon.rotated {
        transform: rotate(180deg);
    }
    /* ç‹¬ç«‹æ–°é—»æ ·å¼ */
    
    .standalone-news {
        margin-bottom: 30px;
    }
    
    .standalone-news .news-card {
        height: 100%;
        display: flex;
        flex-direction: column;
    }
    
    .standalone-news .card-body {
        flex: 1;
    }
    /* åˆ·æ–°æŒ‰é’®åŠ¨ç”» */
    
    @keyframes spin {
        from {
            transform: rotate(0deg);
        }
        to {
            transform: rotate(360deg);
        }
    }
    /* å†å²ç›¸ä¼¼æ–‡ç« æ ·å¼ */
    
    .news-card.opacity-75 {
        opacity: 0.75;
    }
    
    .news-card.border-muted {
        border-color: #6c757d !important;
    }
    
    .news-card.border-muted .card-body {
        background-color: #f8f9fa;
    }
</style>
{% endblock %} {% block content %}
<!-- æ»šåŠ¨è¿›åº¦æŒ‡ç¤ºå™¨ -->
<div class="progress-indicator" id="progressIndicator">
    <div class="progress-bar-container">
        <div class="progress-bar" id="progressBar"></div>
    </div>
    <div class="progress-text" id="progressText">
        <span class="current-article">0</span> / <span class="total-articles">0</span> ç¯‡æ–‡ç« 
    </div>
    <div class="scroll-hint" id="scrollHint">å‘ä¸‹æ»šåŠ¨æŸ¥çœ‹æ›´å¤šæ–‡ç« </div>
</div>

<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <h2>ä»Šæ—¥æ–°é—»</h2>
        <p class="text-muted mb-0" id="newsStatsInfo">æ­£åœ¨åŠ è½½æ–°é—»ç»Ÿè®¡ä¿¡æ¯...</p>
    </div>
    <div>
        <button class="btn btn-outline-info btn-sm me-2" data-bs-toggle="tooltip" data-bs-placement="bottom" title="å¼€å¯äº‹ä»¶åˆ†ç»„åï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨å°†æè¿°åŒä¸€äº‹ä»¶çš„æ–°é—»å½’ç±»åœ¨ä¸€èµ·ï¼Œå¸®åŠ©æ‚¨å¿«é€Ÿè¯†åˆ«é‡å¤å†…å®¹ï¼ŒèŠ‚çœé˜…è¯»æ—¶é—´">
                <i class="bi bi-info-circle"></i> åŠŸèƒ½è¯´æ˜
            </button>
        <button class="btn btn-primary" id="btnGenerateDigest" disabled>
                ç”Ÿæˆå¿«æŠ¥ (<span id="selectedCount">0</span>)
            </button>
    </div>
</div>

<div class="row mb-4">
    <div class="col-md-12">
        <div class="card filter-card">
            <div class="card-body">
                <!-- ç¬¬ä¸€è¡Œï¼šåˆ†ç±»ç­›é€‰ -->
                <div class="row mb-3">
                    <div class="col-12">
                        <label class="form-label fw-bold">ğŸ“Š åˆ†ç±»ç­›é€‰</label>
                        <div class="d-flex flex-wrap gap-2 mb-2">
                            <div class="form-check">
                                <input class="form-check-input category-checkbox" type="checkbox" value="é‡‘èä¸šç½‘ç»œå®‰å…¨äº‹ä»¶" id="cat-financial" checked>
                                <label class="form-check-label" for="cat-financial">
                                    <span class="badge bg-info">é‡‘èä¸š</span>
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input category-checkbox" type="checkbox" value="é‡å¤§ç½‘ç»œå®‰å…¨äº‹ä»¶" id="cat-major" checked>
                                <label class="form-check-label" for="cat-major">
                                    <span class="badge bg-danger">é‡å¤§äº‹ä»¶</span>
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input category-checkbox" type="checkbox" value="é‡å¤§æ•°æ®æ³„éœ²äº‹ä»¶" id="cat-leak" checked>
                                <label class="form-check-label" for="cat-leak">
                                    <span class="badge bg-warning">æ•°æ®æ³„éœ²</span>
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input category-checkbox" type="checkbox" value="é‡å¤§æ¼æ´é£é™©æç¤º" id="cat-vuln" checked>
                                <label class="form-check-label" for="cat-vuln">
                                    <span class="badge bg-primary">æ¼æ´é£é™©</span>
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input category-checkbox" type="checkbox" value="å…¶ä»–" id="cat-other" checked>
                                <label class="form-check-label" for="cat-other">
                                    <span class="badge bg-secondary">å…¶ä»–</span>
                                </label>
                            </div>
                        </div>
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <button type="button" class="btn btn-sm btn-outline-primary" id="btnSelectAllCategories">å…¨é€‰</button>
                                <button type="button" class="btn btn-sm btn-outline-secondary" id="btnDeselectAllCategories">å…¨ä¸é€‰</button>
                            </div>
                            <small class="text-muted">
                                å·²é€‰æ‹© <span id="selectedCategoriesCount">5</span>/5 ä¸ªåˆ†ç±»
                            </small>
                        </div>
                    </div>
                </div>

                <hr class="my-3">

                <!-- ç¬¬äºŒè¡Œï¼šå…¶ä»–ç­›é€‰é€‰é¡¹ -->
                <div class="row">
                    <div class="col-md-3">
                        <label for="timeRange" class="form-label">â° æ—¶é—´èŒƒå›´</label>
                        <select class="form-select" id="timeRange">
                            <option value="24">æœ€è¿‘24å°æ—¶</option>
                            <option value="48">æœ€è¿‘48å°æ—¶</option>
                            <option value="72">æœ€è¿‘72å°æ—¶</option>
                            <option value="168">æœ€è¿‘ä¸€å‘¨</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label for="sourceFilter" class="form-label">ğŸ“° æŒ‡å®šæ¥æº</label>
                        <select class="form-select" id="sourceFilter">
                            <option value="">æ‰€æœ‰æ¥æº</option>
                            <!-- æ¥æºé€‰é¡¹å°†åŠ¨æ€åŠ è½½ -->
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label for="excludeSourceSelect" class="form-label">ğŸš« æ’é™¤æ¥æº</label>
                        <select class="form-select" id="excludeSourceSelect">
                            <option value="">é€‰æ‹©è¦æ’é™¤çš„æ¥æº</option>
                            <!-- æ’é™¤æ¥æºé€‰é¡¹å°†åŠ¨æ€åŠ è½½ -->
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">ğŸ›ï¸ æ˜¾ç¤ºé€‰é¡¹</label>
                        <div class="d-flex flex-column gap-1">
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="excludeUsed" checked>
                                <label class="form-check-label" for="excludeUsed">æ’é™¤å·²ç”¨äºå¿«æŠ¥</label>
                            </div>
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="groupByEvent">
                                <label class="form-check-label" for="groupByEvent">æŒ‰äº‹ä»¶åˆ†ç»„</label>
                            </div>
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="separateHistory">
                                <label class="form-check-label" for="separateHistory">åˆ†ç¦»å†å²ç›¸ä¼¼</label>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- å·²æ’é™¤æ¥æºæ˜¾ç¤ºåŒºåŸŸ -->
                <div class="row mt-3" id="excludedSourcesRow" style="display: none;">
                    <div class="col-12">
                        <div class="alert alert-warning py-2">
                            <div class="d-flex align-items-center justify-content-between">
                                <div>
                                    <i class="bi bi-funnel"></i>
                                    <strong>å·²æ’é™¤æ¥æºï¼š</strong>
                                    <span id="excludedSourcesList"></span>
                                </div>
                                <button type="button" class="btn btn-sm btn-outline-danger" id="btnClearExcludedSources">
                                    <i class="bi bi-x-circle"></i> æ¸…ç©º
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row" id="newsContainer">
    <!-- æ–°é—»å¡ç‰‡å°†é€šè¿‡JavaScriptåŠ¨æ€åŠ è½½ -->
    <div class="col-12">
        <div class="loading-container text-center">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <div class="mt-3">
                <h5 class="text-muted">æ­£åœ¨åŠ è½½æ–°é—»...</h5>
                <p class="text-secondary">è¯·ç¨å€™ï¼Œæ­£åœ¨ä¸ºæ‚¨è·å–æœ€æ–°èµ„è®¯</p>
            </div>
        </div>
    </div>
</div>

<!-- åº•éƒ¨ç”Ÿæˆå¿«æŠ¥æŒ‰é’® -->
<div class="row mt-5 mb-4" id="bottomActionBar" style="display: none;">
    <div class="col-12">
        <div class="card">
            <div class="card-body text-center py-4">
                <div class="d-flex justify-content-center align-items-center gap-3">
                    <i class="bi bi-check-circle-fill text-success" style="font-size: 1.5rem;"></i>
                    <div>
                        <h5 class="mb-1">ğŸ“– æ‚¨å·²é˜…è¯»å®Œæ‰€æœ‰æ–‡ç« </h5>
                        <p class="text-muted mb-0">æ‚¨å¯ä»¥é€‰æ‹©æ„Ÿå…´è¶£çš„æ–°é—»æ¥ç”Ÿæˆä»Šæ—¥å¿«æŠ¥</p>
                    </div>
                </div>
                <div class="mt-3">
                    <button class="btn btn-primary btn-lg" id="btnGenerateDigestBottom" disabled>
                        <i class="bi bi-file-earmark-text"></i>
                        ç”Ÿæˆå¿«æŠ¥ (<span id="selectedCountBottom">0</span>)
                    </button>
                    <button class="btn btn-outline-secondary btn-lg ms-2" onclick="window.scrollTo({top: 0, behavior: 'smooth'})">
                        <i class="bi bi-arrow-up"></i>
                        è¿”å›é¡¶éƒ¨
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- æ–°é—»è¯¦æƒ…æ¨¡æ€æ¡† -->
<div class="modal fade" id="newsDetailModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="newsDetailTitle">æ–°é—»è¯¦æƒ…</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="newsDetailContent">
                <!-- æ–°é—»è¯¦æƒ…å°†åŠ¨æ€åŠ è½½ -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å…³é—­</button>
                <button type="button" class="btn btn-warning" id="btnProcessInModal">é‡æ–°å¤„ç†</button>
                <button type="button" class="btn btn-primary" id="btnSelectInModal">é€‰æ‹©æ­¤æ–°é—»</button>
            </div>
        </div>
    </div>
</div>

<!-- ç”Ÿæˆå¿«æŠ¥æ¨¡æ€æ¡† -->
<div class="modal fade" id="generateDigestModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">ç”Ÿæˆå¿«æŠ¥</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="digestForm">
                    <div class="mb-3">
                        <label for="digestTitle" class="form-label">å¿«æŠ¥æ ‡é¢˜</label>
                        <input type="text" class="form-control" id="digestTitle" value="æ¯æ—¥ç½‘å®‰æƒ…æŠ¥é€Ÿé€’" required>
                    </div>
                    <div class="mb-3">
                        <label for="digestDate" class="form-label">æ—¥æœŸ</label>
                        <input type="date" class="form-control" id="digestDate" required>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
                <button type="button" class="btn btn-primary" id="btnConfirmGenerate">ç”Ÿæˆ</button>
            </div>
        </div>
    </div>
</div>
{% endblock %} {% block extra_js %}
<!-- æ·»åŠ Marked.jsåº“ç”¨äºMarkdownæ¸²æŸ“ -->
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<!-- æ·»åŠ DOMPurifyåº“ç”¨äºHTMLå‡€åŒ–ï¼Œé˜²æ­¢XSSæ”»å‡» -->
<script src="https://cdn.jsdelivr.net/npm/dompurify@2.3.10/dist/purify.min.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // è®¾ç½®ä»Šå¤©çš„æ—¥æœŸ
        const today = new Date();
        document.getElementById('digestDate').valueAsDate = today;

        // é…ç½®marked.js
        marked.setOptions({
            breaks: true, // è½¬æ¢æ¢è¡Œç¬¦ä¸º<br>
            gfm: true // å¯ç”¨GitHubé£æ ¼çš„Markdown
        });

        // åˆå§‹åŒ–tooltip
        var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
        var tooltipList = tooltipTriggerList.map(function(tooltipTriggerEl) {
            return new bootstrap.Tooltip(tooltipTriggerEl)
        });

        // åŠ è½½æ–°é—»æº
        loadSources();

        // åŠ è½½æ–°é—»
        loadNews();

        // ç»‘å®šç­›é€‰å™¨äº‹ä»¶
        document.querySelectorAll('.category-checkbox').forEach(checkbox => {
            checkbox.addEventListener('change', function() {
                updateCategoryCount();
                loadNews();
            });
        });
        document.getElementById('sourceFilter').addEventListener('change', loadNews);
        document.getElementById('timeRange').addEventListener('change', loadNews);
        document.getElementById('excludeUsed').addEventListener('change', loadNews);
        document.getElementById('groupByEvent').addEventListener('change', loadNews);
        document.getElementById('separateHistory').addEventListener('change', loadNews);

        // ç»‘å®šæ’é™¤æ¥æºç›¸å…³äº‹ä»¶
        document.getElementById('excludeSourceSelect').addEventListener('change', function() {
            if (this.value) {
                addExcludedSource(this.value, this.options[this.selectedIndex].text);
                this.value = ''; // é‡ç½®ä¸‹æ‹‰æ¡†
                loadNews();
            }
        });

        document.getElementById('btnClearExcludedSources').addEventListener('click', function() {
            clearAllExcludedSources();
            loadNews();
        });

        // ç»‘å®šåˆ†ç±»å…¨é€‰/å…¨ä¸é€‰æŒ‰é’®äº‹ä»¶
        document.getElementById('btnSelectAllCategories').addEventListener('click', function() {
            document.querySelectorAll('.category-checkbox').forEach(checkbox => {
                checkbox.checked = true;
            });
            updateCategoryCount();
            loadNews();
        });

        document.getElementById('btnDeselectAllCategories').addEventListener('click', function() {
            document.querySelectorAll('.category-checkbox').forEach(checkbox => {
                checkbox.checked = false;
            });
            updateCategoryCount();
            loadNews();
        });

        // åˆå§‹åŒ–åˆ†ç±»è®¡æ•°
        updateCategoryCount();

        // ç»‘å®šç”Ÿæˆå¿«æŠ¥æŒ‰é’®äº‹ä»¶
        document.getElementById('btnGenerateDigest').addEventListener('click', showGenerateDigestModal);
        document.getElementById('btnGenerateDigestBottom').addEventListener('click', showGenerateDigestModal);
        document.getElementById('btnConfirmGenerate').addEventListener('click', generateDigest);

        // åˆå§‹åŒ–æ»šåŠ¨è¿›åº¦ç›‘å¬å™¨
        initScrollProgress();
    });

    let selectedNews = new Set();
    let currentNewsId = null;
    let excludedSources = new Map(); // å­˜å‚¨æ’é™¤çš„æ¥æºï¼Œkeyä¸ºIDï¼Œvalueä¸ºåç§°
    let totalArticles = 0;
    let articleElements = [];

    // æ›´æ–°åˆ†ç±»é€‰æ‹©è®¡æ•°
    function updateCategoryCount() {
        const selectedCount = document.querySelectorAll('.category-checkbox:checked').length;
        const totalCount = document.querySelectorAll('.category-checkbox').length;
        document.getElementById('selectedCategoriesCount').textContent = selectedCount;
    }

    // æ·»åŠ æ’é™¤æ¥æº
    function addExcludedSource(sourceId, sourceName) {
        excludedSources.set(sourceId, sourceName);
        updateExcludedSourcesDisplay();
        updateExcludeSourceSelect();
    }

    // ç§»é™¤æ’é™¤æ¥æº
    function removeExcludedSource(sourceId) {
        excludedSources.delete(sourceId);
        updateExcludedSourcesDisplay();
        updateExcludeSourceSelect();
        loadNews();
    }

    // æ¸…ç©ºæ‰€æœ‰æ’é™¤æ¥æº
    function clearAllExcludedSources() {
        excludedSources.clear();
        updateExcludedSourcesDisplay();
        updateExcludeSourceSelect();
    }

    // æ›´æ–°æ’é™¤æ¥æºæ˜¾ç¤º
    function updateExcludedSourcesDisplay() {
        const excludedRow = document.getElementById('excludedSourcesRow');
        const excludedList = document.getElementById('excludedSourcesList');
        
        if (excludedSources.size > 0) {
            excludedRow.style.display = 'block';
            const tags = Array.from(excludedSources.entries()).map(([id, name]) => 
                `<span class="badge bg-warning text-dark me-1" style="cursor: pointer;" onclick="removeExcludedSource('${id}')">
                    ${name} <i class="bi bi-x"></i>
                </span>`
            ).join('');
            excludedList.innerHTML = tags;
        } else {
            excludedRow.style.display = 'none';
        }
    }

    // æ›´æ–°æ’é™¤æ¥æºä¸‹æ‹‰æ¡†é€‰é¡¹
    function updateExcludeSourceSelect() {
        const excludeSelect = document.getElementById('excludeSourceSelect');
        
        // æ¸…ç©ºç°æœ‰é€‰é¡¹ï¼ˆä¿ç•™é»˜è®¤é€‰é¡¹ï¼‰
        while (excludeSelect.children.length > 1) {
            excludeSelect.removeChild(excludeSelect.lastChild);
        }
        
        // é‡æ–°æ·»åŠ å¯é€‰æ‹©çš„æ¥æºï¼ˆæ’é™¤å·²é€‰æ‹©çš„ï¼‰
        axios.get('/api/sources/')
            .then(response => {
                const sources = response.data;
                sources.forEach(source => {
                    if (!excludedSources.has(source.id.toString())) {
                        const option = document.createElement('option');
                        option.value = source.id;
                        option.textContent = source.name;
                        excludeSelect.appendChild(option);
                    }
                });
            })
            .catch(error => {
                console.error('Error loading sources for exclude select:', error);
            });
    }

    // åŠ è½½æ–°é—»æº
    function loadSources() {
        axios.get('/api/sources/')
            .then(response => {
                const sources = response.data;
                const sourceFilter = document.getElementById('sourceFilter');
                const excludeSourceSelect = document.getElementById('excludeSourceSelect');

                sources.forEach(source => {
                    // æ·»åŠ åˆ°æŒ‡å®šæ¥æºä¸‹æ‹‰æ¡†
                    const option = document.createElement('option');
                    option.value = source.id;
                    option.textContent = source.name;
                    sourceFilter.appendChild(option);

                    // æ·»åŠ åˆ°æ’é™¤æ¥æºä¸‹æ‹‰æ¡†
                    const excludeOption = document.createElement('option');
                    excludeOption.value = source.id;
                    excludeOption.textContent = source.name;
                    excludeSourceSelect.appendChild(excludeOption);
                });

                // åˆå§‹åŒ–æ’é™¤æ¥æºæ˜¾ç¤º
                updateExcludedSourcesDisplay();
            })
            .catch(error => {
                console.error('Error loading sources:', error);
                // å¯ä»¥æ·»åŠ é”™è¯¯æç¤º
                console.log('Failed to load news sources');
            });
    }

    // åŠ è½½æ–°é—»
    function loadNews() {
        // è·å–é€‰ä¸­çš„åˆ†ç±»
        const selectedCategories = Array.from(document.querySelectorAll('.category-checkbox:checked'))
            .map(checkbox => checkbox.value);
        const sourceId = document.getElementById('sourceFilter').value;
        const excludedSourceIds = Array.from(excludedSources.keys());
        const hours = document.getElementById('timeRange').value;
        const excludeUsed = document.getElementById('excludeUsed').checked;
        const groupByEvent = document.getElementById('groupByEvent').checked;
        const separateHistory = document.getElementById('separateHistory').checked;

        // æ˜¾ç¤ºåŠ è½½ä¸­
        document.getElementById('newsContainer').innerHTML = `
            <div class="col-12">
                <div class="loading-container text-center">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <div class="mt-3">
                        <h5 class="text-muted">æ­£åœ¨åŠ è½½æ–°é—»...</h5>
                        <p class="text-secondary">è¯·ç¨å€™ï¼Œæ­£åœ¨ç­›é€‰ç¬¦åˆæ¡ä»¶çš„èµ„è®¯</p>
                    </div>
                </div>
            </div>
        `;

        // æ£€æŸ¥æ˜¯å¦é€‰æ‹©äº†åˆ†ç±»
        if (selectedCategories.length === 0) {
            // å¦‚æœæ²¡æœ‰é€‰æ‹©ä»»ä½•åˆ†ç±»ï¼Œæ˜¾ç¤ºæç¤ºä¿¡æ¯
            document.getElementById('newsContainer').innerHTML = `
                <div class="col-12">
                    <div class="loading-container text-center">
                        <div class="alert alert-info d-inline-block">
                            <i class="bi bi-info-circle me-2"></i> è¯·è‡³å°‘é€‰æ‹©ä¸€ä¸ªåˆ†ç±»æ¥æŸ¥çœ‹æ–°é—»
                        </div>
                    </div>
                </div>
            `;
                                // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
                    updateNewsStatsInfo(0, 'no-category');
                    updateArticleCount(0);
                    return;
        }

        // æ ¹æ®æ˜¾ç¤ºæ¨¡å¼é€‰æ‹©ä¸åŒçš„APIç«¯ç‚¹
        let baseUrl;
        if (separateHistory) {
            baseUrl = '/api/news/recent/separated';
        } else if (groupByEvent) {
            baseUrl = '/api/news/recent/grouped';
        } else {
            baseUrl = '/api/news/recent';
        }
        let url = `${baseUrl}?hours=${hours}&limit=1000`;

        // å¤„ç†å¤šé€‰åˆ†ç±»
        selectedCategories.forEach(category => {
            url += `&category=${encodeURIComponent(category)}`;
        });

        if (sourceId) url += `&source_id=${sourceId}`;
        
        // å¤„ç†æ’é™¤æ¥æº
        excludedSourceIds.forEach(sourceId => {
            url += `&exclude_source_id=${sourceId}`;
        });
        
        if (excludeUsed) url += `&exclude_used=true`;

        axios.get(url)
            .then(response => {
                const container = document.getElementById('newsContainer');
                container.innerHTML = '';

                if (separateHistory) {
                    // å¤„ç†åˆ†ç¦»æ˜¾ç¤ºï¼šä»Šæ—¥æ–°æ–‡ç«  vs ä¸å†å²ç›¸ä¼¼çš„æ–‡ç« 
                    const {
                        fresh_news,
                        similar_to_history
                    } = response.data;

                    // æ˜¾ç¤ºç»Ÿè®¡ä¿¡æ¯
                    container.innerHTML = `
                        <div class="col-12 mb-3">
                            <div class="alert alert-info">
                                <i class="bi bi-info-circle"></i> 
                                å…±æ‰¾åˆ° ${fresh_news.total + similar_to_history.total} æ¡æ–°é—»ï¼š
                                ${fresh_news.total} æ¡ä»Šæ—¥æ–°æ–‡ç« ï¼Œ${similar_to_history.total} æ¡ä¸å†å²å¿«æŠ¥ç›¸ä¼¼
                            </div>
                        </div>
                    `;
                    
                    // æ›´æ–°é¡µé¢æ ‡é¢˜å¤„çš„ç»Ÿè®¡ä¿¡æ¯
                    updateNewsStatsInfo(fresh_news.total + similar_to_history.total, 'separated');
                    updateArticleCount(fresh_news.total + similar_to_history.total);

                    // æ¸²æŸ“ä»Šæ—¥æ–°æ–‡ç« 
                    if (fresh_news.total > 0) {
                        const freshHeader = document.createElement('div');
                        freshHeader.className = 'col-12 mb-3';
                        freshHeader.innerHTML = `
                            <h5 class="text-primary">
                                <i class="bi bi-newspaper"></i> ä»Šæ—¥æ–°æ–‡ç«  (${fresh_news.total})
                            </h5>
                            <hr>
                        `;
                        container.appendChild(freshHeader);

                        fresh_news.items.forEach(news => {
                            renderNewsCard(news, container);
                        });
                    }

                    // æ¸²æŸ“ä¸å†å²ç›¸ä¼¼çš„æ–‡ç« 
                    if (similar_to_history.total > 0) {
                        const similarHeader = document.createElement('div');
                        similarHeader.className = 'col-12 mb-3 mt-4';
                        similarHeader.innerHTML = `
                            <h5 class="text-muted">
                                <i class="bi bi-clock-history"></i> ä¸å†å²å¿«æŠ¥ç›¸ä¼¼çš„æ–‡ç«  (${similar_to_history.total})
                            </h5>
                            <p class="text-muted small mb-2">ä»¥ä¸‹æ–‡ç« ä¸å†å²å¿«æŠ¥ä¸­çš„æ–‡ç« ç›¸ä¼¼ï¼Œå¯èƒ½æ˜¯é‡å¤æˆ–ç›¸å…³å†…å®¹</p>
                            <hr>
                        `;
                        container.appendChild(similarHeader);

                        similar_to_history.items.forEach(news => {
                            renderNewsCard(news, container, true); // ç¬¬ä¸‰ä¸ªå‚æ•°æ ‡è®°ä¸ºå†å²ç›¸ä¼¼
                        });
                    }

                    // å¦‚æœæ²¡æœ‰ä»»ä½•æ–‡ç« 
                    if (fresh_news.total === 0 && similar_to_history.total === 0) {
                        container.innerHTML = `
                            <div class="col-12 text-center py-5">
                                <p class="text-muted">æ²¡æœ‰æ‰¾åˆ°ç¬¦åˆæ¡ä»¶çš„æ–°é—»</p>
                            </div>
                        `;
                        // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
                        updateNewsStatsInfo(0, 'separated');
                        updateArticleCount(0);
                    }
                } else if (groupByEvent) {
                    // å¤„ç†åˆ†ç»„æ˜¾ç¤º
                    const {
                        groups,
                        total_news
                    } = response.data;

                    if (groups.length === 0) {
                        container.innerHTML = `
                            <div class="col-12 text-center py-5">
                                <p class="text-muted">æ²¡æœ‰æ‰¾åˆ°ç¬¦åˆæ¡ä»¶çš„æ–°é—»</p>
                            </div>
                        `;
                        // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
                        updateNewsStatsInfo(0, 'grouped');
                        updateArticleCount(0);
                        return;
                    }

                    // åˆ†ç¦»ç‹¬ç«‹æ–°é—»å’Œäº‹ä»¶ç»„
                    const standaloneGroups = groups.filter(group => group.is_standalone);
                    const eventGroups = groups.filter(group => !group.is_standalone);

                    // æ˜¾ç¤ºç»Ÿè®¡ä¿¡æ¯
                    container.innerHTML = `
                        <div class="col-12 mb-3">
                            <div class="alert alert-info">
                                <i class="bi bi-info-circle"></i> 
                                å…± ${total_news} æ¡æ–°é—»ï¼š${standaloneGroups.length} æ¡ç‹¬ç«‹æ–°é—»ï¼Œ${eventGroups.length} ä¸ªäº‹ä»¶åˆ†ç»„
                            </div>
                        </div>
                    `;
                    
                    // æ›´æ–°é¡µé¢æ ‡é¢˜å¤„çš„ç»Ÿè®¡ä¿¡æ¯
                    updateNewsStatsInfo(total_news, 'grouped');
                    updateArticleCount(total_news);

                    // å…ˆæ¸²æŸ“ç‹¬ç«‹æ–°é—»
                    if (standaloneGroups.length > 0) {
                        // æ·»åŠ ç‹¬ç«‹æ–°é—»æ ‡é¢˜
                        if (eventGroups.length > 0) {
                            const standaloneHeader = document.createElement('div');
                            standaloneHeader.className = 'col-12 mb-3';
                            standaloneHeader.innerHTML = `
                                <h5 class="text-muted">
                                    <i class="bi bi-newspaper"></i> ç‹¬ç«‹æ–°é—» (${standaloneGroups.length})
                                </h5>
                                <hr>
                            `;
                            container.appendChild(standaloneHeader);
                        }

                        // æ¸²æŸ“ç‹¬ç«‹æ–°é—»
                        standaloneGroups.forEach(group => {
                            renderEventGroup(group, 0);
                        });

                        // å¦‚æœæœ‰äº‹ä»¶ç»„ï¼Œæ·»åŠ åˆ†éš”ç¬¦
                        if (eventGroups.length > 0) {
                            const eventHeader = document.createElement('div');
                            eventHeader.className = 'col-12 mb-3 mt-4';
                            eventHeader.innerHTML = `
                                <h5 class="text-muted">
                                    <i class="bi bi-collection"></i> äº‹ä»¶åˆ†ç»„ (${eventGroups.length})
                                </h5>
                                <hr>
                            `;
                            container.appendChild(eventHeader);
                        }
                    }

                    // æ¸²æŸ“äº‹ä»¶åˆ†ç»„
                    eventGroups.forEach((group, index) => {
                        renderEventGroup(group, index);
                    });
                } else {
                    // å¤„ç†æ™®é€šåˆ—è¡¨æ˜¾ç¤º
                    const {
                        items
                    } = response.data;

                    if (items.length === 0) {
                        container.innerHTML = `
                            <div class="col-12 text-center py-5">
                                <p class="text-muted">æ²¡æœ‰æ‰¾åˆ°ç¬¦åˆæ¡ä»¶çš„æ–°é—»</p>
                            </div>
                        `;
                        // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
                        updateNewsStatsInfo(0, 'list');
                        updateArticleCount(0);
                        return;
                    }

                    // æ›´æ–°é¡µé¢æ ‡é¢˜å¤„çš„ç»Ÿè®¡ä¿¡æ¯
                    updateNewsStatsInfo(items.length, 'list');
                    updateArticleCount(items.length);
                    
                    // æ·»åŠ æ–°é—»å¡ç‰‡
                    items.forEach(news => {
                        renderNewsCard(news, container);
                    });
                }
            })
            .catch(error => {
                console.error('Error loading news:', error);
                document.getElementById('newsContainer').innerHTML = `
                        <div class="col-12 text-center py-5">
                            <p class="text-danger">åŠ è½½æ–°é—»å¤±è´¥</p>
                        </div>
                    `;
                // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
                updateNewsStatsInfo(0, 'error');
                updateArticleCount(0);
            });
    }

    // æ¸²æŸ“æ–°é—»å¡ç‰‡çš„é€šç”¨å‡½æ•°
    function renderNewsCard(news, container, isHistorySimilar = false) {
        const isSelected = selectedNews.has(news.id);
        const card = document.createElement('div');
        card.className = 'col-12 mb-3';

        // ä¸ºå†å²ç›¸ä¼¼çš„æ–‡ç« æ·»åŠ ç‰¹æ®Šæ ·å¼
        const cardExtraClasses = isHistorySimilar ? 'opacity-75 border-muted' : '';
        const titlePrefix = isHistorySimilar ? '<i class="bi bi-clock-history text-muted" title="ä¸å†å²å¿«æŠ¥ç›¸ä¼¼"></i> ' : '';

        card.innerHTML = `
            <div class="card news-card ${isSelected ? 'selected' : ''} ${cardExtraClasses}" data-id="${news.id}">
                <div class="reading-indicator"></div>
                <div class="card-body">
                    <span class="category-badge">${getCategoryBadge(news.category)}</span>
                    <h5 class="card-title">
                        ${titlePrefix}${news.generated_title || news.title}
                        ${news.summary_source ? 
                          (news.summary_source === 'original' 
                            ? '<i class="fas fa-quote-left text-info ms-2" title="æ¥è‡ªåŸæ–‡æ‘˜è¦"></i>' 
                            : '<i class="fas fa-robot text-primary ms-2" title="AIç”Ÿæˆæ€»ç»“"></i>') 
                          : ''}
                    </h5>
                    <p class="card-text summary-text">${truncateSummary(news.generated_summary || news.summary, 150)}</p>
                </div>
                <div class="card-footer bg-transparent">
                    <div class="d-flex justify-content-between align-items-start mb-2">
                        <small class="text-muted">æ¥æº: ${news.source_name || 'æœªçŸ¥æ¥æº'} | ${formatDate(news.created_at)}</small>
                        ${news.tokens_usage && news.is_processed ? 
                            `<small class="text-primary" title="æ­¤æ–‡ç« çš„AIå¤„ç†æ¶ˆè€—äº† ${calculateTotalTokens(news.tokens_usage)} ä¸ªtokens">
                                <i class="bi bi-cpu"></i> ${calculateTotalTokens(news.tokens_usage)} tokens
                            </small>` : ''}
                    </div>
                    <div>
                        <button class="btn btn-sm btn-outline-primary btn-view" data-id="${news.id}">æŸ¥çœ‹è¯¦æƒ…</button>
                        <button class="btn btn-sm ${isSelected ? 'btn-success' : 'btn-outline-success'} btn-select" data-id="${news.id}">
                            ${isSelected ? 'âœ“ å·²é€‰æ‹©' : 'é€‰æ‹©'}
                        </button>
                    </div>
                </div>
            </div>
        `;
        container.appendChild(card);

        // ç»‘å®šæŸ¥çœ‹æŒ‰é’®äº‹ä»¶
        card.querySelector('.btn-view').addEventListener('click', function() {
            viewNews(this.getAttribute('data-id'));
        });

        // ç»‘å®šé€‰æ‹©æŒ‰é’®äº‹ä»¶
        card.querySelector('.btn-select').addEventListener('click', function() {
            toggleSelectNews(this.getAttribute('data-id'));
        });
    }


    // æŸ¥çœ‹æ–°é—»è¯¦æƒ…
    function viewNews(newsId) {
        currentNewsId = newsId;

        axios.get(`/api/news/${newsId}`)
            .then(response => {
                    const news = response.data;
                    // æ·»åŠ è°ƒè¯•ä¿¡æ¯
                    console.log('æ–°é—»è¯¦æƒ…æ•°æ®:', news);
                    console.log('æ–‡ç« æ€»ç»“å­—æ®µ:', news.article_summary);

                    const detailContent = document.getElementById('newsDetailContent');

                    let entitiesHtml = '';
                    if (news.entities) {
                        entitiesHtml = '<div class="mt-3"><h6><strong>æå–çš„å®ä½“</strong></h6><ul>';

                        // æ£€æŸ¥å®ä½“æ˜¯å¦ä¸ºæ•°ç»„æ ¼å¼
                        if (Array.isArray(news.entities)) {
                            news.entities.forEach(entity => {
                                if (typeof entity === 'object' && entity !== null) {
                                    // å¤„ç†ä¸åŒæ ¼å¼çš„å®ä½“å¯¹è±¡
                                    if (entity.type && entity.value) {
                                        // æ ‡å‡†æ ¼å¼ {type: "...", value: "..."}
                                        entitiesHtml += `<li><strong>${entity.type}:</strong> ${entity.value}</li>`;
                                    } else {
                                        // å¤„ç†å…¶ä»–æ ¼å¼ {key: value}
                                        const entityType = Object.keys(entity)[0] || 'æœªçŸ¥ç±»å‹';
                                        const entityValue = entity[entityType] || 'æœªçŸ¥';
                                        entitiesHtml += `<li><strong>${entityType}:</strong> ${entityValue}</li>`;
                                    }
                                } else {
                                    entitiesHtml += `<li>${entity}</li>`;
                                }
                            });
                        }
                        // æ£€æŸ¥å®ä½“æ˜¯å¦ä¸ºå¯¹è±¡æ ¼å¼
                        else if (typeof news.entities === 'object') {
                            // æ£€æŸ¥æ˜¯å¦æœ‰typeå’Œvalueå­—æ®µçš„ç‰¹æ®Šå¯¹è±¡
                            if (news.entities.type && news.entities.value) {
                                entitiesHtml += `<li><strong>${news.entities.type}:</strong> ${news.entities.value}</li>`;
                            } else {
                                // å¸¸è§„å¯¹è±¡æ ¼å¼ {key1: value1, key2: value2}
                                for (const [key, value] of Object.entries(news.entities)) {
                                    if (key !== 'error') {
                                        entitiesHtml += `<li><strong>${key}:</strong> ${value}</li>`;
                                    }
                                }
                            }
                        }

                        entitiesHtml += '</ul></div>';
                    }

                    detailContent.innerHTML = `
                    <h4>${news.title}</h4>
                    <div class="text-muted mb-2">æ¥æº: ${news.source_name || 'æœªçŸ¥æ¥æº'} | æ—¶é—´: ${formatDate(news.created_at)}</div>
                    
                    <div class="card mb-3">
                        <div class="card-header bg-light">åŸå§‹å†…å®¹æ‘˜è¦</div>
                        <div class="card-body">
                            <p>${news.summary}</p>
                            <a href="${news.original_url}" target="_blank" class="btn btn-sm btn-outline-primary">æŸ¥çœ‹åŸæ–‡</a>
                        </div>
                    </div>
                    
                    <div class="card mb-3">
                        <div class="card-header bg-light">å¤„ç†ç»“æœ</div>
                        <div class="card-body">
                            ${news.is_processed ? `
                                <div class="mb-2"><strong>ä¸€å¥è¯æ ‡é¢˜:</strong> ${news.generated_title || 'æš‚æ— '}</div>
                                <div class="mb-2"><strong>æ‘˜è¦:</strong> ${news.generated_summary || 'æš‚æ— '}</div>
                                
                                <!-- æ˜¾ç¤ºæ€»ç»“æ¥æº -->
                                <div class="mb-2"><strong>æ€»ç»“æ¥æº:</strong> 
                                    ${news.summary_source === 'original' ? 
                                      '<span class="badge bg-info">æ¥è‡ªåŸæ–‡æ‘˜è¦</span>' :
                                      news.summary_source === 'generated' ? 
                                      '<span class="badge bg-primary">AIç”Ÿæˆ</span>' : 
                                      '<span class="badge bg-secondary">æœªçŸ¥</span>'}
                                </div>
                                
                                <!-- è¯¦ç»†æ–‡ç« æ€»ç»“éƒ¨åˆ†ï¼ˆå¢å¼ºåˆ¤æ–­é€»è¾‘ï¼‰ -->
                                <div class="mb-2"><strong>æ–‡ç« æ€»ç»“çŠ¶æ€:</strong> ${news.article_summary ? 'å·²ç”Ÿæˆ' : 'æœªç”Ÿæˆ'}</div>
                                ${news.article_summary ? `
                                <div class="card mb-3 mt-3">
                                    <div class="card-header bg-light">è¯¦ç»†æ–‡ç« æ€»ç»“</div>
                                    <div class="card-body">
                                        <div class="article-summary markdown-body">${DOMPurify.sanitize(marked.parse(news.article_summary))}</div>
                                    </div>
                                </div>
                                ` : '<div class="alert alert-info mt-2">è¯¥æ–°é—»è¿˜æ²¡æœ‰ç”Ÿæˆè¯¦ç»†æ–‡ç« æ€»ç»“ï¼Œè¯·ä½¿ç”¨"å¤„ç†"åŠŸèƒ½é‡æ–°å¤„ç†æ­¤æ–°é—»</div>'}
                                
                                <div class="mb-2"><strong>åˆ†ç±»:</strong> ${getCategoryLabel(news.category)}</div>
                                ${entitiesHtml}
                                
                                <!-- æ˜¾ç¤ºtokensä½¿ç”¨ä¿¡æ¯ -->
                                ${news.tokens_usage ? `
                                <div class="card mt-3">
                                    <div class="card-header bg-light">Tokensä½¿ç”¨ç»Ÿè®¡</div>
                                    <div class="card-body">
                                        <table class="table table-sm table-striped">
                                            <thead>
                                                <tr>
                                                    <th>å¤„ç†ç±»å‹</th>
                                                    <th>Prompt Tokens</th>
                                                    <th>Completion Tokens</th>
                                                    <th>æ€»è®¡</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                ${formatTokensUsage(news.tokens_usage)}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                                ` : ''}
                            ` : '<div class="alert alert-warning">è¯¥æ–°é—»å°šæœªå¤„ç†</div>'}
                        </div>
                    </div>
                `;
                
                // æ›´æ–°é€‰æ‹©æŒ‰é’®çŠ¶æ€
                const selectBtn = document.getElementById('btnSelectInModal');
                selectBtn.textContent = selectedNews.has(parseInt(newsId)) ? 'å–æ¶ˆé€‰æ‹©' : 'é€‰æ‹©æ­¤æ–°é—»';
                
                // ç»‘å®šé€‰æ‹©æŒ‰é’®äº‹ä»¶
                selectBtn.onclick = function() {
                    toggleSelectNews(newsId);
                    this.textContent = selectedNews.has(parseInt(newsId)) ? 'å–æ¶ˆé€‰æ‹©' : 'é€‰æ‹©æ­¤æ–°é—»';
                };
                
                // ç»‘å®šå¤„ç†æŒ‰é’®äº‹ä»¶
                const processBtn = document.getElementById('btnProcessInModal');
                processBtn.onclick = function() {
                    processNews(newsId);
                };
                
                // æ˜¾ç¤ºæ¨¡æ€æ¡†
                const modal = new bootstrap.Modal(document.getElementById('newsDetailModal'));
                modal.show();
            })
            .catch(error => {
                console.error('Error loading news details:', error);
                alert('åŠ è½½æ–°é—»è¯¦æƒ…å¤±è´¥');
            });
    }
    
    // åˆ‡æ¢é€‰æ‹©æ–°é—»
    function toggleSelectNews(newsId) {
        const id = parseInt(newsId);
        
        if (selectedNews.has(id)) {
            selectedNews.delete(id);
        } else {
            selectedNews.add(id);
        }
        
        // æ›´æ–°é€‰æ‹©è®¡æ•°
        document.getElementById('selectedCount').textContent = selectedNews.size;
        document.getElementById('selectedCountBottom').textContent = selectedNews.size;
        
        // æ›´æ–°ç”ŸæˆæŒ‰é’®çŠ¶æ€
        document.getElementById('btnGenerateDigest').disabled = selectedNews.size === 0;
        document.getElementById('btnGenerateDigestBottom').disabled = selectedNews.size === 0;
        
        // æ›´æ–°æ‰€æœ‰ç›¸å…³æŒ‰é’®çš„çŠ¶æ€ï¼ˆåŒ…æ‹¬äº‹ä»¶ç»„ä¸­çš„æŒ‰é’®ï¼‰
        const allSelectBtns = document.querySelectorAll(`button[data-news-id="${id}"]`);
        allSelectBtns.forEach(btn => {
            btn.classList.toggle('btn-outline-success', !selectedNews.has(id));
            btn.classList.toggle('btn-success', selectedNews.has(id));
            btn.textContent = selectedNews.has(id) ? 'å·²é€‰æ‹©' : 'é€‰æ‹©';
        });
        
        // æ›´æ–°æ™®é€šå¡ç‰‡æ ·å¼ï¼ˆé€‚ç”¨äºéåˆ†ç»„æ¨¡å¼å’Œç‹¬ç«‹æ–°é—»ï¼‰
        const card = document.querySelector(`.news-card[data-id="${id}"]`);
        if (card) {
            card.classList.toggle('selected', selectedNews.has(id));
            
            const selectBtn = card.querySelector('.btn-select');
            if (selectBtn) {
                selectBtn.classList.toggle('btn-outline-success', !selectedNews.has(id));
                selectBtn.classList.toggle('btn-success', selectedNews.has(id));
                selectBtn.textContent = selectedNews.has(id) ? 'å·²é€‰æ‹©' : 'é€‰æ‹©';
            }
        }
    }
    
    // æ˜¾ç¤ºç”Ÿæˆå¿«æŠ¥æ¨¡æ€æ¡†
    function showGenerateDigestModal() {
        if (selectedNews.size === 0) {
            alert('è¯·è‡³å°‘é€‰æ‹©ä¸€æ¡æ–°é—»');
            return;
        }
        
        // æ£€æŸ¥é€‰ä¸­çš„æ–°é—»ä¸­æ˜¯å¦æœ‰ç›¸ä¼¼çš„
        checkSelectedNewsSimilarity();
        
        const modal = new bootstrap.Modal(document.getElementById('generateDigestModal'));
        modal.show();
    }
    
    // æ£€æŸ¥é€‰ä¸­æ–°é—»çš„ç›¸ä¼¼æ€§
    function checkSelectedNewsSimilarity() {
        // è¿™é‡Œå¯ä»¥é€šè¿‡APIæ£€æŸ¥é€‰ä¸­æ–°é—»ä¹‹é—´çš„ç›¸ä¼¼åº¦
        // å¦‚æœå‘ç°é«˜åº¦ç›¸ä¼¼çš„æ–°é—»ï¼Œæç¤ºç”¨æˆ·
        // æš‚æ—¶ä½¿ç”¨å®¢æˆ·ç«¯ç®€å•æ£€æŸ¥ï¼ˆå®é™…åº”è¯¥è°ƒç”¨åç«¯APIï¼‰
        console.log('æ£€æŸ¥é€‰ä¸­çš„ ' + selectedNews.size + ' æ¡æ–°é—»çš„ç›¸ä¼¼æ€§...');
    }
    
    // ç”Ÿæˆå¿«æŠ¥
    function generateDigest() {
        const title = document.getElementById('digestTitle').value;
        const date = document.getElementById('digestDate').value;
        
        if (!title || !date) {
            alert('è¯·å¡«å†™å®Œæ•´ä¿¡æ¯');
            return;
        }
        
        const digestData = {
            title: title,
            date: new Date(date).toISOString(),
            selected_news_ids: Array.from(selectedNews)
        };
        
        axios.post('/api/digest', digestData)
            .then(response => {
                const digestId = response.data.id;
                
                // å…³é—­æ¨¡æ€æ¡†
                const modal = bootstrap.Modal.getInstance(document.getElementById('generateDigestModal'));
                modal.hide();
                
                // æ¸…ç©ºé€‰æ‹©
                selectedNews.clear();
                document.getElementById('selectedCount').textContent = '0';
                document.getElementById('selectedCountBottom').textContent = '0';
                document.getElementById('btnGenerateDigest').disabled = true;
                document.getElementById('btnGenerateDigestBottom').disabled = true;
                
                // é‡æ–°åŠ è½½æ–°é—»
                loadNews();
                
                // è·³è½¬åˆ°å¿«æŠ¥é¡µé¢
                window.location.href = `/digest/${digestId}`;
            })
            .catch(error => {
                console.error('Error generating digest:', error);
                alert('ç”Ÿæˆå¿«æŠ¥å¤±è´¥');
            });
    }
    
    // è¾…åŠ©å‡½æ•° - æ ¼å¼åŒ–æ—¥æœŸ
    function formatDate(dateStr) {
        if (!dateStr) return '';
        const date = new Date(dateStr);
        return date.toLocaleString();
    }
    
    // è¾…åŠ©å‡½æ•° - æ™ºèƒ½æˆªå–æ‘˜è¦æ–‡æœ¬
    function truncateSummary(text, maxLength = 150) {
        if (!text) return '';
        if (text.length <= maxLength) return text;
        
        // å°è¯•åœ¨å¥å·ã€æ„Ÿå¹å·ã€é—®å·å¤„æˆªæ–­
        const sentenceEnders = ['ã€‚', 'ï¼', 'ï¼Ÿ', '.', '!', '?'];
        let bestCutoff = maxLength;
        
        for (let i = Math.min(maxLength - 20, text.length - 1); i >= Math.max(maxLength - 50, 0); i--) {
            if (sentenceEnders.includes(text[i])) {
                bestCutoff = i + 1;
                break;
            }
        }
        
        // å¦‚æœæ²¡æ‰¾åˆ°åˆé€‚çš„å¥å·ä½ç½®ï¼Œå°è¯•åœ¨é€—å·æˆ–ç©ºæ ¼å¤„æˆªæ–­
        if (bestCutoff === maxLength) {
            const softBreaks = ['ï¼Œ', 'ã€', ',', ' ', 'ï¼›', ';'];
            for (let i = Math.min(maxLength - 10, text.length - 1); i >= Math.max(maxLength - 30, 0); i--) {
                if (softBreaks.includes(text[i])) {
                    bestCutoff = i + 1;
                    break;
                }
            }
        }
        
        return text.substring(0, bestCutoff).trim() + '...';
    }
    
    // è¾…åŠ©å‡½æ•° - è·å–åˆ†ç±»æ ‡ç­¾
    function getCategoryBadge(category) {
        const categories = {
            'é‡‘èä¸šç½‘ç»œå®‰å…¨äº‹ä»¶': '<span class="badge bg-info">é‡‘èä¸š</span>',
            'é‡å¤§ç½‘ç»œå®‰å…¨äº‹ä»¶': '<span class="badge bg-danger">é‡å¤§äº‹ä»¶</span>',
            'é‡å¤§æ•°æ®æ³„éœ²äº‹ä»¶': '<span class="badge bg-warning">æ•°æ®æ³„éœ²</span>',
            'é‡å¤§æ¼æ´é£é™©æç¤º': '<span class="badge bg-primary">æ¼æ´é£é™©</span>',
            'å…¶ä»–': '<span class="badge bg-secondary">å…¶ä»–</span>'
        };
        
        return categories[category] || categories['å…¶ä»–'];
    }
    
    // è¾…åŠ©å‡½æ•° - è·å–åˆ†ç±»æ–‡æœ¬
    function getCategoryLabel(category) {
        const categories = {
            'é‡‘èä¸šç½‘ç»œå®‰å…¨äº‹ä»¶': 'é‡‘èä¸šç½‘ç»œå®‰å…¨äº‹ä»¶',
            'é‡å¤§ç½‘ç»œå®‰å…¨äº‹ä»¶': 'é‡å¤§ç½‘ç»œå®‰å…¨äº‹ä»¶',
            'é‡å¤§æ•°æ®æ³„éœ²äº‹ä»¶': 'é‡å¤§æ•°æ®æ³„éœ²äº‹ä»¶',
            'é‡å¤§æ¼æ´é£é™©æç¤º': 'é‡å¤§æ¼æ´é£é™©æç¤º',
            'å…¶ä»–': 'å…¶ä»–'
        };
        
        return categories[category] || 'å…¶ä»–';
    }
    
    // å¤„ç†æ–°é—»
    function processNews(newsId) {
        const processBtn = document.getElementById('btnProcessInModal');
        processBtn.disabled = true;
        processBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> å¤„ç†ä¸­...';
        
        axios.post(`/api/news/${newsId}/process`)
            .then(response => {
                console.log('æ–°é—»å¤„ç†å®Œæˆ:', response.data);
                alert('æ–°é—»å¤„ç†å®Œæˆï¼Œå°†é‡æ–°åŠ è½½è¯¦æƒ…');
                // é‡æ–°åŠ è½½æ–°é—»è¯¦æƒ…
                viewNews(newsId);
            })
            .catch(error => {
                console.error('Error processing news:', error);
                alert('å¤„ç†æ–°é—»å¤±è´¥: ' + (error.response?.data?.detail || error.message));
            })
            .finally(() => {
                processBtn.disabled = false;
                processBtn.innerHTML = 'é‡æ–°å¤„ç†';
            });
    }

    // æ¸²æŸ“äº‹ä»¶åˆ†ç»„
    function renderEventGroup(group, index) {
        const container = document.getElementById('newsContainer');
        
        // æ£€æŸ¥æ˜¯å¦ä¸ºç‹¬ç«‹æ–°é—»
        if (group.is_standalone) {
            // ç‹¬ç«‹æ–°é—»ä»¥ç®€æ´çš„å¡ç‰‡å½¢å¼æ˜¾ç¤º
            renderStandaloneNews(group.primary);
            return;
        }
        
        const groupEl = document.createElement('div');
        groupEl.className = 'col-12';
        
        // è·å–å…³é”®å®ä½“ç”¨äºæ˜¾ç¤º
        const keyEntities = [];
        if (group.entities.CVE && group.entities.CVE.length > 0) {
            keyEntities.push(...group.entities.CVE.slice(0, 2));
        }
        if (group.entities['ç»„ç»‡'] && group.entities['ç»„ç»‡'].length > 0) {
            keyEntities.push(...group.entities['ç»„ç»‡'].slice(0, 2));
        }
        if (group.entities['äº§å“'] && group.entities['äº§å“'].length > 0) {
            keyEntities.push(...group.entities['äº§å“'].slice(0, 1));
        }
        
        const isExpanded = true; // é»˜è®¤å±•å¼€æ‰€æœ‰äº‹ä»¶ç»„
        
        groupEl.innerHTML = `
            <div class="event-group" data-group-id="${group.id}">
                <div class="event-header" onclick="toggleEventGroup('${group.id}')">
                    <div>
                        <div class="event-label">
                            <i class="bi bi-collection"></i> ${group.event_label}
                        </div>
                        <div class="event-entities">
                            ${keyEntities.map(entity => `<span class="entity-tag">${entity}</span>`).join('')}
                        </div>
                    </div>
                    <div class="event-meta">
                        <span><i class="bi bi-newspaper"></i> ${group.news_count} ç¯‡æŠ¥é“</span>
                        <span><i class="bi bi-broadcast"></i> ${group.sources.length} ä¸ªæ¥æº</span>
                        <i class="bi bi-chevron-down toggle-icon ${isExpanded ? '' : 'rotated'}"></i>
                    </div>
                </div>
                <div class="event-content ${isExpanded ? '' : 'collapsed'}" id="content-${group.id}">
                    <div class="primary-news">
                        <h5>
                            ${group.primary.generated_title || group.primary.title}
                            <span class="badge bg-primary">ä¸»è¦æ–°é—»</span>
                        </h5>
                        <p>${truncateSummary(group.primary.generated_summary || group.primary.summary, 200)}</p>
                        <div class="mt-2">
                            <div class="d-flex justify-content-between align-items-start mb-2">
                                <small class="text-muted">
                                    æ¥æº: ${group.primary.source_name || 'æœªçŸ¥æ¥æº'} | ${formatDate(group.primary.created_at)}
                                </small>
                                ${group.primary.tokens_usage && group.primary.is_processed ? 
                                    `<small class="text-primary" title="æ­¤æ–‡ç« çš„AIå¤„ç†æ¶ˆè€—äº† ${calculateTotalTokens(group.primary.tokens_usage)} ä¸ªtokens">
                                        <i class="bi bi-cpu"></i> ${calculateTotalTokens(group.primary.tokens_usage)} tokens
                                    </small>` : ''}
                            </div>
                            <div>
                                <button class="btn btn-sm btn-outline-primary me-2" onclick="viewNews(${group.primary.id})">
                                    æŸ¥çœ‹è¯¦æƒ…
                                </button>
                                <button class="btn btn-sm ${selectedNews.has(group.primary.id) ? 'btn-success' : 'btn-outline-success'}" 
                                        data-news-id="${group.primary.id}" onclick="toggleSelectNews(${group.primary.id})">
                                    ${selectedNews.has(group.primary.id) ? 'å·²é€‰æ‹©' : 'é€‰æ‹©'}
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    ${group.related.length > 0 ? `
                        <div class="related-news">
                            <h6 class="text-muted mb-3">ç›¸å…³æŠ¥é“ (${group.related.length})</h6>
                            ${group.related.map(news => `
                                <div class="related-news-item">
                                    <div class="similarity-badge">${Math.round(group.similarity_scores[news.id] * 100)}% ç›¸ä¼¼</div>
                                    <h6>${news.generated_title || news.title}</h6>
                                    <div class="d-flex justify-content-between align-items-start mb-2">
                                        <small class="text-muted">
                                            æ¥æº: ${news.source_name || 'æœªçŸ¥æ¥æº'} | ${formatDate(news.created_at)}
                                        </small>
                                        ${news.tokens_usage && news.is_processed ? 
                                            `<small class="text-primary" title="æ­¤æ–‡ç« çš„AIå¤„ç†æ¶ˆè€—äº† ${calculateTotalTokens(news.tokens_usage)} ä¸ªtokens">
                                                <i class="bi bi-cpu"></i> ${calculateTotalTokens(news.tokens_usage)} tokens
                                            </small>` : ''}
                                    </div>
                                    <div class="mt-2">
                                        <button class="btn btn-sm btn-outline-primary me-2" onclick="viewNews(${news.id})">
                                            æŸ¥çœ‹
                                        </button>
                                        <button class="btn btn-sm ${selectedNews.has(news.id) ? 'btn-success' : 'btn-outline-success'}" 
                                                data-news-id="${news.id}" onclick="toggleSelectNews(${news.id})">
                                            ${selectedNews.has(news.id) ? 'å·²é€‰æ‹©' : 'é€‰æ‹©'}
                                        </button>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    ` : ''}
                </div>
            </div>
        `;
        
        container.appendChild(groupEl);
    }
    
    // æ¸²æŸ“ç‹¬ç«‹æ–°é—»
    function renderStandaloneNews(news) {
        const container = document.getElementById('newsContainer');
        const isSelected = selectedNews.has(news.id);
        
        // åˆ›å»ºç‹¬ç«‹æ–°é—»å¡ç‰‡
        const newsCard = document.createElement('div');
        newsCard.className = 'col-12 mb-3';
        newsCard.innerHTML = `
            <div class="card news-card ${isSelected ? 'selected' : ''}" data-id="${news.id}">
                <div class="reading-indicator"></div>
                <div class="card-body">
                    <span class="category-badge">${getCategoryBadge(news.category)}</span>
                    <h5 class="card-title">
                        ${news.generated_title || news.title}
                        ${news.summary_source ? 
                          (news.summary_source === 'original' 
                            ? '<i class="fas fa-quote-left text-info ms-2" title="æ¥è‡ªåŸæ–‡æ‘˜è¦"></i>' 
                            : '<i class="fas fa-robot text-primary ms-2" title="AIç”Ÿæˆæ€»ç»“"></i>') 
                          : ''}
                    </h5>
                    <p class="card-text summary-text">${truncateSummary(news.generated_summary || news.summary, 150)}</p>
                </div>
                <div class="card-footer bg-transparent">
                    <div class="d-flex justify-content-between align-items-start mb-2">
                        <small class="text-muted">æ¥æº: ${news.source_name || 'æœªçŸ¥æ¥æº'} | ${formatDate(news.created_at)}</small>
                        ${news.tokens_usage && news.is_processed ? 
                            `<small class="text-primary" title="æ­¤æ–‡ç« çš„AIå¤„ç†æ¶ˆè€—äº† ${calculateTotalTokens(news.tokens_usage)} ä¸ªtokens">
                                <i class="bi bi-cpu"></i> ${calculateTotalTokens(news.tokens_usage)} tokens
                            </small>` : ''}
                    </div>
                    <div>
                        <button class="btn btn-sm btn-outline-primary btn-view" onclick="viewNews(${news.id})">æŸ¥çœ‹è¯¦æƒ…</button>
                        <button class="btn btn-sm ${isSelected ? 'btn-success' : 'btn-outline-success'} btn-select" data-news-id="${news.id}" onclick="toggleSelectNews(${news.id})">
                            ${isSelected ? 'âœ“ å·²é€‰æ‹©' : 'é€‰æ‹©'}
                        </button>
                    </div>
                </div>
            </div>
        `;
        
        // æŸ¥æ‰¾æˆ–åˆ›å»ºç‹¬ç«‹æ–°é—»å®¹å™¨è¡Œ
        let standaloneRow = container.querySelector('.row.standalone-news');
        if (!standaloneRow) {
            standaloneRow = document.createElement('div');
            standaloneRow.className = 'row standalone-news';
            container.appendChild(standaloneRow);
        }
        
        standaloneRow.appendChild(newsCard);
    }
    
    // åˆ‡æ¢äº‹ä»¶ç»„å±•å¼€/æŠ˜å 
    function toggleEventGroup(groupId) {
        const content = document.getElementById(`content-${groupId}`);
        const icon = document.querySelector(`[data-group-id="${groupId}"] .toggle-icon`);
        
        if (content.classList.contains('collapsed')) {
            content.classList.remove('collapsed');
            icon.classList.remove('rotated');
        } else {
            content.classList.add('collapsed');
            icon.classList.add('rotated');
        }
    }
    
    // æ›´æ–°æ–°é—»ç»Ÿè®¡ä¿¡æ¯çš„å‡½æ•°
    function updateNewsStatsInfo(totalNews, mode) {
        const statsEl = document.getElementById('newsStatsInfo');
        if (!statsEl) return;
        
        let modeText = '';
                 switch(mode) {
            case 'list':
                modeText = 'åˆ—è¡¨æ¨¡å¼';
                break;
            case 'grouped':
                modeText = 'åˆ†ç»„æ¨¡å¼';
                break;
            case 'separated':
                modeText = 'åˆ†ç¦»æ¨¡å¼';
                break;
            case 'error':
                modeText = 'åŠ è½½å¤±è´¥';
                break;
            case 'no-category':
                modeText = 'æœªé€‰æ‹©åˆ†ç±»';
                break;
            default:
                modeText = 'æœªçŸ¥æ¨¡å¼';
                break;
        }
        
        statsEl.textContent = `å½“å‰æ˜¾ç¤º ${totalNews} æ¡æ–°é—» (${modeText})`;
    }

    // è¾…åŠ©å‡½æ•° - è®¡ç®—æ€»tokenæ•°é‡
    function calculateTotalTokens(tokensUsage) {
        if (!tokensUsage) return 0;
        
        let totalTokens = 0;
        for (const [type, usage] of Object.entries(tokensUsage)) {
            if (usage && typeof usage === 'object') {
                totalTokens += usage.total_tokens || 0;
            }
        }
        return totalTokens;
    }

    // è¾…åŠ©å‡½æ•° - æ ¼å¼åŒ–tokensä½¿ç”¨ä¿¡æ¯
    function formatTokensUsage(tokensUsage) {
        if (!tokensUsage) return '';
        
        let html = '';
        let totalPromptTokens = 0;
        let totalCompletionTokens = 0;
        let totalTokens = 0;
        
        // å¤„ç†ç±»å‹æ˜ å°„è¡¨ï¼Œå°†åç«¯å­—æ®µæ˜ å°„ä¸ºå¯è¯»çš„åç§°
        const typeLabels = {
            'title_translation': 'æ ‡é¢˜ç¿»è¯‘',
            'summary_translation': 'æ‘˜è¦ç¿»è¯‘',
            'content_translation': 'å†…å®¹ç¿»è¯‘',
            'article_summary': 'æ–‡ç« æ€»ç»“',
            'category': 'åˆ†ç±»',
            'entities': 'å®ä½“æå–'
        };
        
        for (const [type, usage] of Object.entries(tokensUsage)) {
            if (!usage) continue;
            
            // è·å–tokensæ•°é‡ï¼Œå¤„ç†ä¸åŒæ ¼å¼çš„usageå¯¹è±¡
            let promptTokens = 0;
            let completionTokens = 0;
            let tokensSum = 0;
            
            if (typeof usage === 'object') {
                // å¤„ç†æ ‡å‡†æ ¼å¼
                promptTokens = usage.prompt_tokens || 0;
                completionTokens = usage.completion_tokens || 0;
                tokensSum = usage.total_tokens || (promptTokens + completionTokens);
                
                // ç´¯è®¡æ€»æ•°
                totalPromptTokens += promptTokens;
                totalCompletionTokens += completionTokens;
                totalTokens += tokensSum;
                
                // ç”Ÿæˆè¡¨æ ¼è¡Œ
                const label = typeLabels[type] || type;
                html += `
                    <tr>
                        <td>${label}</td>
                        <td>${promptTokens}</td>
                        <td>${completionTokens}</td>
                        <td>${tokensSum}</td>
                    </tr>
                `;
            }
        }
        
        // æ·»åŠ æ€»è®¡è¡Œ
        html += `
            <tr class="table-primary">
                <td><strong>æ€»è®¡</strong></td>
                <td><strong>${totalPromptTokens}</strong></td>
                <td><strong>${totalCompletionTokens}</strong></td>
                <td><strong>${totalTokens}</strong></td>
            </tr>
        `;
        
        return html;
    }

    // åˆå§‹åŒ–æ»šåŠ¨è¿›åº¦åŠŸèƒ½
    function initScrollProgress() {
        const progressIndicator = document.getElementById('progressIndicator');
        const progressBar = document.getElementById('progressBar');
        const currentArticleSpan = document.querySelector('.current-article');
        const totalArticlesSpan = document.querySelector('.total-articles');
        const scrollHint = document.getElementById('scrollHint');

        let scrollTimeout;

        window.addEventListener('scroll', function() {
            clearTimeout(scrollTimeout);
            
            // æ˜¾ç¤ºè¿›åº¦æ¡
            if (window.scrollY > 100) {
                progressIndicator.classList.add('visible');
                document.body.classList.add('progress-visible');
            } else {
                progressIndicator.classList.remove('visible');
                document.body.classList.remove('progress-visible');
            }

            // æ›´æ–°è¿›åº¦
            updateScrollProgress();

            // å»¶è¿Ÿéšè—æ»šåŠ¨æç¤º
            scrollTimeout = setTimeout(() => {
                if (scrollHint) {
                    scrollHint.style.opacity = '0.5';
                }
            }, 2000);
        });

        // é¼ æ ‡æ‚¬åœæ—¶æ˜¾ç¤ºæ»šåŠ¨æç¤º
        progressIndicator.addEventListener('mouseenter', function() {
            if (scrollHint) {
                scrollHint.style.opacity = '1';
            }
        });
    }

    // æ›´æ–°æ»šåŠ¨è¿›åº¦
    function updateScrollProgress() {
        const progressBar = document.getElementById('progressBar');
        const currentArticleSpan = document.querySelector('.current-article');
        
        if (articleElements.length === 0) {
            return;
        }

        let currentArticle = 0;
        const viewportHeight = window.innerHeight;
        const scrollTop = window.scrollY;

        // è®¡ç®—å½“å‰å¯è§çš„æ–‡ç« æ•°é‡
        articleElements.forEach((element, index) => {
            const rect = element.getBoundingClientRect();
            const elementTop = scrollTop + rect.top;
            
            // å¦‚æœæ–‡ç« çš„é¡¶éƒ¨å·²ç»æ»šè¿‡è§†å£ä¸­å¿ƒï¼Œåˆ™è®¤ä¸ºå·²è¯»
            if (elementTop < scrollTop + viewportHeight / 2) {
                currentArticle = index + 1;
            }
        });

        // æ›´æ–°è¿›åº¦æ¡
        const progress = (currentArticle / totalArticles) * 100;
        progressBar.style.width = `${progress}%`;
        
        // æ›´æ–°æ–‡å­—
        currentArticleSpan.textContent = currentArticle;
        
        // æ›´æ–°æ»šåŠ¨æç¤º
        const scrollHint = document.getElementById('scrollHint');
        const remaining = totalArticles - currentArticle;
        if (remaining > 0) {
            scrollHint.textContent = `è¿˜æœ‰ ${remaining} ç¯‡æ–‡ç« æœªé˜…è¯»`;
        } else {
            scrollHint.textContent = 'å·²é˜…è¯»å®Œæ‰€æœ‰æ–‡ç« ';
        }
    }

    // æ›´æ–°æ–‡ç« è®¡æ•°ï¼ˆåœ¨åŠ è½½æ–°é—»æ—¶è°ƒç”¨ï¼‰
    function updateArticleCount(total) {
        totalArticles = total;
        document.querySelector('.total-articles').textContent = total;
        
        // æ˜¾ç¤ºæˆ–éšè—åº•éƒ¨æ“ä½œæ 
        const bottomActionBar = document.getElementById('bottomActionBar');
        if (total > 0) {
            bottomActionBar.style.display = 'block';
        } else {
            bottomActionBar.style.display = 'none';
        }
        
        // æ›´æ–°æ–‡ç« å…ƒç´ åˆ—è¡¨
        setTimeout(() => {
            articleElements = Array.from(document.querySelectorAll('.news-card, .event-group'));
            updateScrollProgress();
        }, 100);
    }
</script>
{% endblock %}