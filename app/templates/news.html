{% extends "base.html" %} {% block title %}今日新闻 - 每日安全快报系统{% endblock %} {% block extra_css %}
<style>
    /* 现代化根变量定义 */
    :root {
        --primary-color: #2563eb;
        --primary-hover: #1d4ed8;
        --secondary-color: #64748b;
        --success-color: #059669;
        --warning-color: #d97706;
        --danger-color: #dc2626;
        --info-color: #0891b2;
        --dark-color: #1e293b;
        --light-color: #f8fafc;
        
        --gradient-primary: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        --gradient-success: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
        --gradient-warning: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        --gradient-info: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        
        --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
        --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
        --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
        --shadow-xl: 0 20px 25px -5px rgb(0 0 0 / 0.1), 0 8px 10px -6px rgb(0 0 0 / 0.1);
        
        --radius-sm: 0.375rem;
        --radius-md: 0.5rem;
        --radius-lg: 0.75rem;
        --radius-xl: 1rem;
    }
    
    /* 现代化页面背景 */
    body {
        background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
        min-height: 100vh;
        font-family: 'Inter', 'SF Pro Display', -apple-system, BlinkMacSystemFont, sans-serif;
    }
    
    /* 现代化新闻卡片 */
    .news-card {
        margin-bottom: 1.5rem;
        transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        border: none;
        border-radius: var(--radius-xl);
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(10px);
        box-shadow: var(--shadow-md);
        overflow: hidden;
        position: relative;
    }
    
    .news-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 4px;
        background: var(--gradient-primary);
        opacity: 0;
        transition: opacity 0.3s ease;
    }
    
    .news-card:hover {
        transform: translateY(-8px) scale(1.02);
        box-shadow: var(--shadow-xl);
    }
    
    .news-card:hover::before {
        opacity: 1;
    }
    
    .news-card.selected {
        border: 2px solid var(--primary-color);
        box-shadow: 0 0 0 4px rgba(37, 99, 235, 0.1), var(--shadow-xl);
        transform: translateY(-4px);
    }
    
    .news-card.selected::before {
        opacity: 1;
        background: var(--gradient-success);
    }
    
    .category-badge {
        position: absolute;
        top: 1rem;
        right: 1rem;
        z-index: 10;
    }
    
    .card-footer {
        display: flex;
        justify-content: space-between;
        align-items: center;
        background: rgba(248, 250, 252, 0.8);
        backdrop-filter: blur(10px);
        border-top: 1px solid rgba(226, 232, 240, 0.5);
    }
    /* Markdown样式 */
    
    .markdown-body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, Arial, sans-serif;
        line-height: 1.6;
    }
    
    .markdown-body h1,
    .markdown-body h2,
    .markdown-body h3,
    .markdown-body h4,
    .markdown-body h5,
    .markdown-body h6 {
        margin-top: 16px;
        margin-bottom: 16px;
        font-weight: 600;
        line-height: 1.25;
    }
    
    .markdown-body h1 {
        font-size: 2em;
    }
    
    .markdown-body h2 {
        font-size: 1.5em;
    }
    
    .markdown-body h3 {
        font-size: 1.25em;
    }
    
    .markdown-body h4 {
        font-size: 1em;
    }
    
    .markdown-body strong {
        font-weight: 600;
    }
    
    .markdown-body ul,
    .markdown-body ol {
        padding-left: 2em;
        margin-bottom: 16px;
    }
    
    .markdown-body li {
        margin: 0.25em 0;
    }
    
    .markdown-body p {
        margin-top: 0;
        margin-bottom: 16px;
    }
    
    .markdown-body code {
        padding: 0.2em 0.4em;
        margin: 0;
        background-color: rgba(27, 31, 35, 0.05);
        border-radius: 3px;
    }
    
    .markdown-body pre {
        padding: 16px;
        overflow: auto;
        line-height: 1.45;
        background-color: #f6f8fa;
        border-radius: 3px;
    }
    /* 现代化筛选器样式 */
    .filter-card {
        background: rgba(255, 255, 255, 0.9);
        backdrop-filter: blur(15px);
        border: 1px solid rgba(255, 255, 255, 0.3);
        border-radius: var(--radius-xl);
        box-shadow: var(--shadow-lg);
        overflow: hidden;
    }
    
    .filter-card .card-body {
        padding: 2rem;
    }
    
    .form-label {
        font-weight: 600;
        margin-bottom: 0.75rem;
        color: #374151;
        font-size: 0.875rem;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }
    
    .form-label.fw-bold {
        font-weight: 700;
        color: #1f2937;
        font-size: 1rem;
    }
    
    .badge {
        cursor: pointer;
        transition: all 0.2s ease;
        border-radius: var(--radius-md);
        padding: 0.5rem 1rem;
        font-weight: 500;
        letter-spacing: 0.015em;
    }
    
    .badge:hover {
        opacity: 0.9;
        box-shadow: var(--shadow-sm);
    }
    
    .form-select, .form-control {
        border: 2px solid rgba(226, 232, 240, 0.6);
        border-radius: var(--radius-lg);
        padding: 0.75rem 1rem;
        font-size: 0.875rem;
        transition: all 0.3s ease;
        background: rgba(255, 255, 255, 0.8);
        backdrop-filter: blur(10px);
    }
    
    .form-select:focus, .form-control:focus {
        border-color: var(--primary-color);
        box-shadow: 0 0 0 4px rgba(37, 99, 235, 0.1);
        background: rgba(255, 255, 255, 0.95);
        transform: translateY(-1px);
    }
    
    .form-check-input {
        border-radius: var(--radius-sm);
        border: 2px solid rgba(226, 232, 240, 0.8);
        transition: all 0.3s ease;
    }
    
    .form-check-input:checked {
        background-color: var(--primary-color);
        border-color: var(--primary-color);
        box-shadow: 0 0 0 4px rgba(37, 99, 235, 0.1);
    }
    
    .form-switch .form-check-input {
        border-radius: 2rem;
    }
    
    /* 专业化按钮样式 */
    .btn {
        border-radius: var(--radius-md);
        font-weight: 600;
        letter-spacing: 0.015em;
        transition: all 0.2s ease;
        border: none;
        padding: 0.75rem 1.5rem;
    }
    
    .btn-primary {
        background-color: var(--primary-color);
        color: white;
        box-shadow: var(--shadow-sm);
    }
    
    .btn-primary:hover {
        background-color: var(--primary-hover);
        box-shadow: var(--shadow-md);
    }
    
    .btn-success {
        background-color: var(--success-color);
        color: white;
        box-shadow: var(--shadow-sm);
    }
    
    .btn-success:hover {
        background-color: #047857;
        box-shadow: var(--shadow-md);
    }
    
    .btn-outline-primary {
        border: 2px solid var(--primary-color);
        color: var(--primary-color);
        background: transparent;
    }
    
    .btn-outline-primary:hover {
        background-color: var(--primary-color);
        color: white;
        box-shadow: var(--shadow-sm);
    }
    
    .btn-outline-secondary {
        border: 2px solid var(--secondary-color);
        color: var(--secondary-color);
        background: transparent;
    }
    
    .btn-outline-secondary:hover {
        background-color: var(--secondary-color);
        color: white;
        box-shadow: var(--shadow-sm);
    }
    
    /* 现代化滚动进度指示器 */
    .progress-indicator {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        z-index: 1030;
        background: rgba(255, 255, 255, 0.9);
        backdrop-filter: blur(20px);
        border-bottom: 1px solid rgba(226, 232, 240, 0.5);
        padding: 1rem 2rem;
        display: flex;
        align-items: center;
        justify-content: space-between;
        transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        transform: translateY(-100%);
        box-shadow: var(--shadow-lg);
    }
    
    .progress-indicator.visible {
        transform: translateY(0);
    }
    
    .progress-bar-container {
        flex: 1;
        height: 8px;
        background: rgba(226, 232, 240, 0.6);
        border-radius: var(--radius-lg);
        margin: 0 1.5rem;
        overflow: hidden;
        position: relative;
    }
    
    .progress-bar {
        height: 100%;
        background: var(--gradient-info);
        border-radius: var(--radius-lg);
        transition: width 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        width: 0%;
        position: relative;
        overflow: hidden;
    }
    
    .progress-bar::after {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.4), transparent);
        animation: shimmer 2s infinite;
    }
    
    @keyframes shimmer {
        0% { left: -100%; }
        100% { left: 100%; }
    }
    
    .progress-text {
        font-weight: 700;
        color: #1f2937;
        min-width: 140px;
        text-align: center;
        font-size: 0.875rem;
        background: rgba(37, 99, 235, 0.1);
        padding: 0.5rem 1rem;
        border-radius: var(--radius-lg);
    }
    
    .scroll-hint {
        font-size: 0.8rem;
        color: var(--secondary-color);
        font-weight: 500;
        min-width: 180px;
        text-align: right;
        opacity: 0.8;
        transition: opacity 0.3s ease;
    }
    
    /* 现代化卡片内容样式 */
    .news-card .card-body {
        padding: 2rem;
        position: relative;
    }
    
    .news-card .card-title {
        font-size: 1.125rem;
        font-weight: 700;
        line-height: 1.4;
        margin-bottom: 1rem;
        color: #1f2937;
    }
    
    .card-text {
        color: var(--secondary-color);
        line-height: 1.6;
        font-size: 0.925rem;
    }
    
    /* 现代化事件组样式 */
    .event-group {
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(15px);
        border-radius: var(--radius-xl);
        box-shadow: var(--shadow-lg);
        margin-bottom: 2rem;
        overflow: hidden;
        transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        border: 1px solid rgba(255, 255, 255, 0.3);
    }
    
    .event-group:hover {
        transform: translateY(-4px);
        box-shadow: var(--shadow-xl);
    }
    
    .event-header {
        background: rgba(37, 99, 235, 0.05);
        padding: 1.5rem 2rem;
        border-bottom: 1px solid rgba(226, 232, 240, 0.5);
        cursor: pointer;
        transition: all 0.3s ease;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    
    .event-header:hover {
        background: rgba(37, 99, 235, 0.1);
    }
    
    .event-label {
        font-size: 1.125rem;
        font-weight: 700;
        color: #1f2937;
        margin-bottom: 0.5rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }
    
    .event-entities {
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem;
        margin-top: 0.5rem;
    }
    
    .entity-tag {
        background-color: var(--info-color);
        color: white;
        padding: 0.25rem 0.75rem;
        border-radius: var(--radius-md);
        font-size: 0.8rem;
        font-weight: 500;
        box-shadow: var(--shadow-sm);
    }
    
    .event-meta {
        display: flex;
        align-items: center;
        gap: 1rem;
        color: var(--secondary-color);
        font-size: 0.875rem;
        font-weight: 500;
    }
    
    .event-meta span {
        display: flex;
        align-items: center;
        gap: 0.25rem;
    }
    
    .toggle-icon {
        transition: transform 0.3s ease;
        font-size: 1.2rem;
        color: var(--primary-color);
    }
    
    .toggle-icon.rotated {
        transform: rotate(180deg);
    }
    
    .event-content {
        padding: 2rem;
        transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        max-height: 2000px;
        overflow: hidden;
    }
    
    .event-content.collapsed {
        max-height: 0;
        padding: 0 2rem;
    }
    
    .primary-news {
        background: rgba(34, 197, 94, 0.05);
        border-left: 4px solid var(--success-color);
        padding: 1.5rem;
        border-radius: var(--radius-lg);
        margin-bottom: 1.5rem;
    }
    
    .related-news {
        margin-top: 1.5rem;
    }
    
    .related-news-item {
        background: rgba(248, 250, 252, 0.8);
        border-radius: var(--radius-lg);
        padding: 1.25rem;
        margin-bottom: 1rem;
        border: 1px solid rgba(226, 232, 240, 0.5);
        transition: all 0.3s ease;
    }
    
    .related-news-item:hover {
        background: rgba(255, 255, 255, 0.9);
        transform: translateX(8px);
        box-shadow: var(--shadow-md);
    }
    
    /* 专业化底部操作栏 */
    #bottomActionBar .card {
        background: var(--primary-color);
        border: none;
        box-shadow: var(--shadow-lg);
        color: white;
    }
    
    #bottomActionBar .card-body {
        padding: 2.5rem 2rem;
    }
    
    #bottomActionBar h5 {
        color: white;
        font-weight: 700;
        margin-bottom: 0.5rem;
    }
    
    #bottomActionBar .text-muted {
        color: rgba(255, 255, 255, 0.9) !important;
        font-size: 1rem;
    }
    
    #bottomActionBar .btn-primary {
        background-color: white;
        color: var(--primary-color);
        border: none;
        font-weight: 700;
        padding: 1rem 2rem;
        font-size: 1.1rem;
        box-shadow: var(--shadow-md);
    }
    
    #bottomActionBar .btn-primary:hover {
        background-color: #f8fafc;
        box-shadow: var(--shadow-lg);
    }
    
    #bottomActionBar .btn-outline-secondary {
        border: 2px solid rgba(255, 255, 255, 0.8);
        color: white;
        background: transparent;
        font-weight: 600;
    }
    
    #bottomActionBar .btn-outline-secondary:hover {
        background-color: rgba(255, 255, 255, 0.1);
        border-color: white;
    }
    
    /* 现代化加载动画 */
    .spinner-border {
        width: 3rem;
        height: 3rem;
        border-width: 0.3em;
        animation: spinner-border 0.8s linear infinite;
    }
    
    .loading-container {
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(15px);
        border-radius: var(--radius-xl);
        padding: 4rem 2rem;
        box-shadow: var(--shadow-lg);
        margin: 2rem 0;
    }
    
    /* 专业化分类徽章样式 */
    .bg-info {
        background-color: var(--info-color) !important;
    }
    
    .bg-danger {
        background-color: var(--danger-color) !important;
    }
    
    .bg-warning {
        background-color: var(--warning-color) !important;
    }
    
    .bg-primary {
        background-color: var(--primary-color) !important;
    }
    
    .bg-secondary {
        background-color: var(--secondary-color) !important;
    }
    
    .bg-success {
        background-color: var(--success-color) !important;
    }
    
    /* 现代化警告框样式 */
    .alert {
        border: none;
        border-radius: var(--radius-lg);
        backdrop-filter: blur(10px);
        box-shadow: var(--shadow-md);
        border-left: 4px solid;
    }
    
    .alert-warning {
        background: rgba(251, 191, 36, 0.1);
        color: var(--warning-color);
        border-left-color: var(--warning-color);
    }
    
    .alert-info {
        background: rgba(14, 165, 233, 0.1);
        color: var(--info-color);
        border-left-color: var(--info-color);
    }
    
    /* 现代化模态框样式 */
    .modal-content {
        border: none;
        border-radius: var(--radius-xl);
        box-shadow: var(--shadow-xl);
        backdrop-filter: blur(20px);
        background: rgba(255, 255, 255, 0.95);
    }
    
    .modal-header {
        background: rgba(37, 99, 235, 0.05);
        border-bottom: 1px solid rgba(226, 232, 240, 0.5);
        padding: 1.5rem 2rem;
        border-top-left-radius: var(--radius-xl);
        border-top-right-radius: var(--radius-xl);
    }
    
    .modal-title {
        color: #1f2937;
        font-weight: 700;
    }
    
    .modal-body {
        padding: 2rem;
    }
    
    .modal-footer {
        background: rgba(248, 250, 252, 0.8);
        border-top: 1px solid rgba(226, 232, 240, 0.5);
        padding: 1.5rem 2rem;
        border-bottom-left-radius: var(--radius-xl);
        border-bottom-right-radius: var(--radius-xl);
    }
    
    /* 响应式设计优化 */
    @media (max-width: 768px) {
        .news-card .card-body {
            padding: 1.5rem;
        }
        
        .filter-card .card-body {
            padding: 1.5rem;
        }
        
        .event-header {
            padding: 1rem 1.5rem;
            flex-direction: column;
            align-items: flex-start;
            gap: 1rem;
        }
        
        .event-content {
            padding: 1.5rem;
        }
        
        .progress-indicator {
            padding: 0.75rem 1rem;
        }
        
        .progress-text {
            min-width: 100px;
            font-size: 0.8rem;
        }
        
        .scroll-hint {
            min-width: 120px;
            font-size: 0.75rem;
        }
        
        #bottomActionBar .card-body {
            padding: 2rem 1.5rem;
        }
        
        #bottomActionBar .d-flex {
            flex-direction: column;
            gap: 1rem;
            text-align: center;
        }
        
        .btn-lg {
            width: 100%;
            margin-bottom: 1rem;
        }
    }
    
    /* 暗黑模式支持（未来扩展） */
    @media (prefers-color-scheme: dark) {
        :root {
            --dark-color: #f8fafc;
            --light-color: #1e293b;
            --secondary-color: #94a3b8;
        }
    }
    
    /* 动画效果优化 */
    @keyframes fadeInUp {
        from {
            opacity: 0;
            transform: translateY(30px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
    
    .news-card {
        animation: fadeInUp 0.6s ease-out;
    }
    
    .event-group {
        animation: fadeInUp 0.6s ease-out;
    }
    
    /* 性能优化 */
    * {
        box-sizing: border-box;
    }
    
    .news-card,
    .event-group,
    .btn,
    .form-select,
    .form-control {
        will-change: transform;
    }
    
    .news-card .card-text {
        color: #6c757d;
        line-height: 1.5;
    }
    
    .news-card .card-footer {
        background-color: #f8f9fa;
        border-top: 1px solid #dee2e6;
        padding: 0.75rem 1.5rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    
    /* 给页面顶部留出空间避免被进度条遮挡 */
    body {
        padding-top: 0;
        transition: padding-top 0.3s ease;
    }
    
    body.progress-visible {
        padding-top: 60px;
    }
    
    .form-check {
        margin-bottom: 8px;
    }
    
    .form-check-label {
        cursor: pointer;
        transition: all 0.2s ease;
    }
    
    .form-check-label:hover .badge {
        transform: scale(1.05);
    }
    
    .form-check-input:checked+.form-check-label .badge {
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
    }
    
    .category-controls {
        border-top: 1px solid #dee2e6;
        padding-top: 10px;
        margin-top: 10px;
    }
    /* 事件分组样式 */
    
    .event-group {
        margin-bottom: 30px;
        border: 1px solid #e9ecef;
        border-radius: 10px;
        overflow: hidden;
        transition: all 0.3s ease;
    }
    
    .event-group:hover {
        box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
    }
    
    .event-header {
        background-color: #f8f9fa;
        padding: 15px 20px;
        cursor: pointer;
        user-select: none;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    
    .event-header:hover {
        background-color: #e9ecef;
    }
    
    .event-label {
        font-size: 1.1rem;
        font-weight: 600;
        color: #333;
    }
    
    .event-meta {
        display: flex;
        gap: 15px;
        align-items: center;
        font-size: 0.9rem;
        color: #6c757d;
    }
    
    .event-entities {
        margin-top: 10px;
        display: flex;
        flex-wrap: wrap;
        gap: 5px;
    }
    
    .entity-tag {
        background-color: #e7f1ff;
        color: #0066cc;
        padding: 2px 8px;
        border-radius: 12px;
        font-size: 0.85rem;
    }
    
    .event-content {
        padding: 20px;
        background-color: #fff;
    }
    
    .event-content.collapsed {
        display: none;
    }
    
    .primary-news {
        border-left: 4px solid #0d6efd;
        padding-left: 15px;
        margin-bottom: 20px;
    }
    
    .related-news {
        margin-top: 15px;
        padding-top: 15px;
        border-top: 1px solid #e9ecef;
    }
    
    .related-news-item {
        margin-bottom: 10px;
        padding: 10px;
        background-color: #f8f9fa;
        border-radius: 5px;
        position: relative;
    }
    
    .similarity-badge {
        position: absolute;
        top: 10px;
        right: 10px;
        background-color: #28a745;
        color: white;
        padding: 2px 8px;
        border-radius: 12px;
        font-size: 0.75rem;
    }
    
    .toggle-icon {
        transition: transform 0.3s ease;
    }
    
    .toggle-icon.rotated {
        transform: rotate(180deg);
    }
    /* 独立新闻样式 */
    
    .standalone-news {
        margin-bottom: 30px;
    }
    
    .standalone-news .news-card {
        height: 100%;
        display: flex;
        flex-direction: column;
    }
    
    .standalone-news .card-body {
        flex: 1;
    }
    /* 刷新按钮动画 */
    
    @keyframes spin {
        from {
            transform: rotate(0deg);
        }
        to {
            transform: rotate(360deg);
        }
    }
    /* 历史相似文章样式 */
    
    .news-card.opacity-75 {
        opacity: 0.75;
    }
    
    .news-card.border-muted {
        border-color: #6c757d !important;
    }
    
    .news-card.border-muted .card-body {
        background-color: #f8f9fa;
    }
</style>
{% endblock %} {% block content %}
<!-- 滚动进度指示器 -->
<div class="progress-indicator" id="progressIndicator">
    <div class="progress-bar-container">
        <div class="progress-bar" id="progressBar"></div>
    </div>
    <div class="progress-text" id="progressText">
        <span class="current-article">0</span> / <span class="total-articles">0</span> 篇文章
    </div>
    <div class="scroll-hint" id="scrollHint">向下滚动查看更多文章</div>
</div>

<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <h2>今日新闻</h2>
        <p class="text-muted mb-0" id="newsStatsInfo">正在加载新闻统计信息...</p>
    </div>
    <div>
        <button class="btn btn-outline-info btn-sm me-2" data-bs-toggle="tooltip" data-bs-placement="bottom" title="开启事件分组后，系统会自动将描述同一事件的新闻归类在一起，帮助您快速识别重复内容，节省阅读时间">
                <i class="bi bi-info-circle"></i> 功能说明
            </button>
        <button class="btn btn-primary" id="btnGenerateDigest" disabled>
                生成快报 (<span id="selectedCount">0</span>)
            </button>
    </div>
</div>

<div class="row mb-4">
    <div class="col-md-12">
        <div class="card filter-card">
            <div class="card-body">
                <!-- 第一行：分类筛选 -->
                <div class="row mb-3">
                    <div class="col-12">
                        <label class="form-label fw-bold">📊 分类筛选</label>
                        <div class="d-flex flex-wrap gap-2 mb-2">
                            <div class="form-check">
                                <input class="form-check-input category-checkbox" type="checkbox" value="金融业网络安全事件" id="cat-financial" checked>
                                <label class="form-check-label" for="cat-financial">
                                    <span class="badge bg-info">金融业</span>
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input category-checkbox" type="checkbox" value="重大网络安全事件" id="cat-major" checked>
                                <label class="form-check-label" for="cat-major">
                                    <span class="badge bg-danger">重大事件</span>
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input category-checkbox" type="checkbox" value="重大数据泄露事件" id="cat-leak" checked>
                                <label class="form-check-label" for="cat-leak">
                                    <span class="badge bg-warning">数据泄露</span>
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input category-checkbox" type="checkbox" value="重大漏洞风险提示" id="cat-vuln" checked>
                                <label class="form-check-label" for="cat-vuln">
                                    <span class="badge bg-primary">漏洞风险</span>
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input category-checkbox" type="checkbox" value="其他" id="cat-other" checked>
                                <label class="form-check-label" for="cat-other">
                                    <span class="badge bg-secondary">其他</span>
                                </label>
                            </div>
                        </div>
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <button type="button" class="btn btn-sm btn-outline-primary" id="btnSelectAllCategories">全选</button>
                                <button type="button" class="btn btn-sm btn-outline-secondary" id="btnDeselectAllCategories">全不选</button>
                            </div>
                            <small class="text-muted">
                                已选择 <span id="selectedCategoriesCount">5</span>/5 个分类
                            </small>
                        </div>
                    </div>
                </div>

                <hr class="my-3">

                <!-- 第二行：其他筛选选项 -->
                <div class="row">
                    <div class="col-md-3">
                        <label for="timeRange" class="form-label">⏰ 时间范围</label>
                        <select class="form-select" id="timeRange">
                            <option value="24">最近24小时</option>
                            <option value="48">最近48小时</option>
                            <option value="72">最近72小时</option>
                            <option value="168">最近一周</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label for="sourceFilter" class="form-label">📰 指定来源</label>
                        <select class="form-select" id="sourceFilter">
                            <option value="">所有来源</option>
                            <!-- 来源选项将动态加载 -->
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label for="excludeSourceSelect" class="form-label">🚫 排除来源</label>
                        <select class="form-select" id="excludeSourceSelect">
                            <option value="">选择要排除的来源</option>
                            <!-- 排除来源选项将动态加载 -->
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">🎛️ 显示选项</label>
                        <div class="d-flex flex-column gap-1">
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="excludeUsed" checked>
                                <label class="form-check-label" for="excludeUsed">排除已用于快报</label>
                            </div>
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="groupByEvent">
                                <label class="form-check-label" for="groupByEvent">按事件分组</label>
                            </div>
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="separateHistory">
                                <label class="form-check-label" for="separateHistory">分离历史相似</label>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 已排除来源显示区域 -->
                <div class="row mt-3" id="excludedSourcesRow" style="display: none;">
                    <div class="col-12">
                        <div class="alert alert-warning py-2">
                            <div class="d-flex align-items-center justify-content-between">
                                <div>
                                    <i class="bi bi-funnel"></i>
                                    <strong>已排除来源：</strong>
                                    <span id="excludedSourcesList"></span>
                                </div>
                                <button type="button" class="btn btn-sm btn-outline-danger" id="btnClearExcludedSources">
                                    <i class="bi bi-x-circle"></i> 清空
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row" id="newsContainer">
    <!-- 新闻卡片将通过JavaScript动态加载 -->
    <div class="col-12">
        <div class="loading-container text-center">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <div class="mt-3">
                <h5 class="text-muted">正在加载新闻...</h5>
                <p class="text-secondary">请稍候，正在为您获取最新资讯</p>
            </div>
        </div>
    </div>
</div>

<!-- 底部生成快报按钮 -->
<div class="row mt-5 mb-4" id="bottomActionBar" style="display: none;">
    <div class="col-12">
        <div class="card">
            <div class="card-body text-center py-4">
                <div class="d-flex justify-content-center align-items-center gap-3">
                    <i class="bi bi-check-circle-fill text-success" style="font-size: 1.5rem;"></i>
                    <div>
                        <h5 class="mb-1">📖 您已阅读完所有文章</h5>
                        <p class="text-muted mb-0">您可以选择感兴趣的新闻来生成今日快报</p>
                    </div>
                </div>
                <div class="mt-3">
                    <button class="btn btn-primary btn-lg" id="btnGenerateDigestBottom" disabled>
                        <i class="bi bi-file-earmark-text"></i>
                        生成快报 (<span id="selectedCountBottom">0</span>)
                    </button>
                    <button class="btn btn-outline-secondary btn-lg ms-2" onclick="window.scrollTo({top: 0, behavior: 'smooth'})">
                        <i class="bi bi-arrow-up"></i>
                        返回顶部
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 新闻详情模态框 -->
<div class="modal fade" id="newsDetailModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="newsDetailTitle">新闻详情</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="newsDetailContent">
                <!-- 新闻详情将动态加载 -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
                <button type="button" class="btn btn-warning" id="btnProcessInModal">重新处理</button>
                <button type="button" class="btn btn-primary" id="btnSelectInModal">选择此新闻</button>
            </div>
        </div>
    </div>
</div>

<!-- 生成快报模态框 -->
<div class="modal fade" id="generateDigestModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">生成快报</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="digestForm">
                    <div class="mb-3">
                        <label for="digestTitle" class="form-label">快报标题</label>
                        <input type="text" class="form-control" id="digestTitle" value="每日网安情报速递" required>
                    </div>
                    <div class="mb-3">
                        <label for="digestDate" class="form-label">日期</label>
                        <input type="date" class="form-control" id="digestDate" required>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn btn-primary" id="btnConfirmGenerate">生成</button>
            </div>
        </div>
    </div>
</div>
{% endblock %} {% block extra_js %}
<!-- 添加Marked.js库用于Markdown渲染 -->
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<!-- 添加DOMPurify库用于HTML净化，防止XSS攻击 -->
<script src="https://cdn.jsdelivr.net/npm/dompurify@2.3.10/dist/purify.min.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // 设置今天的日期
        const today = new Date();
        document.getElementById('digestDate').valueAsDate = today;

        // 配置marked.js
        marked.setOptions({
            breaks: true, // 转换换行符为<br>
            gfm: true // 启用GitHub风格的Markdown
        });

        // 初始化tooltip
        var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
        var tooltipList = tooltipTriggerList.map(function(tooltipTriggerEl) {
            return new bootstrap.Tooltip(tooltipTriggerEl)
        });

        // 加载新闻源
        loadSources();

        // 加载新闻
        loadNews();

        // 绑定筛选器事件
        document.querySelectorAll('.category-checkbox').forEach(checkbox => {
            checkbox.addEventListener('change', function() {
                updateCategoryCount();
                loadNews();
            });
        });
        document.getElementById('sourceFilter').addEventListener('change', loadNews);
        document.getElementById('timeRange').addEventListener('change', loadNews);
        document.getElementById('excludeUsed').addEventListener('change', loadNews);
        document.getElementById('groupByEvent').addEventListener('change', loadNews);
        document.getElementById('separateHistory').addEventListener('change', loadNews);

        // 绑定排除来源相关事件
        document.getElementById('excludeSourceSelect').addEventListener('change', function() {
            if (this.value) {
                addExcludedSource(this.value, this.options[this.selectedIndex].text);
                this.value = ''; // 重置下拉框
                loadNews();
            }
        });

        document.getElementById('btnClearExcludedSources').addEventListener('click', function() {
            clearAllExcludedSources();
            loadNews();
        });

        // 绑定分类全选/全不选按钮事件
        document.getElementById('btnSelectAllCategories').addEventListener('click', function() {
            document.querySelectorAll('.category-checkbox').forEach(checkbox => {
                checkbox.checked = true;
            });
            updateCategoryCount();
            loadNews();
        });

        document.getElementById('btnDeselectAllCategories').addEventListener('click', function() {
            document.querySelectorAll('.category-checkbox').forEach(checkbox => {
                checkbox.checked = false;
            });
            updateCategoryCount();
            loadNews();
        });

        // 初始化分类计数
        updateCategoryCount();

        // 绑定生成快报按钮事件
        document.getElementById('btnGenerateDigest').addEventListener('click', showGenerateDigestModal);
        document.getElementById('btnGenerateDigestBottom').addEventListener('click', showGenerateDigestModal);
        document.getElementById('btnConfirmGenerate').addEventListener('click', generateDigest);

        // 初始化滚动进度监听器
        initScrollProgress();
    });

    let selectedNews = new Set();
    let currentNewsId = null;
    let excludedSources = new Map(); // 存储排除的来源，key为ID，value为名称
    let totalArticles = 0;
    let articleElements = [];

    // 更新分类选择计数
    function updateCategoryCount() {
        const selectedCount = document.querySelectorAll('.category-checkbox:checked').length;
        const totalCount = document.querySelectorAll('.category-checkbox').length;
        document.getElementById('selectedCategoriesCount').textContent = selectedCount;
    }

    // 添加排除来源
    function addExcludedSource(sourceId, sourceName) {
        excludedSources.set(sourceId, sourceName);
        updateExcludedSourcesDisplay();
        updateExcludeSourceSelect();
    }

    // 移除排除来源
    function removeExcludedSource(sourceId) {
        excludedSources.delete(sourceId);
        updateExcludedSourcesDisplay();
        updateExcludeSourceSelect();
        loadNews();
    }

    // 清空所有排除来源
    function clearAllExcludedSources() {
        excludedSources.clear();
        updateExcludedSourcesDisplay();
        updateExcludeSourceSelect();
    }

    // 更新排除来源显示
    function updateExcludedSourcesDisplay() {
        const excludedRow = document.getElementById('excludedSourcesRow');
        const excludedList = document.getElementById('excludedSourcesList');
        
        if (excludedSources.size > 0) {
            excludedRow.style.display = 'block';
            const tags = Array.from(excludedSources.entries()).map(([id, name]) => 
                `<span class="badge bg-warning text-dark me-1" style="cursor: pointer;" onclick="removeExcludedSource('${id}')">
                    ${name} <i class="bi bi-x"></i>
                </span>`
            ).join('');
            excludedList.innerHTML = tags;
        } else {
            excludedRow.style.display = 'none';
        }
    }

    // 更新排除来源下拉框选项
    function updateExcludeSourceSelect() {
        const excludeSelect = document.getElementById('excludeSourceSelect');
        
        // 清空现有选项（保留默认选项）
        while (excludeSelect.children.length > 1) {
            excludeSelect.removeChild(excludeSelect.lastChild);
        }
        
        // 重新添加可选择的来源（排除已选择的）
        axios.get('/api/sources/')
            .then(response => {
                const sources = response.data;
                sources.forEach(source => {
                    if (!excludedSources.has(source.id.toString())) {
                        const option = document.createElement('option');
                        option.value = source.id;
                        option.textContent = source.name;
                        excludeSelect.appendChild(option);
                    }
                });
            })
            .catch(error => {
                console.error('Error loading sources for exclude select:', error);
            });
    }

    // 加载新闻源
    function loadSources() {
        axios.get('/api/sources/')
            .then(response => {
                const sources = response.data;
                const sourceFilter = document.getElementById('sourceFilter');
                const excludeSourceSelect = document.getElementById('excludeSourceSelect');

                sources.forEach(source => {
                    // 添加到指定来源下拉框
                    const option = document.createElement('option');
                    option.value = source.id;
                    option.textContent = source.name;
                    sourceFilter.appendChild(option);

                    // 添加到排除来源下拉框
                    const excludeOption = document.createElement('option');
                    excludeOption.value = source.id;
                    excludeOption.textContent = source.name;
                    excludeSourceSelect.appendChild(excludeOption);
                });

                // 初始化排除来源显示
                updateExcludedSourcesDisplay();
            })
            .catch(error => {
                console.error('Error loading sources:', error);
                // 可以添加错误提示
                console.log('Failed to load news sources');
            });
    }

    // 加载新闻
    function loadNews() {
        // 获取选中的分类
        const selectedCategories = Array.from(document.querySelectorAll('.category-checkbox:checked'))
            .map(checkbox => checkbox.value);
        const sourceId = document.getElementById('sourceFilter').value;
        const excludedSourceIds = Array.from(excludedSources.keys());
        const hours = document.getElementById('timeRange').value;
        const excludeUsed = document.getElementById('excludeUsed').checked;
        const groupByEvent = document.getElementById('groupByEvent').checked;
        const separateHistory = document.getElementById('separateHistory').checked;

        // 显示加载中
        document.getElementById('newsContainer').innerHTML = `
            <div class="col-12">
                <div class="loading-container text-center">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <div class="mt-3">
                        <h5 class="text-muted">正在加载新闻...</h5>
                        <p class="text-secondary">请稍候，正在筛选符合条件的资讯</p>
                    </div>
                </div>
            </div>
        `;

        // 检查是否选择了分类
        if (selectedCategories.length === 0) {
            // 如果没有选择任何分类，显示提示信息
            document.getElementById('newsContainer').innerHTML = `
                <div class="col-12">
                    <div class="loading-container text-center">
                        <div class="alert alert-info d-inline-block">
                            <i class="bi bi-info-circle me-2"></i> 请至少选择一个分类来查看新闻
                        </div>
                    </div>
                </div>
            `;
                                // 更新统计信息
                    updateNewsStatsInfo(0, 'no-category');
                    updateArticleCount(0);
                    return;
        }

        // 根据显示模式选择不同的API端点
        let baseUrl;
        if (separateHistory) {
            baseUrl = '/api/news/recent/separated';
        } else if (groupByEvent) {
            baseUrl = '/api/news/recent/grouped';
        } else {
            baseUrl = '/api/news/recent';
        }
        let url = `${baseUrl}?hours=${hours}&limit=1000`;

        // 处理多选分类
        selectedCategories.forEach(category => {
            url += `&category=${encodeURIComponent(category)}`;
        });

        if (sourceId) url += `&source_id=${sourceId}`;
        
        // 处理排除来源
        excludedSourceIds.forEach(sourceId => {
            url += `&exclude_source_id=${sourceId}`;
        });
        
        if (excludeUsed) url += `&exclude_used=true`;

        axios.get(url)
            .then(response => {
                const container = document.getElementById('newsContainer');
                container.innerHTML = '';

                if (separateHistory) {
                    // 处理分离显示：今日新文章 vs 与历史相似的文章
                    const {
                        fresh_news,
                        similar_to_history
                    } = response.data;

                    // 显示统计信息
                    container.innerHTML = `
                        <div class="col-12 mb-3">
                            <div class="alert alert-info">
                                <i class="bi bi-info-circle"></i> 
                                共找到 ${fresh_news.total + similar_to_history.total} 条新闻：
                                ${fresh_news.total} 条今日新文章，${similar_to_history.total} 条与历史快报相似
                            </div>
                        </div>
                    `;
                    
                    // 更新页面标题处的统计信息
                    updateNewsStatsInfo(fresh_news.total + similar_to_history.total, 'separated');
                    updateArticleCount(fresh_news.total + similar_to_history.total);

                    // 渲染今日新文章
                    if (fresh_news.total > 0) {
                        const freshHeader = document.createElement('div');
                        freshHeader.className = 'col-12 mb-3';
                        freshHeader.innerHTML = `
                            <h5 class="text-primary">
                                <i class="bi bi-newspaper"></i> 今日新文章 (${fresh_news.total})
                            </h5>
                            <hr>
                        `;
                        container.appendChild(freshHeader);

                        fresh_news.items.forEach(news => {
                            renderNewsCard(news, container);
                        });
                    }

                    // 渲染与历史相似的文章
                    if (similar_to_history.total > 0) {
                        const similarHeader = document.createElement('div');
                        similarHeader.className = 'col-12 mb-3 mt-4';
                        similarHeader.innerHTML = `
                            <h5 class="text-muted">
                                <i class="bi bi-clock-history"></i> 与历史快报相似的文章 (${similar_to_history.total})
                            </h5>
                            <p class="text-muted small mb-2">以下文章与历史快报中的文章相似，可能是重复或相关内容</p>
                            <hr>
                        `;
                        container.appendChild(similarHeader);

                        similar_to_history.items.forEach(news => {
                            renderNewsCard(news, container, true); // 第三个参数标记为历史相似
                        });
                    }

                    // 如果没有任何文章
                    if (fresh_news.total === 0 && similar_to_history.total === 0) {
                        container.innerHTML = `
                            <div class="col-12 text-center py-5">
                                <p class="text-muted">没有找到符合条件的新闻</p>
                            </div>
                        `;
                        // 更新统计信息
                        updateNewsStatsInfo(0, 'separated');
                        updateArticleCount(0);
                    }
                } else if (groupByEvent) {
                    // 处理分组显示
                    const {
                        groups,
                        total_news
                    } = response.data;

                    if (groups.length === 0) {
                        container.innerHTML = `
                            <div class="col-12 text-center py-5">
                                <p class="text-muted">没有找到符合条件的新闻</p>
                            </div>
                        `;
                        // 更新统计信息
                        updateNewsStatsInfo(0, 'grouped');
                        updateArticleCount(0);
                        return;
                    }

                    // 分离独立新闻和事件组
                    const standaloneGroups = groups.filter(group => group.is_standalone);
                    const eventGroups = groups.filter(group => !group.is_standalone);

                    // 显示统计信息
                    container.innerHTML = `
                        <div class="col-12 mb-3">
                            <div class="alert alert-info">
                                <i class="bi bi-info-circle"></i> 
                                共 ${total_news} 条新闻：${standaloneGroups.length} 条独立新闻，${eventGroups.length} 个事件分组
                            </div>
                        </div>
                    `;
                    
                    // 更新页面标题处的统计信息
                    updateNewsStatsInfo(total_news, 'grouped');
                    updateArticleCount(total_news);

                    // 先渲染独立新闻
                    if (standaloneGroups.length > 0) {
                        // 添加独立新闻标题
                        if (eventGroups.length > 0) {
                            const standaloneHeader = document.createElement('div');
                            standaloneHeader.className = 'col-12 mb-3';
                            standaloneHeader.innerHTML = `
                                <h5 class="text-muted">
                                    <i class="bi bi-newspaper"></i> 独立新闻 (${standaloneGroups.length})
                                </h5>
                                <hr>
                            `;
                            container.appendChild(standaloneHeader);
                        }

                        // 渲染独立新闻
                        standaloneGroups.forEach(group => {
                            renderEventGroup(group, 0);
                        });

                        // 如果有事件组，添加分隔符
                        if (eventGroups.length > 0) {
                            const eventHeader = document.createElement('div');
                            eventHeader.className = 'col-12 mb-3 mt-4';
                            eventHeader.innerHTML = `
                                <h5 class="text-muted">
                                    <i class="bi bi-collection"></i> 事件分组 (${eventGroups.length})
                                </h5>
                                <hr>
                            `;
                            container.appendChild(eventHeader);
                        }
                    }

                    // 渲染事件分组
                    eventGroups.forEach((group, index) => {
                        renderEventGroup(group, index);
                    });
                } else {
                    // 处理普通列表显示
                    const {
                        items
                    } = response.data;

                    if (items.length === 0) {
                        container.innerHTML = `
                            <div class="col-12 text-center py-5">
                                <p class="text-muted">没有找到符合条件的新闻</p>
                            </div>
                        `;
                        // 更新统计信息
                        updateNewsStatsInfo(0, 'list');
                        updateArticleCount(0);
                        return;
                    }

                    // 更新页面标题处的统计信息
                    updateNewsStatsInfo(items.length, 'list');
                    updateArticleCount(items.length);
                    
                    // 添加新闻卡片
                    items.forEach(news => {
                        renderNewsCard(news, container);
                    });
                }
            })
            .catch(error => {
                console.error('Error loading news:', error);
                document.getElementById('newsContainer').innerHTML = `
                        <div class="col-12 text-center py-5">
                            <p class="text-danger">加载新闻失败</p>
                        </div>
                    `;
                // 更新统计信息
                updateNewsStatsInfo(0, 'error');
                updateArticleCount(0);
            });
    }

    // 渲染新闻卡片的通用函数
    function renderNewsCard(news, container, isHistorySimilar = false) {
        const isSelected = selectedNews.has(news.id);
        const card = document.createElement('div');
        card.className = 'col-12 mb-3';

        // 为历史相似的文章添加特殊样式
        const cardExtraClasses = isHistorySimilar ? 'opacity-75 border-muted' : '';
        const titlePrefix = isHistorySimilar ? '<i class="bi bi-clock-history text-muted" title="与历史快报相似"></i> ' : '';

        card.innerHTML = `
            <div class="card news-card ${isSelected ? 'selected' : ''} ${cardExtraClasses}" data-id="${news.id}">
                <div class="card-body">
                    <span class="category-badge">${getCategoryBadge(news.category)}</span>
                    <h5 class="card-title">
                        ${titlePrefix}${news.generated_title || news.title}
                        ${news.summary_source ? 
                          (news.summary_source === 'original' 
                            ? '<i class="fas fa-quote-left text-info" title="来自原文摘要"></i>' 
                            : '<i class="fas fa-robot text-primary" title="AI生成总结"></i>') 
                          : ''}
                    </h5>
                    <p class="card-text">${truncateSummary(news.generated_summary || news.summary, 100)}</p>
                </div>
                <div class="card-footer bg-transparent">
                    <small class="text-muted">来源: ${news.source_name || '未知来源'} | ${formatDate(news.created_at)}</small>
                    <div>
                        <button class="btn btn-sm btn-outline-primary btn-view" data-id="${news.id}">查看</button>
                        <button class="btn btn-sm ${isSelected ? 'btn-success' : 'btn-outline-success'} btn-select" data-id="${news.id}">
                            ${isSelected ? '已选择' : '选择'}
                        </button>
                    </div>
                </div>
            </div>
        `;
        container.appendChild(card);

        // 绑定查看按钮事件
        card.querySelector('.btn-view').addEventListener('click', function() {
            viewNews(this.getAttribute('data-id'));
        });

        // 绑定选择按钮事件
        card.querySelector('.btn-select').addEventListener('click', function() {
            toggleSelectNews(this.getAttribute('data-id'));
        });
    }


    // 查看新闻详情
    function viewNews(newsId) {
        currentNewsId = newsId;

        axios.get(`/api/news/${newsId}`)
            .then(response => {
                    const news = response.data;
                    // 添加调试信息
                    console.log('新闻详情数据:', news);
                    console.log('文章总结字段:', news.article_summary);

                    const detailContent = document.getElementById('newsDetailContent');

                    let entitiesHtml = '';
                    if (news.entities) {
                        entitiesHtml = '<div class="mt-3"><h6><strong>提取的实体</strong></h6><ul>';

                        // 检查实体是否为数组格式
                        if (Array.isArray(news.entities)) {
                            news.entities.forEach(entity => {
                                if (typeof entity === 'object' && entity !== null) {
                                    // 处理不同格式的实体对象
                                    if (entity.type && entity.value) {
                                        // 标准格式 {type: "...", value: "..."}
                                        entitiesHtml += `<li><strong>${entity.type}:</strong> ${entity.value}</li>`;
                                    } else {
                                        // 处理其他格式 {key: value}
                                        const entityType = Object.keys(entity)[0] || '未知类型';
                                        const entityValue = entity[entityType] || '未知';
                                        entitiesHtml += `<li><strong>${entityType}:</strong> ${entityValue}</li>`;
                                    }
                                } else {
                                    entitiesHtml += `<li>${entity}</li>`;
                                }
                            });
                        }
                        // 检查实体是否为对象格式
                        else if (typeof news.entities === 'object') {
                            // 检查是否有type和value字段的特殊对象
                            if (news.entities.type && news.entities.value) {
                                entitiesHtml += `<li><strong>${news.entities.type}:</strong> ${news.entities.value}</li>`;
                            } else {
                                // 常规对象格式 {key1: value1, key2: value2}
                                for (const [key, value] of Object.entries(news.entities)) {
                                    if (key !== 'error') {
                                        entitiesHtml += `<li><strong>${key}:</strong> ${value}</li>`;
                                    }
                                }
                            }
                        }

                        entitiesHtml += '</ul></div>';
                    }

                    detailContent.innerHTML = `
                    <h4>${news.title}</h4>
                    <div class="text-muted mb-2">来源: ${news.source_name || '未知来源'} | 时间: ${formatDate(news.created_at)}</div>
                    
                    <div class="card mb-3">
                        <div class="card-header bg-light">原始内容摘要</div>
                        <div class="card-body">
                            <p>${news.summary}</p>
                            <a href="${news.original_url}" target="_blank" class="btn btn-sm btn-outline-primary">查看原文</a>
                        </div>
                    </div>
                    
                    <div class="card mb-3">
                        <div class="card-header bg-light">处理结果</div>
                        <div class="card-body">
                            ${news.is_processed ? `
                                <div class="mb-2"><strong>一句话标题:</strong> ${news.generated_title || '暂无'}</div>
                                <div class="mb-2"><strong>摘要:</strong> ${news.generated_summary || '暂无'}</div>
                                
                                <!-- 显示总结来源 -->
                                <div class="mb-2"><strong>总结来源:</strong> 
                                    ${news.summary_source === 'original' ? 
                                      '<span class="badge bg-info">来自原文摘要</span>' :
                                      news.summary_source === 'generated' ? 
                                      '<span class="badge bg-primary">AI生成</span>' : 
                                      '<span class="badge bg-secondary">未知</span>'}
                                </div>
                                
                                <!-- 详细文章总结部分（增强判断逻辑） -->
                                <div class="mb-2"><strong>文章总结状态:</strong> ${news.article_summary ? '已生成' : '未生成'}</div>
                                ${news.article_summary ? `
                                <div class="card mb-3 mt-3">
                                    <div class="card-header bg-light">详细文章总结</div>
                                    <div class="card-body">
                                        <div class="article-summary markdown-body">${DOMPurify.sanitize(marked.parse(news.article_summary))}</div>
                                    </div>
                                </div>
                                ` : '<div class="alert alert-info mt-2">该新闻还没有生成详细文章总结，请使用"处理"功能重新处理此新闻</div>'}
                                
                                <div class="mb-2"><strong>分类:</strong> ${getCategoryLabel(news.category)}</div>
                                ${entitiesHtml}
                                
                                <!-- 显示tokens使用信息 -->
                                ${news.tokens_usage ? `
                                <div class="card mt-3">
                                    <div class="card-header bg-light">Tokens使用统计</div>
                                    <div class="card-body">
                                        <table class="table table-sm table-striped">
                                            <thead>
                                                <tr>
                                                    <th>处理类型</th>
                                                    <th>Prompt Tokens</th>
                                                    <th>Completion Tokens</th>
                                                    <th>总计</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                ${formatTokensUsage(news.tokens_usage)}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                                ` : ''}
                            ` : '<div class="alert alert-warning">该新闻尚未处理</div>'}
                        </div>
                    </div>
                `;
                
                // 更新选择按钮状态
                const selectBtn = document.getElementById('btnSelectInModal');
                selectBtn.textContent = selectedNews.has(parseInt(newsId)) ? '取消选择' : '选择此新闻';
                
                // 绑定选择按钮事件
                selectBtn.onclick = function() {
                    toggleSelectNews(newsId);
                    this.textContent = selectedNews.has(parseInt(newsId)) ? '取消选择' : '选择此新闻';
                };
                
                // 绑定处理按钮事件
                const processBtn = document.getElementById('btnProcessInModal');
                processBtn.onclick = function() {
                    processNews(newsId);
                };
                
                // 显示模态框
                const modal = new bootstrap.Modal(document.getElementById('newsDetailModal'));
                modal.show();
            })
            .catch(error => {
                console.error('Error loading news details:', error);
                alert('加载新闻详情失败');
            });
    }
    
    // 切换选择新闻
    function toggleSelectNews(newsId) {
        const id = parseInt(newsId);
        
        if (selectedNews.has(id)) {
            selectedNews.delete(id);
        } else {
            selectedNews.add(id);
        }
        
        // 更新选择计数
        document.getElementById('selectedCount').textContent = selectedNews.size;
        document.getElementById('selectedCountBottom').textContent = selectedNews.size;
        
        // 更新生成按钮状态
        document.getElementById('btnGenerateDigest').disabled = selectedNews.size === 0;
        document.getElementById('btnGenerateDigestBottom').disabled = selectedNews.size === 0;
        
        // 更新所有相关按钮的状态（包括事件组中的按钮）
        const allSelectBtns = document.querySelectorAll(`button[data-news-id="${id}"]`);
        allSelectBtns.forEach(btn => {
            btn.classList.toggle('btn-outline-success', !selectedNews.has(id));
            btn.classList.toggle('btn-success', selectedNews.has(id));
            btn.textContent = selectedNews.has(id) ? '已选择' : '选择';
        });
        
        // 更新普通卡片样式（适用于非分组模式和独立新闻）
        const card = document.querySelector(`.news-card[data-id="${id}"]`);
        if (card) {
            card.classList.toggle('selected', selectedNews.has(id));
            
            const selectBtn = card.querySelector('.btn-select');
            if (selectBtn) {
                selectBtn.classList.toggle('btn-outline-success', !selectedNews.has(id));
                selectBtn.classList.toggle('btn-success', selectedNews.has(id));
                selectBtn.textContent = selectedNews.has(id) ? '已选择' : '选择';
            }
        }
    }
    
    // 显示生成快报模态框
    function showGenerateDigestModal() {
        if (selectedNews.size === 0) {
            alert('请至少选择一条新闻');
            return;
        }
        
        // 检查选中的新闻中是否有相似的
        checkSelectedNewsSimilarity();
        
        const modal = new bootstrap.Modal(document.getElementById('generateDigestModal'));
        modal.show();
    }
    
    // 检查选中新闻的相似性
    function checkSelectedNewsSimilarity() {
        // 这里可以通过API检查选中新闻之间的相似度
        // 如果发现高度相似的新闻，提示用户
        // 暂时使用客户端简单检查（实际应该调用后端API）
        console.log('检查选中的 ' + selectedNews.size + ' 条新闻的相似性...');
    }
    
    // 生成快报
    function generateDigest() {
        const title = document.getElementById('digestTitle').value;
        const date = document.getElementById('digestDate').value;
        
        if (!title || !date) {
            alert('请填写完整信息');
            return;
        }
        
        const digestData = {
            title: title,
            date: new Date(date).toISOString(),
            selected_news_ids: Array.from(selectedNews)
        };
        
        axios.post('/api/digest', digestData)
            .then(response => {
                const digestId = response.data.id;
                
                // 关闭模态框
                const modal = bootstrap.Modal.getInstance(document.getElementById('generateDigestModal'));
                modal.hide();
                
                // 清空选择
                selectedNews.clear();
                document.getElementById('selectedCount').textContent = '0';
                document.getElementById('selectedCountBottom').textContent = '0';
                document.getElementById('btnGenerateDigest').disabled = true;
                document.getElementById('btnGenerateDigestBottom').disabled = true;
                
                // 重新加载新闻
                loadNews();
                
                // 跳转到快报页面
                window.location.href = `/digest/${digestId}`;
            })
            .catch(error => {
                console.error('Error generating digest:', error);
                alert('生成快报失败');
            });
    }
    
    // 辅助函数 - 格式化日期
    function formatDate(dateStr) {
        if (!dateStr) return '';
        const date = new Date(dateStr);
        return date.toLocaleString();
    }
    
    // 辅助函数 - 截取摘要文本（控制在100字以内）
    function truncateSummary(text, maxLength = 100) {
        if (!text) return '';
        if (text.length <= maxLength) return text;
        return text.substring(0, maxLength) + '...';
    }
    
    // 辅助函数 - 获取分类标签
    function getCategoryBadge(category) {
        const categories = {
            '金融业网络安全事件': '<span class="badge bg-info">金融业</span>',
            '重大网络安全事件': '<span class="badge bg-danger">重大事件</span>',
            '重大数据泄露事件': '<span class="badge bg-warning">数据泄露</span>',
            '重大漏洞风险提示': '<span class="badge bg-primary">漏洞风险</span>',
            '其他': '<span class="badge bg-secondary">其他</span>'
        };
        
        return categories[category] || categories['其他'];
    }
    
    // 辅助函数 - 获取分类文本
    function getCategoryLabel(category) {
        const categories = {
            '金融业网络安全事件': '金融业网络安全事件',
            '重大网络安全事件': '重大网络安全事件',
            '重大数据泄露事件': '重大数据泄露事件',
            '重大漏洞风险提示': '重大漏洞风险提示',
            '其他': '其他'
        };
        
        return categories[category] || '其他';
    }
    
    // 处理新闻
    function processNews(newsId) {
        const processBtn = document.getElementById('btnProcessInModal');
        processBtn.disabled = true;
        processBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> 处理中...';
        
        axios.post(`/api/news/${newsId}/process`)
            .then(response => {
                console.log('新闻处理完成:', response.data);
                alert('新闻处理完成，将重新加载详情');
                // 重新加载新闻详情
                viewNews(newsId);
            })
            .catch(error => {
                console.error('Error processing news:', error);
                alert('处理新闻失败: ' + (error.response?.data?.detail || error.message));
            })
            .finally(() => {
                processBtn.disabled = false;
                processBtn.innerHTML = '重新处理';
            });
    }

    // 渲染事件分组
    function renderEventGroup(group, index) {
        const container = document.getElementById('newsContainer');
        
        // 检查是否为独立新闻
        if (group.is_standalone) {
            // 独立新闻以简洁的卡片形式显示
            renderStandaloneNews(group.primary);
            return;
        }
        
        const groupEl = document.createElement('div');
        groupEl.className = 'col-12';
        
        // 获取关键实体用于显示
        const keyEntities = [];
        if (group.entities.CVE && group.entities.CVE.length > 0) {
            keyEntities.push(...group.entities.CVE.slice(0, 2));
        }
        if (group.entities['组织'] && group.entities['组织'].length > 0) {
            keyEntities.push(...group.entities['组织'].slice(0, 2));
        }
        if (group.entities['产品'] && group.entities['产品'].length > 0) {
            keyEntities.push(...group.entities['产品'].slice(0, 1));
        }
        
        const isExpanded = true; // 默认展开所有事件组
        
        groupEl.innerHTML = `
            <div class="event-group" data-group-id="${group.id}">
                <div class="event-header" onclick="toggleEventGroup('${group.id}')">
                    <div>
                        <div class="event-label">
                            <i class="bi bi-collection"></i> ${group.event_label}
                        </div>
                        <div class="event-entities">
                            ${keyEntities.map(entity => `<span class="entity-tag">${entity}</span>`).join('')}
                        </div>
                    </div>
                    <div class="event-meta">
                        <span><i class="bi bi-newspaper"></i> ${group.news_count} 篇报道</span>
                        <span><i class="bi bi-broadcast"></i> ${group.sources.length} 个来源</span>
                        <i class="bi bi-chevron-down toggle-icon ${isExpanded ? '' : 'rotated'}"></i>
                    </div>
                </div>
                <div class="event-content ${isExpanded ? '' : 'collapsed'}" id="content-${group.id}">
                    <div class="primary-news">
                        <h5>
                            ${group.primary.generated_title || group.primary.title}
                            <span class="badge bg-primary">主要新闻</span>
                        </h5>
                        <p>${(group.primary.generated_summary || group.primary.summary).substring(0, 200)}...</p>
                        <div class="mt-2">
                            <small class="text-muted">
                                来源: ${group.primary.source_name || '未知来源'} | ${formatDate(group.primary.created_at)}
                            </small>
                            <button class="btn btn-sm btn-outline-primary float-end me-2" onclick="viewNews(${group.primary.id})">
                                查看详情
                            </button>
                            <button class="btn btn-sm ${selectedNews.has(group.primary.id) ? 'btn-success' : 'btn-outline-success'} float-end me-2" 
                                    data-news-id="${group.primary.id}" onclick="toggleSelectNews(${group.primary.id})">
                                ${selectedNews.has(group.primary.id) ? '已选择' : '选择'}
                            </button>
                        </div>
                    </div>
                    
                    ${group.related.length > 0 ? `
                        <div class="related-news">
                            <h6 class="text-muted mb-3">相关报道 (${group.related.length})</h6>
                            ${group.related.map(news => `
                                <div class="related-news-item">
                                    <div class="similarity-badge">${Math.round(group.similarity_scores[news.id] * 100)}% 相似</div>
                                    <h6>${news.generated_title || news.title}</h6>
                                    <small class="text-muted">
                                        来源: ${news.source_name || '未知来源'} | ${formatDate(news.created_at)}
                                    </small>
                                    <div class="mt-2">
                                        <button class="btn btn-sm btn-outline-primary me-2" onclick="viewNews(${news.id})">
                                            查看
                                        </button>
                                        <button class="btn btn-sm ${selectedNews.has(news.id) ? 'btn-success' : 'btn-outline-success'}" 
                                                data-news-id="${news.id}" onclick="toggleSelectNews(${news.id})">
                                            ${selectedNews.has(news.id) ? '已选择' : '选择'}
                                        </button>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    ` : ''}
                </div>
            </div>
        `;
        
        container.appendChild(groupEl);
    }
    
    // 渲染独立新闻
    function renderStandaloneNews(news) {
        const container = document.getElementById('newsContainer');
        const isSelected = selectedNews.has(news.id);
        
        // 创建独立新闻卡片
        const newsCard = document.createElement('div');
        newsCard.className = 'col-12 mb-3';
        newsCard.innerHTML = `
            <div class="card news-card ${isSelected ? 'selected' : ''}" data-id="${news.id}">
                <div class="card-body">
                    <span class="category-badge">${getCategoryBadge(news.category)}</span>
                    <h5 class="card-title">
                        ${news.generated_title || news.title}
                    </h5>
                    <p class="card-text">${truncateSummary(news.generated_summary || news.summary, 100)}</p>
                </div>
                <div class="card-footer bg-transparent">
                    <small class="text-muted">来源: ${news.source_name || '未知来源'} | ${formatDate(news.created_at)}</small>
                    <div>
                        <button class="btn btn-sm btn-outline-primary btn-view" onclick="viewNews(${news.id})">查看</button>
                        <button class="btn btn-sm ${isSelected ? 'btn-success' : 'btn-outline-success'} btn-select" data-news-id="${news.id}" onclick="toggleSelectNews(${news.id})">
                            ${isSelected ? '已选择' : '选择'}
                        </button>
                    </div>
                </div>
            </div>
        `;
        
        // 查找或创建独立新闻容器行
        let standaloneRow = container.querySelector('.row.standalone-news');
        if (!standaloneRow) {
            standaloneRow = document.createElement('div');
            standaloneRow.className = 'row standalone-news';
            container.appendChild(standaloneRow);
        }
        
        standaloneRow.appendChild(newsCard);
    }
    
    // 切换事件组展开/折叠
    function toggleEventGroup(groupId) {
        const content = document.getElementById(`content-${groupId}`);
        const icon = document.querySelector(`[data-group-id="${groupId}"] .toggle-icon`);
        
        if (content.classList.contains('collapsed')) {
            content.classList.remove('collapsed');
            icon.classList.remove('rotated');
        } else {
            content.classList.add('collapsed');
            icon.classList.add('rotated');
        }
    }
    
    // 更新新闻统计信息的函数
    function updateNewsStatsInfo(totalNews, mode) {
        const statsEl = document.getElementById('newsStatsInfo');
        if (!statsEl) return;
        
        let modeText = '';
                 switch(mode) {
            case 'list':
                modeText = '列表模式';
                break;
            case 'grouped':
                modeText = '分组模式';
                break;
            case 'separated':
                modeText = '分离模式';
                break;
            case 'error':
                modeText = '加载失败';
                break;
            case 'no-category':
                modeText = '未选择分类';
                break;
            default:
                modeText = '未知模式';
                break;
        }
        
        statsEl.textContent = `当前显示 ${totalNews} 条新闻 (${modeText})`;
    }

    // 辅助函数 - 格式化tokens使用信息
    function formatTokensUsage(tokensUsage) {
        if (!tokensUsage) return '';
        
        let html = '';
        let totalPromptTokens = 0;
        let totalCompletionTokens = 0;
        let totalTokens = 0;
        
        // 处理类型映射表，将后端字段映射为可读的名称
        const typeLabels = {
            'title_translation': '标题翻译',
            'summary_translation': '摘要翻译',
            'content_translation': '内容翻译',
            'article_summary': '文章总结',
            'category': '分类',
            'entities': '实体提取'
        };
        
        for (const [type, usage] of Object.entries(tokensUsage)) {
            if (!usage) continue;
            
            // 获取tokens数量，处理不同格式的usage对象
            let promptTokens = 0;
            let completionTokens = 0;
            let tokensSum = 0;
            
            if (typeof usage === 'object') {
                // 处理标准格式
                promptTokens = usage.prompt_tokens || 0;
                completionTokens = usage.completion_tokens || 0;
                tokensSum = usage.total_tokens || (promptTokens + completionTokens);
                
                // 累计总数
                totalPromptTokens += promptTokens;
                totalCompletionTokens += completionTokens;
                totalTokens += tokensSum;
                
                // 生成表格行
                const label = typeLabels[type] || type;
                html += `
                    <tr>
                        <td>${label}</td>
                        <td>${promptTokens}</td>
                        <td>${completionTokens}</td>
                        <td>${tokensSum}</td>
                    </tr>
                `;
            }
        }
        
        // 添加总计行
        html += `
            <tr class="table-primary">
                <td><strong>总计</strong></td>
                <td><strong>${totalPromptTokens}</strong></td>
                <td><strong>${totalCompletionTokens}</strong></td>
                <td><strong>${totalTokens}</strong></td>
            </tr>
        `;
        
        return html;
    }

    // 初始化滚动进度功能
    function initScrollProgress() {
        const progressIndicator = document.getElementById('progressIndicator');
        const progressBar = document.getElementById('progressBar');
        const currentArticleSpan = document.querySelector('.current-article');
        const totalArticlesSpan = document.querySelector('.total-articles');
        const scrollHint = document.getElementById('scrollHint');

        let scrollTimeout;

        window.addEventListener('scroll', function() {
            clearTimeout(scrollTimeout);
            
            // 显示进度条
            if (window.scrollY > 100) {
                progressIndicator.classList.add('visible');
                document.body.classList.add('progress-visible');
            } else {
                progressIndicator.classList.remove('visible');
                document.body.classList.remove('progress-visible');
            }

            // 更新进度
            updateScrollProgress();

            // 延迟隐藏滚动提示
            scrollTimeout = setTimeout(() => {
                if (scrollHint) {
                    scrollHint.style.opacity = '0.5';
                }
            }, 2000);
        });

        // 鼠标悬停时显示滚动提示
        progressIndicator.addEventListener('mouseenter', function() {
            if (scrollHint) {
                scrollHint.style.opacity = '1';
            }
        });
    }

    // 更新滚动进度
    function updateScrollProgress() {
        const progressBar = document.getElementById('progressBar');
        const currentArticleSpan = document.querySelector('.current-article');
        
        if (articleElements.length === 0) {
            return;
        }

        let currentArticle = 0;
        const viewportHeight = window.innerHeight;
        const scrollTop = window.scrollY;

        // 计算当前可见的文章数量
        articleElements.forEach((element, index) => {
            const rect = element.getBoundingClientRect();
            const elementTop = scrollTop + rect.top;
            
            // 如果文章的顶部已经滚过视口中心，则认为已读
            if (elementTop < scrollTop + viewportHeight / 2) {
                currentArticle = index + 1;
            }
        });

        // 更新进度条
        const progress = (currentArticle / totalArticles) * 100;
        progressBar.style.width = `${progress}%`;
        
        // 更新文字
        currentArticleSpan.textContent = currentArticle;
        
        // 更新滚动提示
        const scrollHint = document.getElementById('scrollHint');
        const remaining = totalArticles - currentArticle;
        if (remaining > 0) {
            scrollHint.textContent = `还有 ${remaining} 篇文章未阅读`;
        } else {
            scrollHint.textContent = '已阅读完所有文章';
        }
    }

    // 更新文章计数（在加载新闻时调用）
    function updateArticleCount(total) {
        totalArticles = total;
        document.querySelector('.total-articles').textContent = total;
        
        // 显示或隐藏底部操作栏
        const bottomActionBar = document.getElementById('bottomActionBar');
        if (total > 0) {
            bottomActionBar.style.display = 'block';
        } else {
            bottomActionBar.style.display = 'none';
        }
        
        // 更新文章元素列表
        setTimeout(() => {
            articleElements = Array.from(document.querySelectorAll('.news-card, .event-group'));
            updateScrollProgress();
        }, 100);
    }
</script>
{% endblock %}