{% extends "base.html" %}

{% block title %}今日新闻 - 每日安全快报系统{% endblock %}

{% block extra_css %}
<!-- 新闻页面专用样式 -->
<link rel="stylesheet" href="{{ url_for('static', path='/css/news.css') }}">
{% endblock %}

{% block content %}
<!-- 滚动进度指示器 -->
<div class="progress-indicator" id="progressIndicator">
    <div class="progress-bar-container">
        <div class="progress-bar" id="progressBar"></div>
    </div>
    <div class="progress-text" id="progressText">
        <span class="current-article">0</span> / <span class="total-articles">0</span> 篇文章
    </div>
    <div class="scroll-hint" id="scrollHint">向下滚动查看更多文章</div>
</div>

<div class="alert alert-info" role="alert">
    <strong>提示:</strong> 对于可能涉及境外的产品的高分漏洞需要放入快报，内容尽量包括漏洞编号、漏洞危害、影响版本、利用条件等。
</div>

<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <h2>今日新闻</h2>
        <p class="text-muted mb-0" id="newsStatsInfo">正在加载新闻统计信息...</p>
    </div>
    <div>
        <button class="btn btn-outline-info btn-sm me-2" data-bs-toggle="tooltip" data-bs-placement="bottom" title="系统提供多种筛选和显示选项，帮助您快速找到需要的新闻内容">
            <i class="bi bi-info-circle"></i> 功能说明
        </button>
        <button class="btn btn-primary" id="btnGenerateDigest" disabled>
            生成快报 (<span id="selectedCount">0</span>)
        </button>
    </div>
</div>

<div class="row mb-4">
    <div class="col-md-12">
        <div class="card filter-card">
            <div class="card-body">
                <!-- 第一行：分类筛选 -->
                <div class="row mb-3">
                    <div class="col-12">
                        <label class="form-label fw-bold">📊 分类筛选</label>
                        <div class="d-flex flex-wrap gap-2 mb-2">
                            <div class="form-check">
                                <input class="form-check-input category-checkbox" type="checkbox" value="金融业网络安全事件" id="cat-financial" checked>
                                <label class="form-check-label" for="cat-financial">
                                    <span class="badge bg-info">金融业</span>
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input category-checkbox" type="checkbox" value="重大网络安全事件" id="cat-major" checked>
                                <label class="form-check-label" for="cat-major">
                                    <span class="badge bg-danger">重大事件</span>
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input category-checkbox" type="checkbox" value="重大数据泄露事件" id="cat-leak" checked>
                                <label class="form-check-label" for="cat-leak">
                                    <span class="badge bg-warning">数据泄露</span>
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input category-checkbox" type="checkbox" value="重大漏洞风险提示" id="cat-vuln" checked>
                                <label class="form-check-label" for="cat-vuln">
                                    <span class="badge bg-primary">漏洞风险</span>
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input category-checkbox" type="checkbox" value="其他" id="cat-other">
                                <label class="form-check-label" for="cat-other">
                                    <span class="badge bg-secondary">其他</span>
                                </label>
                            </div>
                        </div>
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <button type="button" class="btn btn-sm btn-outline-primary" id="btnSelectAllCategories">全选</button>
                                <button type="button" class="btn btn-sm btn-outline-secondary" id="btnDeselectAllCategories">全不选</button>
                            </div>
                            <small class="text-muted">
                                已选择 <span id="selectedCategoriesCount">5</span>/5 个分类
                            </small>
                        </div>
                    </div>
                </div>

                <hr class="my-3">

                <!-- 第二行：其他筛选选项 -->
                <div class="row">
                    <div class="col-md-3">
                        <label for="timeRange" class="form-label">⏰ 时间范围</label>
                        <select class="form-select" id="timeRange">
                            <option value="24">最近24小时</option>
                            <option value="48">最近48小时</option>
                            <option value="72">最近72小时</option>
                            <option value="168">最近一周</option>
                            <option value="since_yesterday_digest" selected>自昨天生成快报以后</option>
                        </select>
                        <small class="text-muted mt-1" id="timeRangeDescription" style="display: none;"></small>
                    </div>
                    <div class="col-md-3">
                        <label for="sourceFilter" class="form-label">📰 指定来源</label>
                        <select class="form-select" id="sourceFilter">
                            <option value="">所有来源</option>
                            <!-- 来源选项将动态加载 -->
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label for="excludeSourceSelect" class="form-label">🚫 排除来源</label>
                        <select class="form-select" id="excludeSourceSelect">
                            <option value="">选择要排除的来源</option>
                            <!-- 排除来源选项将动态加载 -->
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">🎛️ 显示选项</label>
                        <div class="d-flex flex-column gap-1">
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="excludeUsed">
                                <label class="form-check-label" for="excludeUsed">排除已用于快报</label>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 已排除来源显示区域 -->
                <div class="row mt-3" id="excludedSourcesRow" style="display: none;">
                    <div class="col-12">
                        <div class="alert alert-warning py-2">
                            <div class="d-flex align-items-center justify-content-between">
                                <div>
                                    <i class="bi bi-funnel"></i>
                                    <strong>已排除来源：</strong>
                                    <span id="excludedSourcesList"></span>
                                </div>
                                <button type="button" class="btn btn-sm btn-outline-danger" id="btnClearExcludedSources">
                                    <i class="bi bi-x-circle"></i> 清空
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row" id="newsContainer">
    <!-- 新闻卡片将通过JavaScript动态加载 -->
    <div class="col-12">
        <div class="loading-container text-center">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <div class="mt-3">
                <h5 class="text-muted">正在加载新闻...</h5>
                <p class="text-secondary">请稍候，正在为您获取最新资讯</p>
            </div>
        </div>
    </div>
</div>

<!-- 底部生成快报按钮 -->
<div class="row mt-5 mb-4" id="bottomActionBar" style="display: none;">
    <div class="col-12">
        <div class="card">
            <div class="card-body text-center py-4">
                <div class="d-flex justify-content-center align-items-center gap-3">
                    <i class="bi bi-check-circle-fill text-success" style="font-size: 1.5rem;"></i>
                    <div>
                        <h5 class="mb-1">📖 您已阅读完所有文章</h5>
                        <p class="text-muted mb-0">您可以选择感兴趣的新闻来生成今日快报</p>
                    </div>
                </div>
                <div class="mt-3">
                    <button class="btn btn-primary btn-lg" id="btnGenerateDigestBottom" disabled>
                        <i class="bi bi-file-earmark-text"></i>
                        生成快报 (<span id="selectedCountBottom">0</span>)
                    </button>
                    <button class="btn btn-outline-secondary btn-lg ms-2" onclick="window.scrollTo({top: 0, behavior: 'smooth'})">
                        <i class="bi bi-arrow-up"></i>
                        返回顶部
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 新闻详情模态框 -->
<div class="modal fade" id="newsDetailModal" tabindex="-1" aria-labelledby="newsDetailTitle" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="newsDetailTitle">新闻详情</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="关闭"></button>
            </div>
            <div class="modal-body" id="newsDetailContent">
                <!-- 新闻详情将动态加载 -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
                <button type="button" class="btn btn-warning" id="btnProcessInModal">重新处理</button>
                <button type="button" class="btn btn-primary" id="btnSelectInModal">选择此新闻</button>
            </div>
        </div>
    </div>
</div>

<!-- 生成快报模态框 -->
<div class="modal fade" id="generateDigestModal" tabindex="-1" aria-labelledby="generateDigestTitle" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="generateDigestTitle">生成快报</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="关闭"></button>
            </div>
            <div class="modal-body">
                <form id="digestForm">
                    <div class="mb-3">
                        <label for="digestTitle" class="form-label">快报标题</label>
                        <input type="text" class="form-control" id="digestTitle" value="每日网安情报速递" required>
                    </div>
                    <div class="mb-3">
                        <label for="digestDate" class="form-label">日期</label>
                        <input type="date" class="form-control" id="digestDate" required>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn btn-primary" id="btnConfirmGenerate">生成</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- Markdown渲染库 - 异步加载非关键资源 -->
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js" defer></script>
<!-- HTML净化库 - 防止XSS攻击 -->
<script src="https://cdn.jsdelivr.net/npm/dompurify@2.3.10/dist/purify.min.js" defer></script>
<!-- 新闻页面专用脚本 -->
<script src="{{ url_for('static', path='/js/news.js') }}?v=20251030b" defer></script>
{% endblock %}
