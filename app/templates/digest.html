{% extends "base.html" %} {% block title %}快报 - 每日安全快报系统{% endblock %} {% block extra_css %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/easymde@2.18.0/dist/easymde.min.css">
<link rel="stylesheet" href="{{ url_for('static', path='css/github-pdf.css') }}">
<style>
    .digest-preview {
        border: 1px solid #dee2e6;
        border-radius: 0.25rem;
        padding: 1rem;
        background-color: #fff;
        min-height: 500px;
        overflow-y: auto;
        font-family: 'Source Han Sans', 'Noto Sans CJK SC', 'Microsoft YaHei', 'WenQuanYi Micro Hei', "Open Sans", "Clear Sans", "Helvetica Neue", Helvetica, Arial, 'Segoe UI Emoji', sans-serif;
        color: rgb(51, 51, 51);
        line-height: 1.6;
    }
    
    .digest-card {
        transition: all 0.3s;
    }
    
    .digest-card:hover {
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
    }
    
    .CodeMirror {
        height: 500px !important;
        font-family: 'Source Han Sans', 'Noto Sans CJK SC', 'Microsoft YaHei', 'WenQuanYi Micro Hei', 'Consolas', 'Monaco', 'Courier New', monospace !important;
    }
    
    .editor-preview-section {
        display: flex;
        gap: 15px;
        height: 600px;
    }
    
    .editor-section,
    .preview-section {
        flex: 1;
    }
    
    .preview-section {
        border: 1px solid #dee2e6;
        border-radius: 0.25rem;
        padding: 0;
        background-color: #fff;
    }
    
    .preview-header {
        background-color: #f8f9fa;
        padding: 10px 15px;
        border-bottom: 1px solid #dee2e6;
        font-weight: bold;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    
    .preview-content {
        padding: 15px;
        height: calc(100% - 50px);
        overflow-y: auto;
    }

    /* 编辑模式选择器 */
    .edit-mode-selector {
        background: #f8f9fa;
        border-radius: 8px;
        padding: 4px;
        margin-bottom: 15px;
        display: flex;
        gap: 2px;
    }

    .edit-mode-btn {
        flex: 1;
        border: none;
        background: transparent;
        padding: 8px 16px;
        border-radius: 6px;
        font-size: 14px;
        font-weight: 500;
        transition: all 0.2s;
        cursor: pointer;
    }

    .edit-mode-btn.active {
        background: white;
        color: #2563eb;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    }

    .edit-mode-btn:not(.active) {
        color: #64748b;
    }

    .edit-mode-btn:hover:not(.active) {
        background: #e2e8f0;
    }

    /* 可视化编辑器样式 */
    .visual-editor {
        min-height: 500px;
        background: white;
        border: 1px solid #dee2e6;
        border-radius: 0.25rem;
        padding: 20px;
        font-family: 'Source Han Sans', 'Noto Sans CJK SC', 'Microsoft YaHei', 'WenQuanYi Micro Hei', sans-serif;
    }

    .digest-title-editor {
        border: none;
        font-size: 28px;
        font-weight: bold;
        text-align: center;
        margin-bottom: 30px;
        background: transparent;
        width: 100%;
        padding: 10px;
        border-bottom: 2px solid transparent;
        transition: border-color 0.2s;
    }

    .digest-title-editor:focus {
        outline: none;
        border-bottom-color: #2563eb;
    }

    .category-section {
        margin-bottom: 30px;
        border-bottom: 2px solid #e5e7eb;
        padding-bottom: 20px;
    }

    .category-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
    }

    .category-title {
        font-size: 20px;
        font-weight: bold;
        color: #1f2937;
        margin: 0;
    }

    .add-news-btn {
        background: #2563eb;
        color: white;
        border: none;
        border-radius: 6px;
        padding: 6px 12px;
        font-size: 14px;
        cursor: pointer;
        transition: background-color 0.2s;
    }

    .add-news-btn:hover {
        background: #1d4ed8;
    }

    .news-item {
        background: #f9fafb;
        border: 1px solid #e5e7eb;
        border-radius: 8px;
        padding: 16px;
        margin-bottom: 12px;
        transition: all 0.2s;
        position: relative;
    }

    .news-item:hover {
        border-color: #2563eb;
        box-shadow: 0 2px 8px rgba(37, 99, 235, 0.1);
    }

    .news-title-input {
        border: none;
        font-size: 16px;
        font-weight: 600;
        background: transparent;
        width: 100%;
        margin-bottom: 8px;
        padding: 8px;
        border-radius: 4px;
        transition: background-color 0.2s;
    }

    .news-title-input:focus {
        outline: none;
        background: white;
        box-shadow: 0 0 0 2px rgba(37, 99, 235, 0.1);
    }

    .news-summary-input {
        border: none;
        background: transparent;
        width: 100%;
        resize: vertical;
        min-height: 120px;
        padding: 8px;
        border-radius: 4px;
        font-size: 14px;
        line-height: 1.5;
        transition: background-color 0.2s;
            /* 移动端文本选择与触摸优化 */
            -webkit-user-select: text;
            user-select: text;
            touch-action: manipulation;
    }

    .news-summary-input:focus {
        outline: none;
        background: white;
        box-shadow: 0 0 0 2px rgba(37, 99, 235, 0.1);
    }

    .news-category-select {
        border: 1px solid #d1d5db;
        background: transparent;
        border-radius: 4px;
        font-size: 13px;
        transition: all 0.2s;
    }

    .news-category-select:focus {
        outline: none;
        border-color: #2563eb;
        box-shadow: 0 0 0 2px rgba(37, 99, 235, 0.1);
        background: white;
    }

    .news-item .form-label {
        margin-bottom: 4px;
        font-size: 11px;
        font-weight: 500;
    }

    .news-actions {
        position: absolute;
        top: 12px;
        right: 12px;
        display: flex;
        gap: 6px;
        opacity: 0;
        transition: opacity 0.2s;
    }

    .news-item:hover .news-actions {
        opacity: 1;
    }

    .news-action-btn {
        background: white;
        border: 1px solid #d1d5db;
        border-radius: 4px;
        width: 28px;
        height: 28px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all 0.2s;
        font-size: 12px;
    }

    .news-action-btn:hover {
        background: #f3f4f6;
    }

    .news-action-btn.delete:hover {
        background: #fef2f2;
        border-color: #fca5a5;
        color: #dc2626;
    }

    .empty-category {
        color: #6b7280;
        font-style: italic;
        text-align: center;
        padding: 20px;
        background: #f9fafb;
        border: 2px dashed #d1d5db;
        border-radius: 8px;
    }

    /* 移动设备切换按钮 */
    .mobile-toggle-buttons {
        display: none;
        margin-bottom: 15px;
    }
    
    .mobile-toggle-buttons .btn {
        flex: 1;
    }
    
    /* 移动设备响应式设计 */
    @media (max-width: 768px) {
        .news-summary-input {
            font-size: 16px !important;  /* 防止 iOS 自动缩放 */
            line-height: 1.6 !important;
            -webkit-tap-highlight-color: rgba(0, 0, 0, 0.1);
        }
        
        .news-title-input {
            font-size: 16px !important;  /* 同样处理标题输入框 */
        }
        /* 在移动设备上显示切换按钮 */
        .mobile-toggle-buttons {
            display: flex;
            gap: 10px;
        }
        
        /* 编辑器和预览区域在移动设备上垂直排列 */
        .editor-preview-section {
            flex-direction: column;
            height: auto;
            min-height: 70vh;
        }
        
        /* 初始状态下隐藏预览，只显示编辑器 */
        .preview-section {
            display: none;
        }
        
        .editor-section.mobile-hidden {
            display: none;
        }
        
        .preview-section.mobile-visible {
            display: block;
        }
        
        /* 调整编辑器高度 */
        .CodeMirror {
            height: 60vh !important;
        }
        
        /* 预览区域高度 */
        .preview-section {
            min-height: 60vh;
        }
        
        .preview-content {
            height: calc(60vh - 50px);
        }
        
        /* 可视化编辑器移动优化 */
        .visual-editor {
            padding: 15px;
            min-height: 60vh;
        }

        .digest-title-editor {
            font-size: 24px;
        }

        .category-title {
            font-size: 18px;
        }

        .news-actions {
            opacity: 1; /* 移动设备上始终显示操作按钮 */
        }
        
        /* 模态框在移动设备上全屏显示 */
        .modal-dialog.modal-xl {
            margin: 0;
            max-width: 100%;
            height: 100dvh;
        }
        
        .modal-content {
            height: 100dvh;
            border-radius: 0;
            display: flex;
            flex-direction: column;
        }
        
        .modal-body {
            flex: 1 1 auto;
            overflow-y: auto;
            padding: 15px;
            /* 移除 overscroll-behavior 以避免与 fixed footer 冲突 */
            -webkit-overflow-scrolling: touch;
            /* 为底部固定按钮预留更多空间 */
            padding-bottom: calc(100px + env(safe-area-inset-bottom));
            /* 防止触摸穿透与分层 */
            position: relative;
            z-index: 1;
        }
        
        /* 优化表单标签显示 */
        .editor-section .form-label {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
    }
    
    /* 平板设备优化 */
    @media (min-width: 769px) and (max-width: 1024px) {
        .editor-preview-section {
            height: 500px;
        }
        
        .CodeMirror {
            height: 400px !important;
        }
        
        .preview-content {
            height: calc(100% - 50px);
        }
    }
    
    /* 触摸设备优化 */
    @media (max-width: 768px) {
        /* 增加按钮触摸区域 */
        .mobile-toggle-buttons .btn {
            padding: 12px 16px;
            font-size: 16px;
            touch-action: manipulation;
        }
        
        /* 优化编辑器字体 */
        .CodeMirror {
            font-family: 'Source Han Sans', 'Noto Sans CJK SC', 'Microsoft YaHei', 'WenQuanYi Micro Hei', 'Consolas', 'Monaco', 'Courier New', monospace !important;
            font-size: 14px !important;
            line-height: 1.6 !important;
        }
        
        /* 优化预览字体 */
        .github-preview {
            font-family: 'Source Han Sans', 'Noto Sans CJK SC', 'Microsoft YaHei', 'WenQuanYi Micro Hei', sans-serif !important;
            font-size: 14px;
            line-height: 1.7;
        }
        
        /* 防止意外缩放 */
        input, textarea, select {
            font-size: 16px !important;
        }
        
        /* 优化滚动 */
        .CodeMirror-scroll,
        .preview-content {
            -webkit-overflow-scrolling: touch;
        }
        
        /* 改善表单输入体验 */
        #editDigestTitleInput {
            font-size: 16px !important;
            padding: 12px;
        }
        
        /* 调整模态框标题栏高度 */
        .modal-header {
            padding: 12px 16px;
        }
        
        .modal-footer {
            position: fixed;  /* 从 sticky 改为 fixed */
            bottom: 0;
            left: 0;
            right: 0;
            background: #fff;
            border-top: 1px solid #dee2e6;
            z-index: 1050;  /* 提高层级,确保在模态框之上 */
            padding: 12px 16px;
            /* 适配 iOS 安全区 */
            padding-bottom: calc(12px + env(safe-area-inset-bottom));
            /* 添加触摸优化 */
            touch-action: manipulation;
            pointer-events: auto;
        }
        
        /* 改善按钮组布局 */
        .modal-footer {
            flex-wrap: wrap;
            gap: 8px;
        }
        
        .modal-footer .btn {
            flex: 1;
            min-width: 80px;
            min-height: 44px;  /* iOS 推荐的最小触摸目标 */
            touch-action: manipulation;
            -webkit-tap-highlight-color: rgba(0, 0, 0, 0.1);
            position: relative;
            z-index: 10;
        }

        /* 防止外层页面与模态产生滚动冲突 */
        .modal {
            overscroll-behavior: contain;
        }
    }
    /* GitHub样式预览 */
    
    .github-preview {
        font-family: 'Source Han Sans', 'Noto Sans CJK SC', 'Microsoft YaHei', 'WenQuanYi Micro Hei', "Open Sans", "Clear Sans", "Helvetica Neue", Helvetica, Arial, 'Segoe UI Emoji', sans-serif;
        color: rgb(51, 51, 51);
        line-height: 1.6;
    }
    
    .github-preview h1 {
        font-size: 2.25em;
        line-height: 1.2;
        border-bottom: 1px solid #eee;
        padding-bottom: 0.3em;
        text-align: center;
        margin-bottom: 2rem;
        font-weight: bold;
    }
    
    .github-preview h3 {
        font-size: 1.5em;
        line-height: 1.43;
        border-bottom: 1px solid #eee;
        padding-bottom: 0.3em;
        margin-top: 1rem;
        margin-bottom: 1rem;
        font-weight: bold;
    }
    
    .github-preview hr {
        height: 2px;
        padding: 0;
        margin: 16px 0;
        background-color: #e7e7e7;
        border: 0 none;
        overflow: hidden;
        box-sizing: content-box;
    }
    
    .github-preview ol {
        padding-left: 30px;
    }
    
    .github-preview li {
        margin-bottom: 0.5em;
    }
    
    .github-preview strong {
        font-weight: bold;
    }
</style>
{% endblock %} {% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2>快报管理</h2>
    <div>
        <a href="/news" class="btn btn-primary">生成新快报</a>
    </div>
</div>

<ul class="nav nav-tabs mb-4" id="digestTabs" role="tablist">
    <li class="nav-item" role="presentation">
        <button class="nav-link active" id="latest-tab" data-bs-toggle="tab" data-bs-target="#latest" type="button" role="tab">
            最新快报
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="history-tab" data-bs-toggle="tab" data-bs-target="#history" type="button" role="tab">
            历史快报
        </button>
    </li>
</ul>

<div class="tab-content" id="digestTabsContent">
    <!-- 最新快报 -->
    <div class="tab-pane fade show active" id="latest" role="tabpanel">
        <div id="latestDigestContainer">
            <div class="text-center py-5">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
            </div>
        </div>
    </div>

    <!-- 历史快报 -->
    <div class="tab-pane fade" id="history" role="tabpanel">
        <div class="row" id="historyDigestContainer">
            <div class="text-center py-5">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 快报编辑模态框 -->
<div class="modal fade" id="editDigestModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editDigestTitle">编辑快报</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="editDigestForm">
                    <input type="hidden" id="editDigestId">
                    <div class="mb-3">
                        <label for="editDigestTitleInput" class="form-label">标题</label>
                        <input type="text" class="form-control" id="editDigestTitleInput" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">内容</label>
                        
                        <!-- 编辑模式选择器 -->
                        <div class="edit-mode-selector">
                            <button type="button" class="edit-mode-btn active" id="btnMarkdownMode">
                                <i class="bi bi-code-slash"></i> Markdown编辑
                            </button>
                            <button type="button" class="edit-mode-btn" id="btnVisualMode">
                                <i class="bi bi-palette"></i> 可视化编辑
                            </button>
                        </div>
                        
                        <!-- Markdown编辑模式 -->
                        <div id="markdownEditSection">
                            <!-- 移动设备切换按钮 -->
                            <div class="mobile-toggle-buttons">
                                <button type="button" class="btn btn-outline-primary active" id="btnShowEditor">
                                    <i class="bi bi-pencil"></i> 编辑
                                </button>
                                <button type="button" class="btn btn-outline-secondary" id="btnShowPreview">
                                    <i class="bi bi-eye"></i> 预览
                                </button>
                            </div>
                            
                            <div class="editor-preview-section">
                                <div class="editor-section" id="editorSection">
                                    <div class="form-label">
                                        Markdown编辑器
                                        <span class="d-none d-md-inline text-muted small">(实时预览在右侧)</span>
                                    </div>
                                    <textarea id="editDigestContent" class="form-control"></textarea>
                                </div>
                                <div class="preview-section" id="previewSection">
                                    <div class="preview-header">
                                        实时预览（GitHub样式）
                                        <button type="button" class="btn btn-sm btn-outline-primary d-md-none" id="btnBackToEditor">
                                            <i class="bi bi-arrow-left"></i> 返回编辑
                                        </button>
                                    </div>
                                    <div class="preview-content github-preview" id="digestPreview">
                                        <p class="text-muted">在编辑器中输入内容，这里将显示实时预览...</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- 可视化编辑模式 -->
                        <div id="visualEditSection" style="display: none;">
                            <div class="visual-editor" id="visualEditor">
                                <!-- 快报标题 -->
                                <input type="text" class="digest-title-editor" id="visualDigestTitle" placeholder="快报标题">
                                
                                <!-- 分类编辑区域 -->
                                <div id="categoriesContainer">
                                    <!-- 分类将通过JavaScript动态生成 -->
                                </div>
                                
                                <!-- 全局添加新闻按钮 -->
                                <div class="text-center mt-4">
                                    <button type="button" class="btn btn-primary me-2" id="btnGlobalAddNews">
                                        <i class="bi bi-plus-circle"></i> 添加新闻
                                    </button>
                                    <button type="button" class="btn btn-outline-secondary" id="btnAddCategory">
                                        <i class="bi bi-folder-plus"></i> 添加自定义分类
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn btn-primary" id="btnSaveDigest">保存</button>
            </div>
        </div>
    </div>
</div>

<!-- 快报详情模态框 -->
<div class="modal fade" id="viewDigestModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="viewDigestTitle">快报详情</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div id="viewDigestContent" class="digest-preview"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
                <button type="button" class="btn btn-primary" id="btnEditDigest">编辑</button>
                <a href="#" class="btn btn-success" id="btnDownloadPdf" target="_blank">下载PDF</a>
            </div>
        </div>
    </div>
</div>

<!-- 新增新闻模态框 -->
<div class="modal fade" id="addNewsModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">添加新闻</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="addNewsForm">
                    <div class="mb-3">
                        <label for="newsCategory" class="form-label">分类</label>
                        <select class="form-select" id="newsCategory" required>
                            <option value="">请选择分类</option>
                            <option value="金融业网络安全事件">一、金融业网络安全事件</option>
                            <option value="重大网络安全事件">二、重大网络安全事件</option>
                            <option value="重大数据泄露事件">三、重大数据泄露事件</option>
                            <option value="重大漏洞风险提示">四、重大漏洞风险提示</option>
                            <option value="其他">五、其他</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="newsTitle" class="form-label">标题</label>
                        <input type="text" class="form-control" id="newsTitle" placeholder="请输入新闻标题" required>
                    </div>
                    <div class="mb-3">
                        <label for="newsSummary" class="form-label">摘要</label>
                        <textarea class="form-control" id="newsSummary" rows="4" placeholder="请输入新闻摘要" required></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn btn-primary" id="btnConfirmAddNews">添加</button>
            </div>
        </div>
    </div>
</div>

<!-- 新闻详情模态框 -->
<div class="modal fade" id="newsDetailModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">新闻详情</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div id="newsDetailContent">
                    <div class="text-center py-5">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">加载中...</span>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
            </div>
        </div>
    </div>
</div>
{% endblock %} {% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/easymde@2.18.0/dist/easymde.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<script>
    let easymde = null;
    let currentDigestId = null;
    let currentEditMode = 'markdown'; // 'markdown' 或 'visual'
    let visualEditorData = null; // 存储可视化编辑器的数据
    let currentDigestNewsIds = []; // 当前快报关联的数据库新闻ID列表

    // 新闻分类映射
    const NEWS_CATEGORIES = {
        '金融业网络安全事件': { 
            label: '一、金融业网络安全事件', 
            key: 'financial',
            color: 'info'
        },
        '重大网络安全事件': { 
            label: '二、重大网络安全事件', 
            key: 'major',
            color: 'danger'
        },
        '重大数据泄露事件': { 
            label: '三、重大数据泄露事件', 
            key: 'leak',
            color: 'warning'
        },
        '重大漏洞风险提示': { 
            label: '四、重大漏洞风险提示', 
            key: 'vulnerability',
            color: 'primary'
        },
        '其他': { 
            label: '五、其他', 
            key: 'other',
            color: 'secondary'
        }
    };

    document.addEventListener('DOMContentLoaded', function() {
        // 检查URL参数，看是否需要直接查看特定快报
        const urlParams = new URLSearchParams(window.location.search);
        const viewDigestId = urlParams.get('view');

        if (viewDigestId) {
            // 如果有view参数，直接查看指定快报
            viewDigest(parseInt(viewDigestId));
        } else {
            // 否则加载最新快报
            loadLatestDigest();
        }

        // 加载历史快报
        document.getElementById('history-tab').addEventListener('click', function() {
            loadHistoryDigests();
        });

        // 保存快报按钮事件
        document.getElementById('btnSaveDigest').addEventListener('click', saveDigest);

        // 视口变化监听与触摸优化（移动端稳定性增强）
        if (window.visualViewport) {
            window.visualViewport.addEventListener('resize', () => {
                const footer = document.querySelector('#editDigestModal .modal-footer');
                if (footer) {
                    footer.style.bottom = '0px';
                }
            });
        }

        // 防止点击穿透，确保底部按钮触摸事件被捕获
        document.querySelectorAll('.modal-footer').forEach(footer => {
            footer.addEventListener('touchstart', (e) => {
                e.stopPropagation();
            }, { passive: false });
        });

        // 编辑快报按钮事件
        document.getElementById('btnEditDigest').addEventListener('click', function() {
            // 关闭查看模态框
            const viewModal = bootstrap.Modal.getInstance(document.getElementById('viewDigestModal'));
            viewModal.hide();

            // 打开编辑模态框
            editDigest(currentDigestId);
        });

        // 编辑模式切换事件
        initEditModeToggle();

        // 移动设备切换按钮事件
        initMobileToggleButtons();

        // 添加重复检测标记的点击事件委托
        document.addEventListener('click', function(e) {
            if (e.target && e.target.classList.contains('duplicate-clickable')) {
                try {
                    const detectionData = JSON.parse(e.target.getAttribute('data-detection'));
                    showDuplicateDetails(detectionData);
                } catch (error) {
                    console.error('解析重复检测数据失败:', error);
                    alert('显示重复检测详情失败');
                }
            }
        });
    });

    // 初始化编辑模式切换
    function initEditModeToggle() {
        const btnMarkdownMode = document.getElementById('btnMarkdownMode');
        const btnVisualMode = document.getElementById('btnVisualMode');
        
        btnMarkdownMode.addEventListener('click', function() {
            switchEditMode('markdown');
        });
        
        btnVisualMode.addEventListener('click', function() {
            switchEditMode('visual');
        });
    }

    // 切换编辑模式
    function switchEditMode(mode) {
        if (currentEditMode === mode) return;
        
        const btnMarkdownMode = document.getElementById('btnMarkdownMode');
        const btnVisualMode = document.getElementById('btnVisualMode');
        const markdownSection = document.getElementById('markdownEditSection');
        const visualSection = document.getElementById('visualEditSection');
        
        if (mode === 'visual') {
            // 切换到可视化编辑模式
            btnMarkdownMode.classList.remove('active');
            btnVisualMode.classList.add('active');
            markdownSection.style.display = 'none';
            visualSection.style.display = 'block';
            
            // 将Markdown内容转换为可视化编辑器数据
            if (currentEditMode === 'markdown') {
                convertMarkdownToVisual();
            }
            
            currentEditMode = 'visual';
        } else {
            // 切换到Markdown编辑模式
            btnVisualMode.classList.remove('active');
            btnMarkdownMode.classList.add('active');
            visualSection.style.display = 'none';
            markdownSection.style.display = 'block';
            
            // 将可视化编辑器数据转换为Markdown
            if (currentEditMode === 'visual') {
                convertVisualToMarkdown();
            }
            
            currentEditMode = 'markdown';
            
            // 如果EasyMDE还未初始化，则创建它
            if (!easymde) {
                easymde = new EasyMDE({
                    element: document.getElementById('editDigestContent'),
                    spellChecker: false,
                    autosave: {
                        enabled: true,
                        uniqueId: `digestEditor_${currentDigestId}`,
                        delay: 1000,
                    },
                    // 配置工具栏
                    toolbar: ["bold", "italic", "heading", "|", "unordered-list", "ordered-list", "|", "link", "table", "|", "preview", "side-by-side", "fullscreen", "|", "guide"]
                });

                // 监听编辑器内容变化
                easymde.codemirror.on('change', function() {
                    updatePreview();
                });
            }
            
            // 刷新EasyMDE编辑器
            if (easymde && easymde.codemirror) {
                setTimeout(() => {
                    easymde.codemirror.refresh();
                    updatePreview();
                }, 100);
            }
        }
    }

    // 将Markdown内容转换为可视化编辑器数据
    function convertMarkdownToVisual() {
        const markdownContent = easymde ? easymde.value() : '';
        const digestTitle = document.getElementById('editDigestTitleInput').value;
        
        // 解析Markdown内容
        visualEditorData = parseMarkdownToVisualData(markdownContent);
        
        // 更新可视化编辑器
        updateVisualEditor(digestTitle, visualEditorData);
    }

    // 将可视化编辑器数据转换为Markdown
    function convertVisualToMarkdown() {
        const visualTitle = document.getElementById('visualDigestTitle').value;
        const visualData = collectVisualEditorData();
        
        // 生成Markdown内容
        const markdownContent = generateMarkdownFromVisualData(visualData);
        
        // 更新Markdown编辑器和标题
        document.getElementById('editDigestTitleInput').value = visualTitle;
        if (easymde) {
            easymde.value(markdownContent);
        }
        
        // 更新预览
        updatePreview();
    }

    // 初始化移动设备切换按钮
    function initMobileToggleButtons() {
        const btnShowEditor = document.getElementById('btnShowEditor');
        const btnShowPreview = document.getElementById('btnShowPreview');
        const btnBackToEditor = document.getElementById('btnBackToEditor');

        // 显示编辑器
        function showEditor() {
            const editorSection = document.getElementById('editorSection');
            const previewSection = document.getElementById('previewSection');
            
            editorSection.classList.remove('mobile-hidden');
            previewSection.classList.remove('mobile-visible');
            
            btnShowEditor.classList.add('active');
            btnShowEditor.classList.remove('btn-outline-primary');
            btnShowEditor.classList.add('btn-primary');
            
            btnShowPreview.classList.remove('active');
            btnShowPreview.classList.remove('btn-secondary');
            btnShowPreview.classList.add('btn-outline-secondary');
            
            // 刷新编辑器
            if (easymde && easymde.codemirror) {
                setTimeout(() => {
                    easymde.codemirror.refresh();
                    easymde.codemirror.focus();
                }, 100);
            }
        }

        // 显示预览
        function showPreview() {
            const editorSection = document.getElementById('editorSection');
            const previewSection = document.getElementById('previewSection');
            
            editorSection.classList.add('mobile-hidden');
            previewSection.classList.add('mobile-visible');
            
            btnShowPreview.classList.add('active');
            btnShowPreview.classList.remove('btn-outline-secondary');
            btnShowPreview.classList.add('btn-secondary');
            
            btnShowEditor.classList.remove('active');
            btnShowEditor.classList.remove('btn-primary');
            btnShowEditor.classList.add('btn-outline-primary');
            
            // 更新预览内容
            updatePreview();
        }

        btnShowEditor.addEventListener('click', showEditor);
        btnShowPreview.addEventListener('click', showPreview);
        btnBackToEditor.addEventListener('click', showEditor);

        // 监听窗口大小变化，重置移动设备状态
        let resizeTimer;
        window.addEventListener('resize', function() {
            clearTimeout(resizeTimer);
            resizeTimer = setTimeout(function() {
                if (window.innerWidth > 768) {
                    // 桌面模式，重置所有隐藏状态
                    const editorSection = document.getElementById('editorSection');
                    const previewSection = document.getElementById('previewSection');
                    
                    editorSection.classList.remove('mobile-hidden');
                    previewSection.classList.remove('mobile-visible');
                    
                    // 刷新编辑器
                    if (easymde && easymde.codemirror) {
                        setTimeout(() => {
                            easymde.codemirror.refresh();
                        }, 100);
                    }
                }
            }, 250);
        });
    }

    // 加载最新快报
    function loadLatestDigest() {
        // 停止任何现有的状态更新
        stopDuplicateDetectionUpdates();

        // 同时获取最新快报和详细信息
        axios.get('/api/digest/latest')
            .then(response => {
                const digest = response.data;
                const container = document.getElementById('latestDigestContainer');

                if (!digest) {
                    container.innerHTML = `
                        <div class="alert alert-info">
                            <p>没有找到任何快报。</p>
                            <a href="/news" class="btn btn-primary">生成第一份快报</a>
                        </div>
                    `;
                    return;
                }

                // 显示基本框架
                container.innerHTML = `
                    <div class="card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5 class="mb-0">${digest.title}</h5>
                            <span class="badge bg-primary">${formatDate(digest.date)}</span>
                        </div>
                        <div class="card-body">
                            <div class="digest-preview" id="latestDigestPreview">
                                <div class="text-center py-4">
                                    <div class="spinner-border text-primary" role="status">
                                        <span class="visually-hidden">正在加载内容...</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="card-footer">
                            <div class="btn-group">
                                <button class="btn btn-primary" onclick="editDigest(${digest.id})">
                                    <i class="bi bi-pencil"></i> 编辑
                                </button>
                                <button class="btn btn-success" onclick="downloadOrGeneratePdf(${digest.id})">
                                    <i class="bi bi-file-pdf"></i> 下载PDF
                                </button>
                                <button class="btn btn-outline-secondary" onclick="viewDigest(${digest.id})">
                                    <i class="bi bi-eye"></i> 查看详情
                                </button>
                            </div>
                        </div>
                    </div>
                `;

                // 异步获取详细信息并增强内容
                axios.get(`/api/digest/${digest.id}`)
                    .then(detailResponse => {
                        const detailDigest = detailResponse.data;
                        const newsIds = detailDigest.news_ids || [];
                        
                        // 增强内容并显示
                enhanceDigestContent(detailDigest.content || '', newsIds, detailDigest.id)
                    .then(enhancedContent => {
                        const previewElement = document.getElementById('latestDigestPreview');
                        previewElement.innerHTML = enhancedContent;
                        previewElement.setAttribute('data-digest-id', detailDigest.id);

                        // 启动重复检测状态更新（如果页面上有重复检测标记）
                        if (enhancedContent.includes('duplicate-detection-badge')) {
                            console.log(`为最新快报 ${detailDigest.id} 启动重复检测状态更新`);
                            startDuplicateDetectionUpdates(detailDigest.id, previewElement);
                        }
                    })
                            .catch(error => {
                                console.error('Error enhancing latest digest content:', error);
                                document.getElementById('latestDigestPreview').innerHTML = marked.parse(detailDigest.content || '');
                            });
                    })
                    .catch(error => {
                        console.error('Error loading latest digest details:', error);
                        // 如果获取详情失败，显示基本内容
                        document.getElementById('latestDigestPreview').innerHTML = marked.parse(digest.content || '');
                    });
            })
            .catch(error => {
                console.error('Error loading latest digest:', error);
                document.getElementById('latestDigestContainer').innerHTML = `
                    <div class="alert alert-danger">
                        <p>加载最新快报失败。</p>
                        <a href="/news" class="btn btn-primary">生成新快报</a>
                    </div>
                `;
            });
    }

    // 加载历史快报
    function loadHistoryDigests() {
        axios.get('/api/digest/')
            .then(response => {
                const digests = response.data;
                const container = document.getElementById('historyDigestContainer');

                if (digests.length === 0) {
                    container.innerHTML = `
                        <div class="col-12">
                            <div class="alert alert-info">
                                <p>没有找到任何历史快报。</p>
                            </div>
                        </div>
                    `;
                    return;
                }

                // 清空容器
                container.innerHTML = '';

                // 渲染快报卡片
                digests.forEach(digest => {
                    const card = document.createElement('div');
                    card.className = 'col-md-4 mb-4';
                    card.innerHTML = `
                        <div class="card digest-card h-100">
                            <div class="card-header">
                                <h5 class="card-title mb-0">${digest.title}</h5>
                            </div>
                            <div class="card-body">
                                <p class="card-text">
                                    <strong>日期:</strong> ${formatDate(digest.date)}<br>
                                    <strong>创建时间:</strong> ${formatDate(digest.created_at)}<br>
                                </p>
                                <div class="mt-2">
                                    ${renderNewsCountBadges(digest.news_counts)}
                                </div>
                            </div>
                            <div class="card-footer">
                                <button class="btn btn-sm btn-primary" onclick="viewDigest(${digest.id})">
                                    <i class="bi bi-eye"></i> 查看
                                </button>
                                <button class="btn btn-sm btn-outline-primary" onclick="editDigest(${digest.id})">
                                    <i class="bi bi-pencil"></i> 编辑
                                </button>
                                <button class="btn btn-sm btn-outline-success" onclick="downloadOrGeneratePdf(${digest.id})">
                                    <i class="bi bi-file-pdf"></i> PDF
                                </button>
                            </div>
                        </div>
                    `;
                    container.appendChild(card);
                });
            })
            .catch(error => {
                console.error('Error loading history digests:', error);
                document.getElementById('historyDigestContainer').innerHTML = `
                    <div class="col-12">
                        <div class="alert alert-danger">
                            <p>加载历史快报失败。</p>
                        </div>
                    </div>
                `;
            });
    }

    // 查看快报详情
    function viewDigest(digestId) {
        currentDigestId = digestId;

        axios.get(`/api/digest/${digestId}`)
            .then(response => {
                const digest = response.data;

                // 保存关联的新闻ID列表
                currentDigestNewsIds = digest.news_ids || [];

                // 设置标题
                document.getElementById('viewDigestTitle').textContent = digest.title;

                // 显示加载状态
                document.getElementById('viewDigestContent').innerHTML = `
                    <div class="text-center py-4">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">正在加载内容...</span>
                        </div>
                    </div>
                `;

                // 异步渲染增强的内容
                enhanceDigestContent(digest.content || '', currentDigestNewsIds, digestId)
                    .then(enhancedContent => {
                        document.getElementById('viewDigestContent').innerHTML = enhancedContent;
                    });

                // 设置PDF下载事件
                const pdfBtn = document.getElementById('btnDownloadPdf');
                pdfBtn.onclick = function(e) {
                    e.preventDefault();
                    downloadOrGeneratePdf(digestId);
                };

                // 显示模态框 - 使用 getOrCreateInstance 避免创建多个实例导致 backdrop 残留
                const modalElement = document.getElementById('viewDigestModal');
                const modal = bootstrap.Modal.getOrCreateInstance(modalElement);
                modal.show();

                // 启动重复检测状态更新
                startDuplicateDetectionUpdates(digestId, document.getElementById('viewDigestContent'));

                // 监听模态框关闭事件，停止状态更新
                modalElement.addEventListener('hidden.bs.modal', () => {
                    const previewElement = document.getElementById('latestDigestPreview');
                    const previewDigestId = previewElement ? parseInt(previewElement.getAttribute('data-digest-id') || '0', 10) : null;

                    stopDuplicateDetectionUpdates();

                    if (previewElement && previewDigestId === digestId) {
                        startDuplicateDetectionUpdates(digestId, previewElement);
                    }
                }, { once: true });
            })
            .catch(error => {
                console.error('Error loading digest details:', error);
                alert('加载快报详情失败');
            });
    }

    // 存储模态框shown事件处理器，以便清理
    let modalShownHandler = null;
    let titleInputHandler = null;
    let visualTitleInputHandler = null;

    // 清理模态框事件监听器
    function cleanupModalEventListeners() {
        const modal = document.getElementById('editDigestModal');
        const titleInput = document.getElementById('editDigestTitleInput');
        const visualTitle = document.getElementById('visualDigestTitle');

        if (modal && modalShownHandler) {
            modal.removeEventListener('shown.bs.modal', modalShownHandler);
            modalShownHandler = null;
        }

        if (titleInput && titleInputHandler) {
            titleInput.removeEventListener('input', titleInputHandler);
            titleInputHandler = null;
        }

        if (visualTitle && visualTitleInputHandler) {
            visualTitle.removeEventListener('input', visualTitleInputHandler);
            visualTitleInputHandler = null;
        }
    }

    // 编辑快报
    function editDigest(digestId) {
        currentDigestId = digestId;

        // 清理之前的事件监听器
        cleanupModalEventListeners();

        axios.get(`/api/digest/${digestId}`)
            .then(response => {
                const digest = response.data;

                // 调试信息
                console.log('编辑快报 - API 响应:', digest);
                console.log('快报内容长度:', digest.content ? digest.content.length : 0);
                console.log('快报内容预览:', digest.content ? digest.content.substring(0, 100) : '无内容');

                // 设置表单值
                document.getElementById('editDigestId').value = digest.id;
                document.getElementById('editDigestTitleInput').value = digest.title;
                document.getElementById('editDigestContent').value = digest.content || '';

                // 重置编辑模式为可视化编辑
                currentEditMode = 'visual';
                document.getElementById('btnVisualMode').classList.add('active');
                document.getElementById('btnMarkdownMode').classList.remove('active');
                document.getElementById('visualEditSection').style.display = 'block';
                document.getElementById('markdownEditSection').style.display = 'none';

                // 初始化Markdown编辑器
                if (easymde) {
                    console.log('设置EasyMDE内容:', digest.content || '');
                    easymde.value(digest.content || '');
                    // 更新预览
                    updatePreview();
                } else {
                    easymde = new EasyMDE({
                        element: document.getElementById('editDigestContent'),
                        spellChecker: false,
                        autosave: {
                            enabled: true,
                            uniqueId: `digestEditor_${digestId}`,
                            delay: 1000,
                        },
                        // 配置工具栏
                        toolbar: ["bold", "italic", "heading", "|", "unordered-list", "ordered-list", "|", "link", "table", "|", "preview", "side-by-side", "fullscreen", "|", "guide"]
                    });

                    // 监听编辑器内容变化
                    easymde.codemirror.on('change', function() {
                        updatePreview();
                    });

                    // 初始预览
                    updatePreview();
                }

                // 初始化可视化编辑器数据
                visualEditorData = parseMarkdownToVisualData(digest.content || '');

                // 同步标题到可视化编辑器并立即更新显示
                document.getElementById('visualDigestTitle').value = digest.title;
                updateVisualEditor(digest.title, visualEditorData);

                // 监听标题变化（保存引用以便清理）
                titleInputHandler = updatePreview;
                document.getElementById('editDigestTitleInput').addEventListener('input', titleInputHandler);

                // 监听可视化编辑器标题变化
                visualTitleInputHandler = function() {
                    // 同步标题到Markdown编辑器
                    document.getElementById('editDigestTitleInput').value = this.value;
                };
                document.getElementById('visualDigestTitle').addEventListener('input', visualTitleInputHandler);

                // 显示模态框 - 使用 getOrCreateInstance 避免创建多个实例导致 backdrop 残留
                const modalElement = document.getElementById('editDigestModal');
                const modal = bootstrap.Modal.getOrCreateInstance(modalElement);
                modal.show();

                // 在模态框完全显示后刷新编辑器（保存引用以便清理）
                modalShownHandler = function() {
                    // 确保移动设备上默认显示编辑器
                    if (window.innerWidth <= 768) {
                        const editorSection = document.getElementById('editorSection');
                        const previewSection = document.getElementById('previewSection');
                        const btnShowEditor = document.getElementById('btnShowEditor');
                        const btnShowPreview = document.getElementById('btnShowPreview');

                        // 重置为编辑模式
                        editorSection.classList.remove('mobile-hidden');
                        previewSection.classList.remove('mobile-visible');

                        btnShowEditor.classList.add('active');
                        btnShowEditor.classList.remove('btn-outline-primary');
                        btnShowEditor.classList.add('btn-primary');

                        btnShowPreview.classList.remove('active');
                        btnShowPreview.classList.remove('btn-secondary');
                        btnShowPreview.classList.add('btn-outline-secondary');

                        // 移动端：模态展示后，统一自适应所有摘要高度
                        bindAutoResizeForAllSummariesMobile();
                    }

                    if (easymde && easymde.codemirror) {
                        // 延迟一下确保DOM完全渲染
                        setTimeout(() => {
                            easymde.codemirror.refresh();
                            easymde.codemirror.focus();
                            // 再次兜底调整一次摘要高度
                            if (window.innerWidth <= 768) {
                                bindAutoResizeForAllSummariesMobile();
                            }
                        }, 100);
                    }
                };
                document.getElementById('editDigestModal').addEventListener('shown.bs.modal', modalShownHandler, { once: true });

                // 模态框关闭时清理事件监听器
                document.getElementById('editDigestModal').addEventListener('hidden.bs.modal', function() {
                    cleanupModalEventListeners();
                }, { once: true });
            })
            .catch(error => {
                console.error('Error loading digest for editing:', error);
                alert('加载快报编辑信息失败');
            });
    }

    // 更新实时预览
    function updatePreview() {
        const title = document.getElementById('editDigestTitleInput').value || '快报标题';
        const content = easymde ? easymde.value() : '';
        const date = new Date().toISOString().split('T')[0];

        // 调用预览API
        axios.post('/api/digest/preview', {
                title: title,
                content: content,
                date: date
            })
            .then(response => {
                const previewContainer = document.getElementById('digestPreview');
                previewContainer.innerHTML = response.data.content || '<p class="text-muted">暂无内容</p>';
            })
            .catch(error => {
                console.error('Error updating preview:', error);
                // 如果API失败，使用客户端预览
                const previewContainer = document.getElementById('digestPreview');
                previewContainer.innerHTML = marked.parse(content || '') || '<p class="text-muted">暂无内容</p>';
            });
    }

    // 解析Markdown内容为可视化编辑器数据
    function parseMarkdownToVisualData(markdownContent) {
        const data = {
            categories: {}
        };

        // 初始化所有分类
        Object.keys(NEWS_CATEGORIES).forEach(category => {
            data.categories[category] = [];
        });

        if (!markdownContent.trim()) {
            return data;
        }

        const lines = markdownContent.split('\n');
        let currentCategory = null;
        let newsIndex = 0;

        for (let i = 0; i < lines.length; i++) {
            const line = lines[i].trim();

            // 检查是否是分类标题 (### 开头)
            if (line.startsWith('### ')) {
                const categoryTitle = line.substring(4).trim();
                
                // 找到对应的分类
                currentCategory = null;
                for (const [key, info] of Object.entries(NEWS_CATEGORIES)) {
                    if (categoryTitle.includes(info.label.substring(2)) || categoryTitle.includes(key)) {
                        currentCategory = key;
                        break;
                    }
                }
            }
            
            // 检查是否是新闻项 (数字开头)
            else if (line.match(/^\d+\.\s+\*\*(.+?)\*\*$/) && currentCategory) {
                const titleMatch = line.match(/^\d+\.\s+\*\*(.+?)\*\*$/);
                if (titleMatch) {
                    const newsTitle = titleMatch[1];
                    let newsSummary = '';

                    // 查找摘要，可能在下一行或下几行
                    for (let j = i + 1; j < lines.length; j++) {
                        const summaryLine = lines[j].trim();
                        
                        // 如果遇到空行，跳过
                        if (summaryLine === '') {
                            continue;
                        }
                        
                        // 如果遇到新的标题、分类或分隔符，停止查找
                        if (summaryLine.startsWith('#') || 
                            summaryLine.startsWith('---') || 
                            summaryLine.match(/^\d+\.\s+\*\*/) ||
                            summaryLine.startsWith('> ')) {
                            break;
                        }
                        
                        // 如果是摘要行 (以 - 开头，或者继续上一行的内容)
                        if (summaryLine.startsWith('- ')) {
                            const summaryContent = summaryLine.substring(2).trim();
                            if (summaryContent) {
                                newsSummary = summaryContent;
                                break;
                            }
                        } else if (!summaryLine.startsWith('    ') && newsSummary === '') {
                            // 如果找到非缩进的内容且还没找到摘要，可能是摘要内容
                            newsSummary = summaryLine;
                            break;
                        }
                    }

                    data.categories[currentCategory].push({
                        id: `news_${newsIndex++}`,
                        title: newsTitle,
                        summary: newsSummary
                    });
                }
            }
        }

        return data;
    }

    // 从可视化编辑器收集数据
    function collectVisualEditorData() {
        const data = {
            categories: {}
        };

        // 初始化所有分类
        Object.keys(NEWS_CATEGORIES).forEach(category => {
            data.categories[category] = [];
        });

        // 收集每个分类的新闻
        const categoryElements = document.querySelectorAll('.category-section');
        categoryElements.forEach(categoryEl => {
            const categoryKey = categoryEl.dataset.category;
            if (!categoryKey || !data.categories[categoryKey]) return;

            const newsItems = categoryEl.querySelectorAll('.news-item');
            newsItems.forEach(newsEl => {
                const titleInput = newsEl.querySelector('.news-title-input');
                const summaryInput = newsEl.querySelector('.news-summary-input');
                
                if (titleInput && summaryInput && titleInput.value.trim()) {
                    data.categories[categoryKey].push({
                        id: newsEl.dataset.newsId,
                        title: titleInput.value.trim(),
                        summary: summaryInput.value.trim()
                    });
                }
            });
        });

        return data;
    }

    // 从可视化编辑器数据生成Markdown
    function generateMarkdownFromVisualData(data) {
        const today = new Date().toISOString().slice(0, 10).replace(/-/g, '');
        let markdown = `# **每日网安情报速递【${today}】**\n\n------\n\n`;

        // 按顺序处理分类
        const categoryOrder = ['金融业网络安全事件', '重大网络安全事件', '重大数据泄露事件', '重大漏洞风险提示', '其他'];
        
        categoryOrder.forEach(category => {
            const categoryInfo = NEWS_CATEGORIES[category];
            if (!categoryInfo) return;

            const newsItems = data.categories[category] || [];
            
            // 对于"其他"分类，如果没有新闻条目则跳过
            if (category === '其他' && newsItems.length === 0) {
                return;
            }

            markdown += `### ${categoryInfo.label}\n\n`;

            if (newsItems.length === 0) {
                markdown += '> 暂无\n';
            } else {
                newsItems.forEach((news, index) => {
                    markdown += `${index + 1}. **${news.title}**\n`;
                    markdown += `    - ${news.summary}\n`;
                    if (index < newsItems.length - 1) {
                        markdown += '\n';
                    }
                });
            }

            markdown += '\n------\n\n';
        });

        return markdown;
    }

    // 更新可视化编辑器
    function updateVisualEditor(title, data) {
        const visualTitle = document.getElementById('visualDigestTitle');
        const categoriesContainer = document.getElementById('categoriesContainer');

        // 设置标题
        visualTitle.value = title;

        // 清空容器
        categoriesContainer.innerHTML = '';

        // 按顺序创建分类
        const categoryOrder = ['金融业网络安全事件', '重大网络安全事件', '重大数据泄露事件', '重大漏洞风险提示', '其他'];
        
        categoryOrder.forEach(category => {
            const categoryInfo = NEWS_CATEGORIES[category];
            const newsItems = data.categories[category] || [];
            
            // 对于"其他"分类，如果没有新闻且正在从Markdown解析，则不显示该分类
            // 但如果用户在可视化编辑器中，则仍然显示以便添加新闻
            createCategorySection(categoriesContainer, category, categoryInfo, newsItems);
        });

        // 绑定可视化编辑器事件
        bindVisualEditorEvents();

        // 渲染后为移动端绑定摘要自动高度
        if (window.innerWidth <= 768) {
            setTimeout(() => { bindAutoResizeForAllSummariesMobile(); }, 0);
        }
    }

    // 创建分类区域
    function createCategorySection(container, categoryKey, categoryInfo, newsItems) {
        const categoryDiv = document.createElement('div');
        categoryDiv.className = 'category-section';
        categoryDiv.dataset.category = categoryKey;

        categoryDiv.innerHTML = `
            <div class="category-header">
                <h3 class="category-title">${categoryInfo.label}</h3>
                <button type="button" class="add-news-btn" data-category="${categoryKey}">
                    <i class="bi bi-plus"></i> 添加新闻
                </button>
            </div>
            <div class="news-container" data-category="${categoryKey}">
                ${newsItems.length === 0 ? '<div class="empty-category">暂无新闻，点击"添加新闻"按钮添加</div>' : ''}
            </div>
        `;

        container.appendChild(categoryDiv);

        // 添加现有新闻项
        const newsContainer = categoryDiv.querySelector('.news-container');
        newsItems.forEach((news, index) => {
            createNewsItem(newsContainer, news, categoryKey, index);
        });

        // 如果有新闻项，移除空状态提示
        if (newsItems.length > 0) {
            const emptyMsg = newsContainer.querySelector('.empty-category');
            if (emptyMsg) emptyMsg.remove();
        }
    }

    // 输入自适应高度的防抖（优化版：增加节流机制）
    let resizeTimeout;
    let lastResizeTime = 0;
    const RESIZE_THROTTLE_MS = 100; // 节流间隔

    const debouncedResize = (textarea) => {
        clearTimeout(resizeTimeout);

        // 节流检查：如果距离上次调整太近，延长防抖时间
        const now = Date.now();
        const timeSinceLastResize = now - lastResizeTime;
        const debounceDelay = timeSinceLastResize < RESIZE_THROTTLE_MS ? 150 : 50;

        resizeTimeout = setTimeout(() => {
            if (typeof autoResizeTextareaMobile === 'function') {
                autoResizeTextareaMobile(textarea);
                lastResizeTime = Date.now();
            }
        }, debounceDelay);
    };

    // 创建新闻项
    function createNewsItem(container, news, categoryKey, index) {
        const newsDiv = document.createElement('div');
        newsDiv.className = 'news-item';
        newsDiv.dataset.newsId = news.id || `news_${Date.now()}_${index}`;
        newsDiv.dataset.category = categoryKey;

        // 生成分类选择选项
        let categoryOptions = '';
        Object.keys(NEWS_CATEGORIES).forEach(key => {
            const selected = key === categoryKey ? 'selected' : '';
            categoryOptions += `<option value="${key}" ${selected}>${NEWS_CATEGORIES[key].label}</option>`;
        });

        newsDiv.innerHTML = `
            <div class="news-actions">
                <button type="button" class="news-action-btn move-up" title="上移">
                    <i class="bi bi-arrow-up"></i>
                </button>
                <button type="button" class="news-action-btn move-down" title="下移">
                    <i class="bi bi-arrow-down"></i>
                </button>
                <button type="button" class="news-action-btn delete" title="删除">
                    <i class="bi bi-trash"></i>
                </button>
            </div>
            <div class="mb-2">
                <label class="form-label small text-muted">分类</label>
                <select class="form-select form-select-sm news-category-select">
                    ${categoryOptions}
                </select>
            </div>
            <input type="text" class="news-title-input" placeholder="请输入新闻标题..." value="${news.title || ''}">
            <textarea class="news-summary-input" placeholder="请输入新闻摘要...">${news.summary || ''}</textarea>
        `;

        container.appendChild(newsDiv);

        // 绑定分类变更事件（使用标记防止重复绑定）
        const categorySelect = newsDiv.querySelector('.news-category-select');
        if (categorySelect && !categorySelect.dataset.eventBound) {
            categorySelect.addEventListener('change', function() {
                const newCategoryKey = this.value;
                const currentCategoryKey = newsDiv.dataset.category;

                if (newCategoryKey !== currentCategoryKey) {
                    moveNewsToCategory(newsDiv, currentCategoryKey, newCategoryKey);
                }
            });
            categorySelect.dataset.eventBound = 'true';
        }

        // 移动端：初始化摘要高度并绑定输入自适应（加入 IME 保护与焦点滚动锁定）
        const summaryEl = newsDiv.querySelector('.news-summary-input');
        if (summaryEl && window.innerWidth <= 768) {
            // 初始化高度
            if (typeof autoResizeTextareaMobile === 'function') {
                autoResizeTextareaMobile(summaryEl);
            }

            // 绑定输入事件（使用标记防止重复绑定）
            if (!summaryEl.dataset.eventBound) {
                summaryEl.addEventListener('input', function(e) {
                    // 如果正在进行输入法输入，跳过高度调整
                    if (imeComposingMap.get(e.target)) {
                        return;
                    }
                    debouncedResize(summaryEl);
                });

                // 添加 IME composition 事件监听
                summaryEl.addEventListener('compositionstart', handleCompositionStart);
                summaryEl.addEventListener('compositionend', handleCompositionEnd);

                // 改进的焦点滚动锁定
                summaryEl.addEventListener('focus', function(e) {
                    // 使用 preventScroll 选项（如果浏览器支持）
                    const initialScrollTop = e.target.scrollTop;

                    // 使用 RAF 确保稳定
                    requestAnimationFrame(() => {
                        if (e.target.scrollTop !== initialScrollTop) {
                            e.target.scrollTop = initialScrollTop;
                        }
                    });
                });

                summaryEl.dataset.eventBound = 'true';
            }
        }

        return newsDiv;
    }

    // 绑定可视化编辑器事件
    function bindVisualEditorEvents() {
        // 添加新闻按钮事件
        document.querySelectorAll('.add-news-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const categoryKey = this.dataset.category;
                addNewsItem(categoryKey);
            });
        });
    }

    // 全局事件处理标记，防止重复绑定
    let globalEventsInitialized = false;

    function initGlobalEventHandlers() {
        if (globalEventsInitialized) {
            console.log('全局事件处理器已初始化，跳过重复绑定');
            return;
        }

        // 全局新闻操作按钮事件处理（使用事件委托，只绑定一次）
        document.addEventListener('click', function(e) {
            if (e.target.closest('.news-action-btn')) {
                const btn = e.target.closest('.news-action-btn');
                const newsItem = btn.closest('.news-item');

                if (btn.classList.contains('delete')) {
                    deleteNewsItem(newsItem);
                } else if (btn.classList.contains('move-up')) {
                    moveNewsItem(newsItem, 'up');
                } else if (btn.classList.contains('move-down')) {
                    moveNewsItem(newsItem, 'down');
                }
            }
        });

        // 全局事件处理（延迟绑定）
        document.addEventListener('click', function(e) {
            if (e.target && e.target.id === 'btnAddCategory') {
                const categoryName = prompt('请输入自定义分类名称：');
                if (categoryName && categoryName.trim()) {
                    addCustomCategory(categoryName.trim());
                }
            }

            if (e.target && e.target.id === 'btnGlobalAddNews') {
                showAddNewsModal();
            }

            if (e.target && e.target.id === 'btnConfirmAddNews') {
                confirmAddNews();
            }
        });

        globalEventsInitialized = true;
        console.log('全局事件处理器初始化完成');
    }

    // 在DOMContentLoaded中调用
    initGlobalEventHandlers();

    // 添加新闻项
    function addNewsItem(categoryKey) {
        const container = document.querySelector(`.news-container[data-category="${categoryKey}"]`);
        if (!container) return;

        // 移除空状态提示
        const emptyMsg = container.querySelector('.empty-category');
        if (emptyMsg) emptyMsg.remove();

        // 创建新的新闻项
        const news = { title: '', summary: '' };
        const newsItem = createNewsItem(container, news, categoryKey, Date.now());
        
        // 聚焦到标题输入框
        const titleInput = newsItem.querySelector('.news-title-input');
        titleInput.focus();
    }

    // 删除新闻项
    function deleteNewsItem(newsItem) {
        if (confirm('确定要删除这条新闻吗？')) {
            const container = newsItem.parentNode;
            newsItem.remove();
            
            // 如果容器为空，显示空状态提示
            if (container.children.length === 0) {
                container.innerHTML = '<div class="empty-category">暂无新闻，点击"添加新闻"按钮添加</div>';
            }
        }
    }

    // 移动新闻项
    function moveNewsItem(newsItem, direction) {
        const container = newsItem.parentNode;
        const items = Array.from(container.querySelectorAll('.news-item'));
        const currentIndex = items.indexOf(newsItem);
        
        if (direction === 'up' && currentIndex > 0) {
            container.insertBefore(newsItem, items[currentIndex - 1]);
        } else if (direction === 'down' && currentIndex < items.length - 1) {
            container.insertBefore(items[currentIndex + 1], newsItem);
        }
    }

    // 将新闻项移动到不同分类
    function moveNewsToCategory(newsItem, fromCategoryKey, toCategoryKey) {
        // 获取目标分类容器
        const targetContainer = document.querySelector(`.news-container[data-category="${toCategoryKey}"]`);
        if (!targetContainer) {
            alert('目标分类不存在');
            return;
        }

        // 获取源分类容器
        const sourceContainer = newsItem.parentNode;

        // 移除目标分类的空状态提示
        const targetEmptyMsg = targetContainer.querySelector('.empty-category');
        if (targetEmptyMsg) {
            targetEmptyMsg.remove();
        }

        // 更新新闻项的分类属性
        newsItem.dataset.category = toCategoryKey;

        // 将新闻项移动到目标分类
        targetContainer.appendChild(newsItem);

        // 检查源分类是否为空，如果为空则显示空状态提示
        const remainingItems = sourceContainer.querySelectorAll('.news-item');
        if (remainingItems.length === 0) {
            sourceContainer.innerHTML = '<div class="empty-category">暂无新闻，点击"添加新闻"按钮添加</div>';
        }

        // 为移动的新闻项添加高亮效果
        newsItem.style.backgroundColor = '#e8f5e8';
        setTimeout(() => {
            newsItem.style.backgroundColor = '';
        }, 2000);

        // 滚动到移动后的新闻项
        newsItem.scrollIntoView({ behavior: 'smooth', block: 'center' });
    }

    // 添加自定义分类
    function addCustomCategory(categoryName) {
        const categoriesContainer = document.getElementById('categoriesContainer');
        const categoryKey = `custom_${Date.now()}`;
        const categoryInfo = {
            label: categoryName,
            key: categoryKey,
            color: 'secondary'
        };
        
        createCategorySection(categoriesContainer, categoryKey, categoryInfo, []);
        bindVisualEditorEvents();
    }

    // 显示添加新闻模态框
    function showAddNewsModal() {
        // 清空表单
        document.getElementById('addNewsForm').reset();

        // 显示模态框 - 使用 getOrCreateInstance 避免创建多个实例导致 backdrop 残留
        const modalElement = document.getElementById('addNewsModal');
        const modal = bootstrap.Modal.getOrCreateInstance(modalElement);
        modal.show();
    }

    // 确认添加新闻
    function confirmAddNews() {
        const category = document.getElementById('newsCategory').value;
        const title = document.getElementById('newsTitle').value.trim();
        const summary = document.getElementById('newsSummary').value.trim();
        
        if (!category) {
            alert('请选择新闻分类');
            return;
        }
        
        if (!title) {
            alert('请输入新闻标题');
            return;
        }
        
        if (!summary) {
            alert('请输入新闻摘要');
            return;
        }
        
        // 添加新闻到指定分类
        addNewsToCategory(category, title, summary);
        
        // 关闭模态框
        const modal = bootstrap.Modal.getInstance(document.getElementById('addNewsModal'));
        modal.hide();
        
        // 清空表单
        document.getElementById('addNewsForm').reset();
    }

    // 添加新闻到指定分类
    function addNewsToCategory(categoryKey, title, summary) {
        const container = document.querySelector(`.news-container[data-category="${categoryKey}"]`);
        if (!container) {
            alert('找不到指定的分类容器');
            return;
        }

        // 移除空状态提示
        const emptyMsg = container.querySelector('.empty-category');
        if (emptyMsg) emptyMsg.remove();

        // 创建新的新闻项
        const news = { 
            title: title, 
            summary: summary,
            id: `news_${Date.now()}`
        };
        const newsItem = createNewsItem(container, news, categoryKey, Date.now());
        
        // 滚动到新添加的新闻项
        newsItem.scrollIntoView({ behavior: 'smooth', block: 'center' });
        
        // 短暂高亮显示
        newsItem.style.backgroundColor = '#e3f2fd';
        setTimeout(() => {
            newsItem.style.backgroundColor = '';
        }, 2000);
    }

    // 保存快报
    function saveDigest() {
        const digestId = document.getElementById('editDigestId').value;
        let title, content;

        if (currentEditMode === 'visual') {
            // 从可视化编辑器获取数据
            title = document.getElementById('visualDigestTitle').value;
            const visualData = collectVisualEditorData();
            content = generateMarkdownFromVisualData(visualData);
        } else {
            // 从Markdown编辑器获取数据
            title = document.getElementById('editDigestTitleInput').value;
            content = easymde ? easymde.value() : '';
        }

        if (!title) {
            alert('请输入快报标题');
            return;
        }

        const digestData = {
            title: title,
            content: content
        };

        // 禁用保存按钮，防止重复点击
        const saveBtn = document.getElementById('btnSaveDigest');
        const originalText = saveBtn.textContent;
        saveBtn.disabled = true;
        saveBtn.textContent = '保存中...';

        axios.put(`/api/digest/${digestId}`, digestData)
            .then(() => {
                // 清理事件监听器
                cleanupModalEventListeners();

                // 清理定时器
                if (resizeTimeout) {
                    clearTimeout(resizeTimeout);
                    resizeTimeout = null;
                }

                // 关闭模态框
                const modal = bootstrap.Modal.getInstance(document.getElementById('editDigestModal'));
                modal.hide();

                // 重新加载快报
                loadLatestDigest();

                // 如果历史标签页是激活的，也重新加载历史快报
                if (document.getElementById('history-tab').classList.contains('active')) {
                    loadHistoryDigests();
                }

                alert('快报保存成功');
            })
            .catch(error => {
                console.error('Error saving digest:', error);
                alert('保存快报失败');
            })
            .finally(() => {
                // 恢复保存按钮状态
                saveBtn.disabled = false;
                saveBtn.textContent = originalText;
            });
    }

    // 智能PDF下载/生成函数
    function downloadOrGeneratePdf(digestId) {
        // 使用隐藏的链接元素进行下载，避免弹窗阻止
        const downloadLink = document.createElement('a');
        downloadLink.style.display = 'none';
        document.body.appendChild(downloadLink);
        
        // 构建完整URL，确保跨设备兼容性
        const baseUrl = window.location.origin;
        const checkUrl = `${baseUrl}/api/digest/${digestId}/pdf`;
        
        // 先尝试直接下载PDF
        fetch(checkUrl, { method: 'HEAD' })
            .then(response => {
                if (response.ok) {
                    // PDF存在，直接下载
                    downloadPdf(digestId, downloadLink);
                } else if (response.status === 404) {
                    // PDF不存在，询问是否生成
                    if (confirm('PDF文件不存在或已过期，是否重新生成？')) {
                        generatePdf(digestId, downloadLink);
                    } else {
                        document.body.removeChild(downloadLink);
                    }
                } else {
                    document.body.removeChild(downloadLink);
                    throw new Error(`HTTP ${response.status}`);
                }
            })
            .catch(error => {
                console.error('Error checking PDF:', error);
                document.body.removeChild(downloadLink);
                // 出错时也询问是否生成
                if (confirm('检查PDF状态失败，是否重新生成？')) {
                    const newDownloadLink = document.createElement('a');
                    newDownloadLink.style.display = 'none';
                    document.body.appendChild(newDownloadLink);
                    generatePdf(digestId, newDownloadLink);
                }
            });
    }

    // 下载PDF文件
    function downloadPdf(digestId, downloadLink) {
        // 先获取快报信息以获得正确的日期
        axios.get(`/api/digest/${digestId}`)
            .then(response => {
                const digest = response.data;
                const digestDate = new Date(digest.date);
                const dateStr = digestDate.toISOString().slice(0, 10).replace(/-/g, '');
                
                // 构建基于当前页面origin的绝对URL，确保跨设备兼容性
                const baseUrl = window.location.origin;
                const pdfUrl = `${baseUrl}/api/digest/${digestId}/pdf`;
                downloadLink.href = pdfUrl;
                downloadLink.download = `每日网安情报速递【${dateStr}】.pdf`;
                downloadLink.target = '_blank';
                downloadLink.click();
                
                // 清理DOM
                setTimeout(() => {
                    if (downloadLink.parentNode) {
                        document.body.removeChild(downloadLink);
                    }
                }, 100);
                
                console.log('PDF下载已启动，URL:', pdfUrl);
            })
            .catch(error => {
                console.error('Error getting digest info for download:', error);
                // 如果获取快报信息失败，使用当前日期作为备选
                const dateStr = new Date().toISOString().slice(0, 10).replace(/-/g, '');
                
                // 构建基于当前页面origin的绝对URL，确保跨设备兼容性
                const baseUrl = window.location.origin;
                const pdfUrl = `${baseUrl}/api/digest/${digestId}/pdf`;
                downloadLink.href = pdfUrl;
                downloadLink.download = `每日网安情报速递【${dateStr}】.pdf`;
                downloadLink.target = '_blank';
                downloadLink.click();
                
                // 清理DOM
                setTimeout(() => {
                    if (downloadLink.parentNode) {
                        document.body.removeChild(downloadLink);
                    }
                }, 100);
                
                console.log('PDF下载已启动（使用当前日期），URL:', pdfUrl);
            });
    }

    // 生成PDF
    function generatePdf(digestId, downloadLink) {
        // 显示加载提示
        const loadingAlert = document.createElement('div');
        loadingAlert.className = 'alert alert-info';
        loadingAlert.innerHTML = '<i class="bi bi-hourglass-split"></i> 正在生成PDF，请稍候...';
        loadingAlert.style.position = 'fixed';
        loadingAlert.style.top = '20px';
        loadingAlert.style.right = '20px';
        loadingAlert.style.zIndex = '9999';
        document.body.appendChild(loadingAlert);
        
        axios.post(`/api/digest/${digestId}/generate-pdf`)
            .then(response => {
                // 移除加载提示
                document.body.removeChild(loadingAlert);
                
                // 生成成功，直接下载
                downloadPdf(digestId, downloadLink);
                
                console.log('PDF生成并下载成功');
            })
            .catch(error => {
                console.error('Error generating PDF:', error);
                
                // 移除加载提示
                if (loadingAlert.parentNode) {
                    document.body.removeChild(loadingAlert);
                }
                
                // 清理下载链接
                if (downloadLink.parentNode) {
                    document.body.removeChild(downloadLink);
                }
                
                // 根据错误类型显示不同提示
                if (error.response && error.response.status === 503) {
                    alert('PDF生成服务暂不可用，请稍后重试');
                } else {
                    alert('生成PDF失败，请重试');
                }
            });
    }

    // 辅助函数 - 格式化日期
    function formatDate(dateStr) {
        if (!dateStr) return '';
        const date = new Date(dateStr);
        return date.toLocaleString();
    }

    // 辅助函数 - 渲染新闻计数徽章
    function renderNewsCountBadges(counts) {
        if (!counts) return '';

        const badges = [];
        const categoryLabels = {
            '金融业网络安全事件': '金融业',
            '重大网络安全事件': '重大事件',
            '重大数据泄露事件': '数据泄露',
            '重大漏洞风险提示': '漏洞风险',
            '其他': '其他'
        };

        const categoryColors = {
            '金融业网络安全事件': 'info',
            '重大网络安全事件': 'danger',
            '重大数据泄露事件': 'warning',
            '重大漏洞风险提示': 'primary',
            '其他': 'secondary'
        };

        for (const [category, count] of Object.entries(counts)) {
            const label = categoryLabels[category] || category;
            const color = categoryColors[category] || 'secondary';
            badges.push(`<span class="badge bg-${color} me-1">${label}: ${count}</span>`);
        }

        return badges.join(' ');
    }

    // 查看新闻详情
    function viewNewsDetail(newsId) {
        axios.get(`/api/news/${newsId}`)
            .then(response => {
                const news = response.data;
                
                const detailContent = document.getElementById('newsDetailContent');
                
                let entitiesHtml = '';
                if (news.entities) {
                    entitiesHtml = '<div class="mt-3"><h6><strong>提取的实体</strong></h6><ul>';

                    // 检查实体是否为数组格式
                    if (Array.isArray(news.entities)) {
                        news.entities.forEach(entity => {
                            if (typeof entity === 'object' && entity !== null) {
                                // 处理不同格式的实体对象
                                if (entity.type && entity.value) {
                                    // 标准格式 {type: "...", value: "..."}
                                    entitiesHtml += `<li><strong>${entity.type}:</strong> ${entity.value}</li>`;
                                } else {
                                    // 处理其他格式 {key: value}
                                    const entityType = Object.keys(entity)[0] || '未知类型';
                                    const entityValue = entity[entityType] || '未知';
                                    entitiesHtml += `<li><strong>${entityType}:</strong> ${entityValue}</li>`;
                                }
                            } else {
                                entitiesHtml += `<li>${entity}</li>`;
                            }
                        });
                    }
                    // 检查实体是否为对象格式
                    else if (typeof news.entities === 'object') {
                        // 检查是否有type和value字段的特殊对象
                        if (news.entities.type && news.entities.value) {
                            entitiesHtml += `<li><strong>${news.entities.type}:</strong> ${news.entities.value}</li>`;
                        } else {
                            // 常规对象格式 {key1: value1, key2: value2}
                            for (const [key, value] of Object.entries(news.entities)) {
                                if (key !== 'error') {
                                    entitiesHtml += `<li><strong>${key}:</strong> ${value}</li>`;
                                }
                            }
                        }
                    }

                    entitiesHtml += '</ul></div>';
                }

                detailContent.innerHTML = `
                    <h4>${news.title}</h4>
                    <div class="text-muted mb-2">来源: ${news.source_name || '未知来源'} | 时间: ${formatDate(news.created_at)}</div>
                    
                    <div class="card mb-3">
                        <div class="card-header bg-light">原始内容摘要</div>
                        <div class="card-body">
                            <p>${news.summary}</p>
                            <a href="${news.original_url}" target="_blank" class="btn btn-sm btn-outline-primary">查看原文</a>
                        </div>
                    </div>
                    
                    <div class="card mb-3">
                        <div class="card-header bg-light">处理结果</div>
                        <div class="card-body">
                            ${news.is_processed ? `
                                <div class="mb-2"><strong>一句话标题:</strong> ${news.generated_title || '暂无'}</div>
                                <div class="mb-2"><strong>摘要:</strong> ${news.generated_summary || '暂无'}</div>
                                <div class="mb-2"><strong>分类:</strong> ${getCategoryLabel(news.category)}</div>
                                ${entitiesHtml}
                                
                                ${news.article_summary ? `
                                <div class="card mb-3 mt-3">
                                    <div class="card-header bg-light">详细文章总结</div>
                                    <div class="card-body">
                                        <div class="article-summary">${news.article_summary}</div>
                                    </div>
                                </div>
                                ` : '<div class="alert alert-info mt-2">该新闻还没有生成详细文章总结</div>'}
                                
                                ${news.tokens_usage ? `
                                <div class="card mt-3">
                                    <div class="card-header bg-light">Tokens使用统计</div>
                                    <div class="card-body">
                                        <table class="table table-sm table-striped">
                                            <thead>
                                                <tr>
                                                    <th>处理类型</th>
                                                    <th>Prompt Tokens</th>
                                                    <th>Completion Tokens</th>
                                                    <th>总计</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                ${formatTokensUsage(news.tokens_usage)}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                                ` : ''}
                            ` : '<div class="alert alert-warning">该新闻尚未处理</div>'}
                        </div>
                    </div>
                `;

                // 显示模态框 - 使用 getOrCreateInstance 避免创建多个实例导致 backdrop 残留
                const modalElement = document.getElementById('newsDetailModal');
                const modal = bootstrap.Modal.getOrCreateInstance(modalElement);
                modal.show();
            })
            .catch(error => {
                console.error('Error loading news details:', error);
                alert('加载新闻详情失败');
            });
    }

    // 获取分类标签
    function getCategoryLabel(category) {
        const categoryMap = {
            '金融业网络安全事件': '金融业网络安全事件',
            '重大网络安全事件': '重大网络安全事件', 
            '重大数据泄露事件': '重大数据泄露事件',
            '重大漏洞风险提示': '重大漏洞风险提示',
            '其他': '其他'
        };
        return categoryMap[category] || category || '未分类';
    }

    // 格式化tokens使用信息
    function formatTokensUsage(tokensUsage) {
        if (!tokensUsage) return '';
        
        let html = '';
        let totalPromptTokens = 0;
        let totalCompletionTokens = 0;
        let totalTokens = 0;
        
        // 处理类型映射表
        const typeLabels = {
            'title_translation': '标题翻译',
            'summary_translation': '摘要翻译', 
            'content_translation': '内容翻译',
            'article_summary': '文章总结',
            'category': '分类',
            'entities': '实体提取'
        };
        
        for (const [type, usage] of Object.entries(tokensUsage)) {
            if (!usage) continue;
            
            let promptTokens = 0;
            let completionTokens = 0;
            let tokensSum = 0;
            
            if (typeof usage === 'object') {
                promptTokens = usage.prompt_tokens || 0;
                completionTokens = usage.completion_tokens || 0;
                tokensSum = usage.total_tokens || (promptTokens + completionTokens);
                
                totalPromptTokens += promptTokens;
                totalCompletionTokens += completionTokens;
                totalTokens += tokensSum;
                
                const label = typeLabels[type] || type;
                html += `
                    <tr>
                        <td>${label}</td>
                        <td>${promptTokens}</td>
                        <td>${completionTokens}</td>
                        <td>${tokensSum}</td>
                    </tr>
                `;
            }
        }
        
        // 添加总计行
        html += `
            <tr class="table-primary">
                <td><strong>总计</strong></td>
                <td><strong>${totalPromptTokens}</strong></td>
                <td><strong>${totalCompletionTokens}</strong></td>
                <td><strong>${totalTokens}</strong></td>
            </tr>
        `;
        
        return html;
    }

    // 增强快报内容，为数据库新闻添加查看详情按钮和重复检测标记
    function enhanceDigestContent(markdownContent, newsIds, digestId = null) {
        if (!markdownContent || newsIds.length === 0) {
            return Promise.resolve(marked.parse(markdownContent || ''));
        }

        // 首先获取所有关联新闻的详细信息
        const newsPromises = newsIds.map(id =>
            axios.get(`/api/news/${id}`).then(response => response.data).catch(error => null)
        );

        // 如果有digestId，也获取重复检测状态
        const duplicateStatusPromise = digestId ?
            axios.get(`/api/digest/${digestId}/duplicate-detection-status`)
                .then(response => {
                    // 检查整体检测状态，如果正在检测则为新闻创建临时标记
                    const detectionStatus = response.data.detection_status;
                    const results = response.data.duplicate_detection_results;

                    // 如果检测正在进行中，为没有结果的新闻添加"正在检测"状态
                    if (detectionStatus === 'running') {
                        newsIds.forEach(newsId => {
                            if (!results[newsId]) {
                                results[newsId] = { status: 'checking' };
                            }
                        });
                    } else if (detectionStatus === 'pending') {
                        // 如果检测还未开始，为新闻添加"等待检测"状态
                        newsIds.forEach(newsId => {
                            if (!results[newsId]) {
                                results[newsId] = { status: 'pending' };
                            }
                        });
                    }

                    return results;
                })
                .catch(error => {
                    console.warn('获取重复检测状态失败:', error);
                    return {};
                }) : Promise.resolve({});

        return Promise.all([Promise.all(newsPromises), duplicateStatusPromise])
            .then(([newsDetails, duplicateStatus]) => {
                // 过滤掉获取失败的新闻
                const validNewsDetails = newsDetails.filter(news => news !== null);

                // 将Markdown转换为HTML
                let htmlContent = marked.parse(markdownContent);

                // 使用DOM解析器来更精确地匹配和修改内容
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = htmlContent;

                // 查找所有的strong标签（新闻标题）
                const strongTags = tempDiv.querySelectorAll('strong');

                strongTags.forEach(strongTag => {
                    const titleText = strongTag.textContent.trim();

                    // 查找匹配的新闻
                    const matchedNews = validNewsDetails.find(news => {
                        const possibleTitles = [news.title, news.generated_title].filter(Boolean);
                        return possibleTitles.some(title => {
                            // 进行部分匹配，允许标题略有不同
                            return titleText.includes(title) || title.includes(titleText) ||
                                   titleText.toLowerCase() === title.toLowerCase();
                        });
                    });

                    if (matchedNews) {
                        // 创建按钮容器
                        const buttonContainer = document.createElement('span');
                        buttonContainer.className = 'ms-2 d-inline-flex gap-1 align-items-center';

                        // 创建查看详情按钮
                        const detailBtn = document.createElement('button');
                        detailBtn.className = 'btn btn-sm btn-outline-info';
                        detailBtn.setAttribute('onclick', `viewNewsDetail(${matchedNews.id})`);
                        detailBtn.setAttribute('title', '查看详情');
                        detailBtn.innerHTML = '<i class="bi bi-info-circle"></i>';
                        buttonContainer.appendChild(detailBtn);

                        // 添加重复检测标记
                        const detection = duplicateStatus[matchedNews.id];
                        if (detection) {
                            const duplicateBadge = createDuplicateBadge(detection, matchedNews.id);
                            buttonContainer.appendChild(duplicateBadge);
                        }

                        // 在strong标签后添加按钮容器
                        strongTag.parentNode.insertBefore(buttonContainer, strongTag.nextSibling);

                        // 标记该新闻已处理，避免重复添加按钮
                        strongTag.setAttribute('data-news-enhanced', 'true');
                    }
                });

                return tempDiv.innerHTML;
            }).catch(error => {
                console.error('Error enhancing digest content:', error);
                // 如果增强失败，返回原始HTML
                return marked.parse(markdownContent);
            });
    }

    // 创建重复检测标记
    function createDuplicateBadge(detection, newsId) {
        const badge = document.createElement('span');
        badge.className = 'duplicate-detection-badge';
        badge.setAttribute('data-news-id', newsId);

        switch (detection.status) {
            case 'pending':
                badge.className += ' badge bg-secondary text-white';
                badge.innerHTML = '<i class="bi bi-hourglass"></i> 等待检测';
                badge.title = '等待开始重复检测';
                break;
            case 'checking':
                badge.className += ' badge bg-warning text-dark';
                badge.innerHTML = '<i class="bi bi-clock"></i> 正在检测';
                badge.title = '正在使用AI检测是否与历史新闻重复';
                break;

            case 'duplicate':
                badge.className += ' badge bg-danger';
                badge.innerHTML = '<i class="bi bi-exclamation-triangle"></i> 疑似重复';
                badge.title = `相似度: ${(detection.similarity_score * 100).toFixed(1)}%`;
                badge.style.cursor = 'pointer';
                badge.setAttribute('data-detection', JSON.stringify(detection));
                badge.classList.add('duplicate-clickable');
                break;

            case 'no_duplicate':
                badge.className += ' badge bg-success';
                badge.innerHTML = '<i class="bi bi-check-circle"></i> 无重复';
                badge.title = '已确认与历史新闻无重复';
                break;

            case 'error':
                badge.className += ' badge bg-secondary';
                badge.innerHTML = '<i class="bi bi-x-circle"></i> 检测出错';
                badge.title = '重复检测过程出现错误';
                break;

            default:
                badge.className += ' badge bg-light text-dark';
                badge.innerHTML = '<i class="bi bi-question-circle"></i> 未知状态';
        }

        return badge;
    }

    // 显示重复检测详情
    function showDuplicateDetails(detection) {
        // 如果有重复的新闻ID，先获取该新闻的详细信息
        if (detection.duplicate_with_news_id) {
            // 显示加载状态的模态框
            showDuplicateDetailsModal(detection, null, true);

            // 异步获取重复新闻的详细信息
            axios.get(`/api/news/${detection.duplicate_with_news_id}`)
                .then(response => {
                    const duplicateNews = response.data;
                    showDuplicateDetailsModal(detection, duplicateNews, false);
                })
                .catch(error => {
                    console.error('获取重复新闻详情失败:', error);
                    showDuplicateDetailsModal(detection, null, false);
                });
        } else {
            showDuplicateDetailsModal(detection, null, false);
        }
    }

    // 实际显示重复检测详情模态框
    function showDuplicateDetailsModal(detection, duplicateNews, isLoading) {
        // 移除现有的模态框
        const existingModal = document.getElementById('duplicateDetailsModal');
        if (existingModal) {
            document.body.removeChild(existingModal);
        }

        const modal = document.createElement('div');
        modal.id = 'duplicateDetailsModal';
        modal.className = 'modal fade';

        // 构建重复新闻所属快报信息
        let digestInfo = '';
        if (duplicateNews && duplicateNews.digests && duplicateNews.digests.length > 0) {
            // 找到最新的快报（按创建时间排序）
            const latestDigest = duplicateNews.digests.sort((a, b) => new Date(b.created_at) - new Date(a.created_at))[0];
            const digestDate = new Date(latestDigest.date).toLocaleDateString('zh-CN');
            digestInfo = `
                <div class="mb-3">
                    <h6><i class="bi bi-calendar-event me-1"></i>所属快报</h6>
                    <div class="border rounded p-3 bg-light">
                        <p class="mb-2"><strong>快报标题:</strong> ${latestDigest.title}</p>
                        <p class="mb-2"><strong>快报日期:</strong> ${digestDate}</p>
                        <div class="d-flex gap-2">
                            <a href="/digest?view=${latestDigest.id}" target="_blank" class="btn btn-sm btn-success">
                                <i class="bi bi-box-arrow-up-right me-1"></i>在新标签页查看该快报
                            </a>
                            <button class="btn btn-sm btn-outline-primary" onclick="viewDigest(${latestDigest.id})" data-bs-dismiss="modal">
                                <i class="bi bi-eye me-1"></i>在当前页面查看
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }

        modal.innerHTML = `
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">重复检测详情</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <div class="alert alert-warning d-flex align-items-center mb-3">
                            <i class="bi bi-exclamation-triangle me-2"></i>
                            <div>
                                <strong>检测到疑似重复新闻</strong><br>
                                <small>相似度评分: <strong>${(detection.similarity_score * 100).toFixed(1)}%</strong></small>
                            </div>
                        </div>

                        ${detection.duplicate_with_news_id ? `
                            <div class="mb-3">
                                <h6><i class="bi bi-newspaper me-1"></i>重复的历史新闻</h6>
                                <div class="border rounded p-3 bg-light">
                                    ${isLoading ? `
                                        <div class="text-center py-2">
                                            <div class="spinner-border spinner-border-sm text-primary me-2" role="status">
                                                <span class="visually-hidden">加载中...</span>
                                            </div>
                                            正在获取新闻详情...
                                        </div>
                                    ` : `
                                        <p class="mb-2"><strong>新闻ID:</strong> ${detection.duplicate_with_news_id}</p>
                                        ${duplicateNews ? `
                                            <p class="mb-2"><strong>新闻标题:</strong> ${duplicateNews.title || duplicateNews.generated_title}</p>
                                            <p class="mb-2"><strong>发布时间:</strong> ${duplicateNews.publish_date ? new Date(duplicateNews.publish_date).toLocaleString('zh-CN') : '未知'}</p>
                                        ` : ''}
                                        <div class="d-flex gap-2">
                                            <button class="btn btn-sm btn-primary"
                                                    onclick="viewNewsDetail(${detection.duplicate_with_news_id})"
                                                    data-bs-dismiss="modal">
                                                <i class="bi bi-eye me-1"></i>查看完整新闻内容
                                            </button>
                                            <button class="btn btn-sm btn-outline-secondary"
                                                    onclick="copyNewsId(${detection.duplicate_with_news_id})">
                                                <i class="bi bi-copy me-1"></i>复制新闻ID
                                            </button>
                                        </div>
                                    `}
                                </div>
                            </div>

                            ${digestInfo}
                        ` : ''}

                        ${detection.llm_reasoning ? `
                            <div class="mb-3">
                                <h6><i class="bi bi-cpu me-1"></i>AI分析判断过程</h6>
                                <div class="border rounded bg-light" style="max-height: 300px; overflow-y: auto;">
                                    <pre class="p-3 m-0" style="white-space: pre-wrap; font-size: 12px; line-height: 1.4;">${detection.llm_reasoning}</pre>
                                </div>
                            </div>
                        ` : ''}

                        <div class="text-muted small">
                            <i class="bi bi-clock me-1"></i>检测时间: ${new Date(detection.checked_at).toLocaleString()}
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
                    </div>
                </div>
            </div>
        `;

        document.body.appendChild(modal);
        const bsModal = new bootstrap.Modal(modal);
        bsModal.show();

        // 在模态框关闭后清理DOM
        modal.addEventListener('hidden.bs.modal', () => {
            if (document.body.contains(modal)) {
                document.body.removeChild(modal);
            }
        });
    }

    // 异步状态更新机制
    let duplicateDetectionInterval = null;
    let currentViewDigestId = null;
    let countdownInterval = null;
    let detectionEstimation = null;
    let currentRefreshInterval = 3000; // 当前刷新间隔
    let lastDetectionStatus = null; // 上次检测状态
    let currentDetectionContainer = null; // 当前倒计时显示容器

    function getDetectionContainer() {
        if (currentDetectionContainer) {
            return currentDetectionContainer;
        }
        return document.getElementById('viewDigestContent');
    }

    // 启动重复检测状态更新
    function startDuplicateDetectionUpdates(digestId, containerElement = null) {
        const digestChanged = currentViewDigestId !== null && currentViewDigestId !== digestId;

        if (digestChanged) {
            stopDuplicateDetectionUpdates();
        }

        if (containerElement) {
            if (!digestChanged && currentDetectionContainer && currentDetectionContainer !== containerElement) {
                removeEstimationDisplay(digestId, currentDetectionContainer);
            }
            currentDetectionContainer = containerElement;
        } else if (!currentDetectionContainer) {
            currentDetectionContainer = document.getElementById('viewDigestContent');
        }

        if (!currentDetectionContainer) {
            console.warn('未找到重复检测显示容器');
            return;
        }

        currentViewDigestId = digestId;

        if (!duplicateDetectionInterval) {
            // 启动自适应刷新（内部会检查状态并决定是否获取预估）
            startAdaptiveRefresh(digestId);
        } else {
            // 如果已有估算信息，立即同步到新容器
            if (detectionEstimation) {
                showEstimationInfo(digestId, detectionEstimation);
            } else {
                showDetectionInProgress(digestId);
            }
        }

        console.log(`已启动快报 ${digestId} 的重复检测状态更新`);
    }

    // 启动自适应刷新机制
    function startAdaptiveRefresh(digestId) {
        // 先检查检测状态，决定是否需要启动更新机制
        axios.get(`/api/digest/${digestId}/duplicate-detection-status`)
            .then(response => {
                const detectionStatus = response.data.detection_status;
                console.log(`快报 ${digestId} 检测状态: ${detectionStatus}`);

                if (detectionStatus === 'completed') {
                    console.log('检测已完成，不启动状态更新');
                    removeEstimationDisplay(digestId);
                    return;
                }

                // 检测进行中，启动更新机制
                console.log('检测进行中，启动状态更新');

                // 获取时间预估并启动倒计时
                fetchDetectionEstimation(digestId);

                // 初始检查
                updateDuplicateDetectionStatus(digestId);

                // 设置定时器
                duplicateDetectionInterval = setInterval(() => {
                    updateDuplicateDetectionStatus(digestId);
                }, currentRefreshInterval);
            })
            .catch(error => {
                console.warn('检查检测状态失败，尝试启动更新:', error);
                // 如果检查失败，还是尝试启动更新
                updateDuplicateDetectionStatus(digestId);
                duplicateDetectionInterval = setInterval(() => {
                    updateDuplicateDetectionStatus(digestId);
                }, currentRefreshInterval);
            });
    }

    // 调整刷新间隔
    function adjustRefreshInterval(detectionStatus, hasActiveChecking) {
        let newInterval;

        if (detectionStatus === 'running' && hasActiveChecking) {
            // 检测正在进行且有活跃检查：2秒一次
            newInterval = 2000;
        } else if (detectionStatus === 'running') {
            // 检测进行中但没有活跃检查：3秒一次
            newInterval = 3000;
        } else if (detectionStatus === 'pending') {
            // 等待开始检测：5秒一次
            newInterval = 5000;
        } else {
            // 检测完成或其他状态：8秒一次
            newInterval = 8000;
        }

        // 只有间隔发生变化时才重新设置定时器
        if (newInterval !== currentRefreshInterval) {
            console.log(`调整刷新间隔: ${currentRefreshInterval}ms -> ${newInterval}ms (状态: ${detectionStatus})`);
            currentRefreshInterval = newInterval;

            // 重新启动定时器
            if (duplicateDetectionInterval && currentViewDigestId) {
                clearInterval(duplicateDetectionInterval);
                duplicateDetectionInterval = setInterval(() => {
                    updateDuplicateDetectionStatus(currentViewDigestId);
                }, currentRefreshInterval);
            }
        }
    }

    // 停止重复检测状态更新
    function stopDuplicateDetectionUpdates() {
        if (duplicateDetectionInterval) {
            clearInterval(duplicateDetectionInterval);
            duplicateDetectionInterval = null;
            console.log('已停止重复检测状态更新');
        }

        if (currentViewDigestId && currentDetectionContainer) {
            removeEstimationDisplay(currentViewDigestId, currentDetectionContainer);
        }

        currentViewDigestId = null;
        currentDetectionContainer = null;
        detectionEstimation = null;
        currentRefreshInterval = 3000;
        lastDetectionStatus = null;

        // 停止倒计时
        stopCountdown();
    }

    // 更新重复检测状态
    function updateDuplicateDetectionStatus(digestId) {
        if (!digestId || digestId !== currentViewDigestId) {
            return;
        }

        // 首先获取状态信息（必需），然后尝试获取进度信息（可选）
        axios.get(`/api/digest/${digestId}/duplicate-detection-status`)
            .then(statusResponse => {
                const results = statusResponse.data.duplicate_detection_results;
                const detectionStatus = statusResponse.data.detection_status;
                let hasUpdates = false;

                // 尝试获取进度信息（可选）
                axios.get(`/api/digest/${digestId}/duplicate-detection-progress`)
                    .then(progressResponse => {
                        const progress = progressResponse.data.progress;
                        // 更新进度显示
                        if (progress) {
                            updateProgressDisplay(digestId, progress);
                        }
                    })
                    .catch(progressError => {
                        // 进度API失败不影响主要逻辑，只记录日志
                        console.debug('获取进度信息失败（正常情况）:', progressError.message);
                    });

                // 检查是否有正在进行的检测
                const hasActiveChecking = Object.values(results).some(result => result.status === 'checking');

                // 调整刷新间隔
                adjustRefreshInterval(detectionStatus, hasActiveChecking);

                // 检查是否有状态变化
                document.querySelectorAll('.duplicate-detection-badge').forEach(badge => {
                    const newsId = parseInt(badge.getAttribute('data-news-id'));
                    let detection = results[newsId];

                    // 如果检测正在进行但没有具体结果，显示检测中状态
                    if (!detection && detectionStatus === 'running') {
                        detection = { status: 'checking' };
                    } else if (!detection && detectionStatus === 'pending') {
                        detection = { status: 'pending' };
                    }

                    if (detection) {
                        const currentStatus = badge.textContent.trim();
                        const newBadge = createDuplicateBadge(detection, newsId);

                        // 比较状态是否发生变化
                        if (newBadge.textContent.trim() !== currentStatus) {
                            // 替换旧的标记
                            badge.parentNode.replaceChild(newBadge, badge);
                            hasUpdates = true;

                            // 如果检测完成，显示通知并立即刷新一次
                            if (detection.status !== 'checking' && detection.status !== 'pending') {
                                showDetectionCompleteNotification(newsId, detection);

                                // 检测完成后立即进行额外的刷新以确保状态同步
                                setTimeout(() => {
                                    console.log(`新闻 ${newsId} 检测完成，进行立即刷新`);
                                    updateDuplicateDetectionStatus(digestId);
                                }, 500);
                            }
                        }
                    }
                });

                // 如果所有检测都完成了，可以停止更新
                const allStatuses = Object.values(results);
                const allCompleted = allStatuses.every(status => status.status !== 'checking');

                if (allCompleted && allStatuses.length > 0) {
                    console.log('所有重复检测已完成，停止状态更新');

                    // 移除预估信息显示
                    removeEstimationDisplay(digestId);

                    // 停止更新和倒计时
                    stopDuplicateDetectionUpdates();
                }

                if (hasUpdates) {
                    console.log(`快报 ${digestId} 重复检测状态已更新`);
                }
            })
            .catch(error => {
                console.warn('获取重复检测状态失败:', error);
                // 如果状态API失败，停止更新以避免持续错误
                stopDuplicateDetectionUpdates();
            });
    }

    // 显示检测完成通知
    function showDetectionCompleteNotification(newsId, detection) {
        const notificationContainer = document.getElementById('notification-container') ||
            createNotificationContainer();

        const notification = document.createElement('div');
        notification.className = 'toast align-items-center border-0';
        notification.setAttribute('role', 'alert');
        notification.setAttribute('aria-live', 'assertive');
        notification.setAttribute('aria-atomic', 'true');

        let bgClass = 'bg-primary';
        let iconClass = 'bi-info-circle';
        let message = '';

        switch (detection.status) {
            case 'duplicate':
                bgClass = 'bg-warning';
                iconClass = 'bi-exclamation-triangle';
                message = `新闻 ${newsId} 疑似重复 (相似度: ${(detection.similarity_score * 100).toFixed(1)}%)`;
                break;
            case 'no_duplicate':
                bgClass = 'bg-success';
                iconClass = 'bi-check-circle';
                message = `新闻 ${newsId} 检测完成，无重复`;
                break;
            case 'error':
                bgClass = 'bg-danger';
                iconClass = 'bi-x-circle';
                message = `新闻 ${newsId} 重复检测出错`;
                break;
        }

        notification.classList.add(bgClass, 'text-white');
        notification.innerHTML = `
            <div class="d-flex">
                <div class="toast-body">
                    <i class="bi ${iconClass} me-2"></i>
                    ${message}
                </div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto"
                        data-bs-dismiss="toast" aria-label="Close"></button>
            </div>
        `;

        notificationContainer.appendChild(notification);

        const bsToast = new bootstrap.Toast(notification, {
            delay: 5000
        });
        bsToast.show();

        // 清理DOM
        notification.addEventListener('hidden.bs.toast', () => {
            notificationContainer.removeChild(notification);
        });
    }

    // 创建通知容器
    function createNotificationContainer() {
        const container = document.createElement('div');
        container.id = 'notification-container';
        container.className = 'toast-container position-fixed top-0 end-0 p-3';
        container.style.zIndex = '9999';
        document.body.appendChild(container);
        return container;
    }

    // 复制新闻ID到剪贴板
    function copyNewsId(newsId) {
        navigator.clipboard.writeText(newsId.toString()).then(() => {
            // 显示复制成功提示
            const toast = document.createElement('div');
            toast.className = 'toast align-items-center text-white bg-success border-0';
            toast.setAttribute('role', 'alert');
            toast.innerHTML = `
                <div class="d-flex">
                    <div class="toast-body">
                        <i class="bi bi-check-circle me-2"></i>新闻ID ${newsId} 已复制到剪贴板
                    </div>
                    <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
                </div>
            `;

            const container = document.getElementById('notification-container') || createNotificationContainer();
            container.appendChild(toast);

            const bsToast = new bootstrap.Toast(toast, { delay: 3000 });
            bsToast.show();

            // 清理DOM
            toast.addEventListener('hidden.bs.toast', () => {
                if (container.contains(toast)) {
                    container.removeChild(toast);
                }
            });
        }).catch(err => {
            console.error('复制失败:', err);
            alert(`新闻ID: ${newsId}`);
        });
    }

    // 移动端：摘要文本域自动增高（优化版：简化RAF嵌套，改善性能）
    function autoResizeTextareaMobile(textarea) {
        try {
            // 仅在移动端执行
            if (window.innerWidth > 768) return;

            // 1. 保存光标位置和滚动位置
            const start = textarea.selectionStart;
            const end = textarea.selectionEnd;
            const scrollTop = textarea.scrollTop;

            // 2. 使用单层 requestAnimationFrame 进行高度调整
            requestAnimationFrame(() => {
                const currentHeight = textarea.offsetHeight;
                const scrollHeight = textarea.scrollHeight;

                // 只在需要时才调整（避免不必要的重排）
                if (Math.abs(scrollHeight - currentHeight) > 5) {
                    textarea.style.overflow = 'hidden';
                    textarea.style.boxSizing = 'border-box';

                    // 基于内容的高度，设置上限防止极端内容导致过高
                    const minH = 120;
                    const maxH = 1600;
                    const newHeight = Math.min(Math.max(scrollHeight, minH), maxH);
                    textarea.style.height = newHeight + 'px';
                }

                // 3. 恢复光标和滚动位置（使用微任务延迟，避免RAF嵌套）
                if (document.activeElement === textarea) {
                    Promise.resolve().then(() => {
                        try {
                            textarea.setSelectionRange(start, end);
                            textarea.scrollTop = scrollTop;
                        } catch (e) {
                            // 某些情况下 setSelectionRange 可能失败，忽略错误
                        }
                    });
                }
            });
        } catch (e) {
            console.warn('autoResizeTextareaMobile error:', e);
        }
    }

    function handleMobileAutoResizeInput(e) {
        autoResizeTextareaMobile(e.currentTarget);
    }

    // IME 输入法状态管理（用于中文、日文等输入法）
    const imeComposingMap = new WeakMap();

    function handleCompositionStart(e) {
        // 标记当前元素正在进行输入法输入
        imeComposingMap.set(e.target, true);
    }

    function handleCompositionEnd(e) {
        // 输入法输入结束，移除标记
        imeComposingMap.set(e.target, false);
        // 输入法结束后执行一次高度调整
        if (window.innerWidth <= 768) {
            autoResizeTextareaMobile(e.target);
        }
    }

    function handleMobileAutoResizeInputWithIME(e) {
        // 如果正在进行输入法输入，跳过高度调整
        if (imeComposingMap.get(e.currentTarget)) {
            return;
        }
        autoResizeTextareaMobile(e.currentTarget);
    }

    function bindAutoResizeForAllSummariesMobile() {
        if (window.innerWidth > 768) return;
        document.querySelectorAll('.news-summary-input').forEach(el => {
            autoResizeTextareaMobile(el);
            // 使用标记防止重复绑定
            if (!el.dataset.autoResizeBound) {
                // 使用带 IME 保护的输入处理函数
                el.addEventListener('input', handleMobileAutoResizeInputWithIME, false);
                // 添加 IME composition 事件监听
                el.addEventListener('compositionstart', handleCompositionStart, false);
                el.addEventListener('compositionend', handleCompositionEnd, false);
                el.dataset.autoResizeBound = 'true';
            }
        });
    }

    // ==================== 倒计时功能 ====================

    // 获取检测时间预估
    function fetchDetectionEstimation(digestId) {
        axios.get(`/api/digest/${digestId}/duplicate-detection-estimate`)
            .then(response => {
                detectionEstimation = response.data.estimation;
                console.log('获取到时间预估:', detectionEstimation);

                // 显示预估时间信息
                showEstimationInfo(digestId, detectionEstimation);

                // 启动倒计时
                startCountdown(digestId);
            })
            .catch(error => {
                if (error.response && error.response.status === 404) {
                    console.log('检测已完成或预估不可用，停止状态更新');
                    // 检测已完成，停止状态更新
                    stopDuplicateDetectionUpdates();
                    removeEstimationDisplay(digestId);
                } else {
                    console.warn('获取时间预估失败:', error);
                    // 其他错误，显示检测中状态
                    showDetectionInProgress(digestId);
                }
            });
    }

    // 显示预估信息
    function showEstimationInfo(digestId, estimation) {
        const estimationHtml = `
            <div class="alert alert-info detection-estimation" data-digest-id="${digestId}">
                <div class="d-flex align-items-center">
                    <div class="spinner-border spinner-border-sm text-info me-3" role="status">
                        <span class="visually-hidden">检测中...</span>
                    </div>
                    <div class="flex-grow-1">
                        <h6 class="alert-heading mb-2">
                            <i class="bi bi-hourglass-split"></i> 重复检测进行中
                        </h6>
                        <div class="estimation-details">
                            <div class="row text-start">
                                <div class="col-md-3">
                                    <small class="text-muted">已完成比较:</small><br>
                                    <strong class="completed-comparisons-count text-success">0</strong> / <strong>${estimation.total_comparisons}</strong> 次
                                </div>
                                <div class="col-md-3">
                                    <small class="text-muted">总比较次数:</small><br>
                                    <strong>${estimation.total_comparisons}</strong> 次
                                </div>
                                <div class="col-md-3">
                                    <small class="text-muted">预估总时间:</small><br>
                                    <strong class="countdown-total-time">${estimation.estimated_duration_minutes}</strong> 分钟
                                </div>
                                <div class="col-md-3">
                                    <small class="text-muted">预计完成:</small><br>
                                    <strong class="countdown-completion-time">${formatEstimatedCompletionTime(estimation.estimated_completion_time)}</strong>
                                </div>
                            </div>
                            <div class="mt-3">
                                <div class="progress mb-2" style="height: 8px;">
                                    <div class="progress-bar bg-info progress-bar-striped progress-bar-animated detection-progress-bar"
                                         role="progressbar" style="width: 0%" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">
                                    </div>
                                </div>
                                <div class="d-flex justify-content-between align-items-center">
                                    <span class="countdown-display text-primary fw-bold" style="font-size: 1.1em;">
                                        预计剩余: <span class="countdown-time">计算中...</span>
                                    </span>
                                    <div class="text-end">
                                        <div class="detection-progress-text small text-muted">0% (0/0)</div>
                                        <div class="comparison-status small text-muted">
                                            <i class="bi bi-arrow-repeat text-info"></i> 已比较 <span class="current-comparisons">0</span> 次
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `;

        // 在快报内容的开头插入预估信息
        const digestContent = getDetectionContainer();
        if (digestContent) {
            // 移除已存在的预估信息
            const existingEstimation = digestContent.querySelector('.detection-estimation');
            if (existingEstimation) {
                existingEstimation.remove();
            }

            digestContent.insertAdjacentHTML('afterbegin', estimationHtml);
        }
    }

    // 显示检测进行中（没有预估时的降级显示）
    function showDetectionInProgress(digestId) {
        const progressHtml = `
            <div class="alert alert-info detection-estimation" data-digest-id="${digestId}">
                <div class="d-flex align-items-center">
                    <div class="spinner-border spinner-border-sm text-info me-3" role="status">
                        <span class="visually-hidden">检测中...</span>
                    </div>
                    <div class="flex-grow-1">
                        <h6 class="alert-heading mb-1">
                            <i class="bi bi-hourglass-split"></i> 重复检测进行中
                        </h6>
                        <p class="mb-0 small">正在使用AI分析新闻是否与历史内容重复，请耐心等待...</p>
                    </div>
                </div>
            </div>
        `;

        const digestContent = getDetectionContainer();
        if (digestContent) {
            const existingEstimation = digestContent.querySelector('.detection-estimation');
            if (existingEstimation) {
                existingEstimation.remove();
            }
            digestContent.insertAdjacentHTML('afterbegin', progressHtml);
        }
    }

    // 启动倒计时
    function startCountdown(digestId) {
        if (!detectionEstimation || !detectionEstimation.estimated_completion_time) {
            console.warn('没有预估完成时间，无法启动倒计时');
            return;
        }

        // 清除现有倒计时
        stopCountdown();

        const targetTime = new Date(detectionEstimation.estimated_completion_time);

        countdownInterval = setInterval(() => {
            updateCountdownDisplay(targetTime, digestId);
        }, 1000);

        console.log('已启动倒计时，预计完成时间:', targetTime);
    }

    // 停止倒计时
    function stopCountdown() {
        if (countdownInterval) {
            clearInterval(countdownInterval);
            countdownInterval = null;
        }
    }

    // 更新倒计时显示
    function updateCountdownDisplay(targetTime, digestId) {
        const now = new Date();
        const remainingMs = targetTime.getTime() - now.getTime();

        const container = getDetectionContainer();
        const countdownElement = container ? container.querySelector('.countdown-time') : null;
        if (!countdownElement) {
            return;
        }

        if (remainingMs <= 0) {
            countdownElement.textContent = '即将完成';
            countdownElement.parentElement.className = 'countdown-display text-success fw-bold';
            return;
        }

        const remainingSeconds = Math.floor(remainingMs / 1000);
        const minutes = Math.floor(remainingSeconds / 60);
        const seconds = remainingSeconds % 60;

        if (minutes > 0) {
            countdownElement.textContent = `${minutes} 分 ${seconds} 秒`;
        } else {
            countdownElement.textContent = `${seconds} 秒`;
        }

        // 根据剩余时间调整颜色
        const countdownContainer = countdownElement.parentElement;
        if (remainingSeconds < 30) {
            countdownContainer.className = 'countdown-display text-success fw-bold';
        } else if (remainingSeconds < 120) {
            countdownContainer.className = 'countdown-display text-warning fw-bold';
        } else {
            countdownContainer.className = 'countdown-display text-primary fw-bold';
        }
    }

    // 更新进度显示
    function updateProgressDisplay(digestId, progress) {
        const container = getDetectionContainer();
        const progressBar = container ? container.querySelector('.detection-progress-bar') : null;
        const progressText = container ? container.querySelector('.detection-progress-text') : null;
        const completedCount = container ? container.querySelector('.completed-comparisons-count') : null;

        if (progressBar && progress) {
            progressBar.style.width = `${progress.current_progress}%`;
            progressBar.setAttribute('aria-valuenow', progress.current_progress);
        }

        if (progressText && progress) {
            progressText.textContent = `${progress.current_progress.toFixed(1)}% (${progress.completed_comparisons}/${progress.total_comparisons})`;
        }

        // 更新已完成比较次数显示
        if (completedCount && progress) {
            completedCount.textContent = progress.completed_comparisons;
            // 根据进度动态更新颜色
            if (progress.current_progress >= 100) {
                completedCount.className = 'completed-comparisons-count text-success fw-bold';
            } else if (progress.current_progress >= 50) {
                completedCount.className = 'completed-comparisons-count text-warning fw-bold';
            } else {
                completedCount.className = 'completed-comparisons-count text-info';
            }
        }

        // 更新当前比较次数显示
        const currentComparisons = container ? container.querySelector('.current-comparisons') : null;
        if (currentComparisons && progress) {
            currentComparisons.textContent = progress.completed_comparisons;
        }

        // 如果进度接近完成，更新倒计时
        if (progress && progress.estimated_remaining_time_seconds) {
            const newTargetTime = new Date(Date.now() + progress.estimated_remaining_time_seconds * 1000);

            // 重新调整倒计时目标时间
            if (detectionEstimation) {
                detectionEstimation.estimated_completion_time = newTargetTime.toISOString();
            }
        }
    }

    // 格式化预计完成时间
    function formatEstimatedCompletionTime(isoTimeString) {
        if (!isoTimeString) return '计算中...';

        try {
            const time = new Date(isoTimeString);
            const now = new Date();
            const diffMs = time.getTime() - now.getTime();

            if (diffMs < 0) {
                return '即将完成';
            }

            const diffMinutes = Math.floor(diffMs / (1000 * 60));

            if (diffMinutes < 1) {
                return '不到1分钟';
            } else if (diffMinutes < 60) {
                return `约 ${diffMinutes} 分钟后`;
            } else {
                return time.toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' });
            }
        } catch (error) {
            console.warn('格式化完成时间失败:', error);
            return '计算中...';
        }
    }

    // 移除预估信息显示
    function removeEstimationDisplay(digestId, targetContainer = null) {
        const container = targetContainer || getDetectionContainer();
        if (!container) return;

        const estimationElement = container.querySelector(`.detection-estimation[data-digest-id="${digestId}"]`);
        if (estimationElement) {
            // 添加淡出动画
            estimationElement.style.transition = 'opacity 0.5s ease-out';
            estimationElement.style.opacity = '0';

            setTimeout(() => {
                if (estimationElement.parentNode) {
                    estimationElement.parentNode.removeChild(estimationElement);
                }
            }, 500);
        }
    }

</script>
{% endblock %}
