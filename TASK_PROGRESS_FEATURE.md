# 任务进度跟踪功能

## 功能概述

为每日安全快报系统的定时任务添加了详细的执行进度跟踪功能，实现了实时进度显示和监控。

## 主要功能

### 1. 订阅源更新进度跟踪

**进度计算方式**: 已完成更新的订阅源数量 / 启用的订阅源数量

**显示内容**:
- 当前处理的订阅源名称
- 成功抓取的源数量
- 跳过的源数量
- 处理失败的源数量
- 整体进度百分比
- 详细的处理状态（正在抓取/已完成/跳过/失败）

### 2. 事件分组任务进度跟踪

**进度计算方式**: 已计算相似度的文章对数量 / 需要计算的文章对数量

**显示内容**:
- 相似度计算进度（当前文章对/总文章对数）
- 已计算的文章对数量
- 跳过的文章对数量
- 当前正在比较的新闻标题
- 整体进度百分比
- 执行阶段（相似度计算/分组计算/缓存生成/清理）

## 技术实现

### 1. 后端改进

#### 调度器服务增强 (`app/services/scheduler.py`)
- 添加了 `_update_task_progress_with_percentage()` 方法
- 支持百分比进度计算
- 实时任务状态跟踪
- 详细的阶段信息记录

#### 相似度计算服务改进 (`app/services/news_similarity_storage.py`)
- 添加了进度回调机制
- 支持外部进度监控
- 详细的配对处理统计
- 批量保存时的进度更新

#### API功能扩展 (`app/api/endpoints/sources.py`)
- 状态API返回进度信息
- 任务详情API支持进度查询
- 实时进度数据传输

### 2. 前端改进

#### 管理界面增强 (`app/templates/admin.html`)
- 实时进度条显示
- 动态进度百分比更新
- 任务详情模态框显示进度
- 响应式进度界面

#### 监控脚本优化 (`check_task_status.py`)
- 文本进度条显示
- 详细的阶段信息
- 实时数据刷新
- 多任务并发监控

## 使用效果

### 订阅源抓取进度示例
```
📋 任务类型: crawl_sources
📊 状态: running
💬 当前消息: 正在抓取: freebuf
⏱️ 运行时间: 45.2秒
📈 进度: [██████████░░░░░░░░░░░░░░░░░░░░] 33.3% (5/15)
📡 当前源: freebuf
✅ 成功: 4
⏭️ 跳过: 1
```

### 事件分组任务进度示例
```
📋 任务类型: event_groups
📊 状态: running
💬 当前消息: 正在计算相似度 (2600/45753)
⏱️ 运行时间: 135.9秒
📈 进度: [██░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░] 5.7% (2600/45753)
🎯 阶段: similarity_calculation
🔗 已计算配对: 2599
⏭️ 跳过配对: 0
```

## 数据结构

### 进度信息结构
```json
{
  "current": 2600,
  "total": 45753,
  "percentage": 5.7,
  "stage": "similarity_calculation",
  "stage_details": {
    "calculated_pairs": 2599,
    "skipped_pairs": 0,
    "current_news1": "某安全事件标题...",
    "current_news2": "另一安全事件标题..."
  }
}
```

### 任务状态结构
```json
{
  "status": "running",
  "message": "正在计算相似度 (2600/45753)",
  "start_time": "2025-06-11T01:23:26.000000",
  "running_time": 135.9,
  "last_update": "2025-06-11T01:25:42.318619",
  "progress": {
    "current": 2600,
    "total": 45753,
    "percentage": 5.7
  },
  "stage_details": {
    "stage": "similarity_calculation",
    "calculated_pairs": 2599,
    "skipped_pairs": 0
  }
}
```

## 性能优化

### 1. 进度更新频率控制
- 相似度计算: 每100对更新一次进度
- 批量保存: 每500条记录保存一次
- 前端刷新: 每30秒自动刷新

### 2. 内存管理
- 批量处理避免内存占用过大
- 及时清理临时数据
- 避免频繁的数据库操作

### 3. 用户体验
- 非阻塞的进度更新
- 实时状态反馈
- 详细的错误信息

## 监控方式

### 1. Web界面监控
- 访问管理页面 → 定时任务管理
- 实时查看任务状态和进度
- 点击"详情"查看完整信息

### 2. 命令行监控
```bash
# 检查当前状态
python check_task_status.py

# 监控模式（持续刷新）
python check_task_status.py monitor

# 查看执行历史
python check_task_status.py history
```

### 3. API监控
```bash
# 获取当前任务状态
curl http://localhost:18899/api/sources/scheduler/status

# 获取任务详情
curl http://localhost:18899/api/sources/scheduler/task-details/{timestamp}
```

## 未来扩展

### 1. 更多任务类型支持
- 缓存清理任务进度
- 数据库维护任务进度
- 其他定时任务进度

### 2. 性能指标监控
- 处理速度统计
- 内存使用监控
- 错误率统计

### 3. 通知功能
- 任务完成通知
- 错误告警通知
- 进度里程碑通知

## 故障排除

### 常见问题
1. **进度不更新**: 检查任务是否正常运行
2. **进度跳跃**: 正常现象，可能由于批量处理
3. **任务卡住**: 查看错误日志，可能是资源不足

### 调试方法
- 查看日志文件 `logs/daily_digest.log`
- 使用监控脚本实时查看状态
- 检查任务详情中的错误信息 