# æ—¶é—´æ˜¾ç¤ºä¿®å¤è¯´æ˜

## ğŸ” é—®é¢˜åˆ†æ

**é—®é¢˜ç°è±¡**: æ–°é—»é¡µé¢å¡ç‰‡å·¦ä¸‹è§’æ˜¾ç¤ºçš„æ—¶é—´æ€»æ˜¯"8å°æ—¶å‰"ï¼Œä¸å‡†ç¡®ã€‚

**æ ¹æœ¬åŸå› **: 
1. APIè¿”å›çš„æ—¶é—´ä½¿ç”¨ `datetime.isoformat()` æ ¼å¼åŒ–ï¼Œä¸åŒ…å«æ—¶åŒºä¿¡æ¯
2. å‰ç«¯JavaScriptçš„ `new Date()` æŒ‰æµè§ˆå™¨æœ¬åœ°æ—¶åŒºè§£æï¼Œäº§ç”Ÿ8å°æ—¶åå·®
3. ç³»ç»Ÿå®¹å™¨å†…æ˜¯åŒ—äº¬æ—¶é—´ï¼Œä½†APIè¿”å›çš„æ—¶é—´å­—ç¬¦ä¸²ç¼ºå°‘æ—¶åŒºæ ‡è¯†

## ğŸ› ï¸ ä¿®å¤æ–¹æ¡ˆ

### 1. åç«¯APIä¿®å¤

#### ä¿®æ”¹æ–‡ä»¶
- `app/api/endpoints/news.py`
- `app/api/endpoints/digest.py`

#### å…³é”®æ”¹åŠ¨
```python
# æ·»åŠ æ—¶åŒºæ”¯æŒ
import pytz

# å®šä¹‰åŒ—äº¬æ—¶åŒº
BEIJING_TZ = pytz.timezone('Asia/Shanghai')

def format_datetime_with_tz(dt):
    """å°†datetimeå¯¹è±¡æ ¼å¼åŒ–ä¸ºå¸¦æ—¶åŒºä¿¡æ¯çš„ISOå­—ç¬¦ä¸²"""
    if dt is None:
        return None
    
    # å¦‚æœdatetimeæ˜¯naiveï¼ˆæ²¡æœ‰æ—¶åŒºä¿¡æ¯ï¼‰ï¼Œå‡è®¾å®ƒæ˜¯åŒ—äº¬æ—¶é—´
    if dt.tzinfo is None:
        dt = BEIJING_TZ.localize(dt)
    # å¦‚æœå·²æœ‰æ—¶åŒºä¿¡æ¯ï¼Œè½¬æ¢åˆ°åŒ—äº¬æ—¶åŒº
    else:
        dt = dt.astimezone(BEIJING_TZ)
    
    return dt.isoformat()

# ä½¿ç”¨æ–°çš„æ ¼å¼åŒ–å‡½æ•°
"created_at": format_datetime_with_tz(news.created_at)
```

### 2. å‰ç«¯æ—¶é—´æ˜¾ç¤ºä¼˜åŒ–

#### ä¿®æ”¹æ–‡ä»¶
- `app/templates/news.html`

#### å…³é”®æ”¹åŠ¨
```javascript
// ä¼˜åŒ–çš„æ—¶é—´æ ¼å¼åŒ–å‡½æ•°
function formatDate(dateStr) {
    if (!dateStr) return '';
    
    try {
        const date = new Date(dateStr);
        
        // æ£€æŸ¥æ—¥æœŸæ˜¯å¦æœ‰æ•ˆ
        if (isNaN(date.getTime())) {
            return 'æ—¶é—´æ ¼å¼é”™è¯¯';
        }
        
        const now = new Date();
        const diffMs = now.getTime() - date.getTime();
        const diffMinutes = Math.floor(diffMs / (1000 * 60));
        const diffHours = Math.floor(diffMinutes / 60);
        const diffDays = Math.floor(diffHours / 24);
        
        // ç›¸å¯¹æ—¶é—´æ˜¾ç¤º
        if (diffMinutes < 1) {
            return 'åˆšåˆš';
        } else if (diffMinutes < 60) {
            return `${diffMinutes}åˆ†é’Ÿå‰`;
        } else if (diffHours < 24) {
            return `${diffHours}å°æ—¶å‰`;
        } else if (diffDays < 7) {
            return `${diffDays}å¤©å‰`;
        } else {
            // è¶…è¿‡7å¤©æ˜¾ç¤ºå…·ä½“æ—¥æœŸ
            return date.toLocaleString('zh-CN', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit'
            });
        }
    } catch (error) {
        console.error('æ—¥æœŸæ ¼å¼åŒ–é”™è¯¯:', error);
        return 'æ—¶é—´è§£æå¤±è´¥';
    }
}
```

## âœ… ä¿®å¤æ•ˆæœ

### ä¿®å¤å‰
- APIè¿”å›: `2025-09-04T21:17:47` (æ— æ—¶åŒºä¿¡æ¯)
- å‰ç«¯è§£æ: æŒ‰æµè§ˆå™¨æ—¶åŒºè§£æï¼Œäº§ç”Ÿåå·®
- æ˜¾ç¤ºç»“æœ: "8å°æ—¶å‰" (ä¸å‡†ç¡®)

### ä¿®å¤å
- APIè¿”å›: `2025-09-04T21:17:47+08:00` (åŒ…å«åŒ—äº¬æ—¶åŒº)
- å‰ç«¯è§£æ: æ­£ç¡®è¯†åˆ«æ—¶åŒºä¿¡æ¯
- æ˜¾ç¤ºç»“æœ: "åˆšåˆš"ã€"30åˆ†é’Ÿå‰"ã€"2å°æ—¶å‰" (å‡†ç¡®çš„ç›¸å¯¹æ—¶é—´)

## ğŸ§ª æµ‹è¯•éªŒè¯

### æµ‹è¯•è„šæœ¬
- `scripts/simple_time_test.py` - ç‹¬ç«‹æ—¶é—´æ ¼å¼åŒ–æµ‹è¯•
- `scripts/test_time_display.py` - å®Œæ•´åŠŸèƒ½æµ‹è¯•

### æµ‹è¯•ç»“æœ
```
âœ… æ—¶é—´æ ¼å¼åŒ–æµ‹è¯•é€šè¿‡
âœ… å‰ç«¯è§£ææ¨¡æ‹Ÿæµ‹è¯•é€šè¿‡  
âœ… ç›¸å¯¹æ—¶é—´æµ‹è¯•é€šè¿‡

æµ‹è¯•ç»“æœ: 3/3 é€šè¿‡
ğŸ‰ æ‰€æœ‰æµ‹è¯•é€šè¿‡ï¼æ—¶é—´æ˜¾ç¤ºä¿®å¤æœ‰æ•ˆã€‚
```

## ğŸ“‹ ä¿®å¤è¦†ç›–èŒƒå›´

### APIæ¥å£
- âœ… `/api/news/` - æ–°é—»åˆ—è¡¨
- âœ… `/api/news/recent` - æœ€è¿‘æ–°é—»
- âœ… `/api/news/recent/grouped` - åˆ†ç»„æ–°é—»
- âœ… `/api/digests/` - å¿«æŠ¥åˆ—è¡¨
- âœ… `/api/digests/{id}` - å¿«æŠ¥è¯¦æƒ…

### æ—¶é—´å­—æ®µ
- âœ… `created_at` - åˆ›å»ºæ—¶é—´
- âœ… `fetched_at` - æŠ“å–æ—¶é—´  
- âœ… `publish_date` - å‘å¸ƒæ—¶é—´
- âœ… `date` - å¿«æŠ¥æ—¥æœŸ

### å‰ç«¯é¡µé¢
- âœ… æ–°é—»é¡µé¢ (`/news`) - æ–‡ç« å¡ç‰‡æ—¶é—´æ˜¾ç¤º
- âœ… å¿«æŠ¥é¡µé¢ (`/digest`) - å¿«æŠ¥æ—¶é—´æ˜¾ç¤º
- âœ… ç®¡ç†é¡µé¢ (`/admin`) - å„ç§æ—¶é—´æ˜¾ç¤º

## ğŸ”§ éƒ¨ç½²è¯´æ˜

### é‡å¯åº”ç”¨ç”Ÿæ•ˆ
```bash
# å¦‚æœä½¿ç”¨Docker Compose
docker compose restart daily-digest

# å¦‚æœç›´æ¥è¿è¡Œ
pkill -f "python run.py"  
python run.py
```

### éªŒè¯ä¿®å¤
1. è®¿é—®æ–°é—»é¡µé¢ï¼š`http://localhost:18899/news`
2. æ£€æŸ¥æ–‡ç« å¡ç‰‡å·¦ä¸‹è§’æ—¶é—´æ˜¾ç¤º
3. åº”è¯¥æ˜¾ç¤º"åˆšåˆš"ã€"Xåˆ†é’Ÿå‰"ã€"Xå°æ—¶å‰"ç­‰ç›¸å¯¹æ—¶é—´

## ğŸ¯ æŠ€æœ¯è¦ç‚¹

### æ—¶åŒºå¤„ç†ç­–ç•¥
1. **ç»Ÿä¸€å‡è®¾**: æ•°æ®åº“ä¸­çš„naive datetimeéƒ½æ˜¯åŒ—äº¬æ—¶é—´
2. **æ˜ç¡®æ ‡è¯†**: APIè¿”å›æ—¶é—´å­—ç¬¦ä¸²åŒ…å«`+08:00`æ—¶åŒºæ ‡è¯†
3. **å…¼å®¹å¤„ç†**: æ”¯æŒå„ç§æ—¶åŒºçš„datetimeå¯¹è±¡è½¬æ¢

### å‰ç«¯ä¼˜åŒ–ç‰¹æ€§
1. **ç›¸å¯¹æ—¶é—´**: æ˜¾ç¤º"Xåˆ†é’Ÿå‰"è€Œéå…·ä½“æ—¶é—´æˆ³
2. **é”™è¯¯å¤„ç†**: æ— æ•ˆæ—¶é—´å­—ç¬¦ä¸²çš„å‹å¥½é”™è¯¯æç¤º
3. **ä¸­æ–‡æ ¼å¼**: ä½¿ç”¨ä¸­æ–‡æœ¬åœ°åŒ–çš„æ—¶é—´æ ¼å¼

### æ€§èƒ½è€ƒè™‘
1. **ç¼“å­˜å‹å¥½**: æ—¶åŒºè½¬æ¢åœ¨APIå±‚å®Œæˆï¼Œç»“æœå¯ç¼“å­˜
2. **è®¡ç®—è½»é‡**: å‰ç«¯åªéœ€ç®€å•çš„æ—¶é—´å·®è®¡ç®—
3. **é”™è¯¯éš”ç¦»**: å•ä¸ªæ—¶é—´è§£æå¤±è´¥ä¸å½±å“æ•´ä½“é¡µé¢

## ğŸ“ åç»­ç»´æŠ¤

### æ³¨æ„äº‹é¡¹
1. æ–°å¢æ—¶é—´ç›¸å…³APIæ¥å£æ—¶ï¼Œä½¿ç”¨ `format_datetime_with_tz()` å‡½æ•°
2. æ•°æ®åº“è¿ç§»æ—¶æ³¨æ„æ—¶åŒºä¸€è‡´æ€§
3. ä¸è¦ç›´æ¥ä½¿ç”¨ `datetime.isoformat()`ï¼Œé™¤éç¡®å®šåŒ…å«æ—¶åŒºä¿¡æ¯

### ç›¸å…³æ–‡æ¡£
- [æ—¶åŒºé…ç½®è¯´æ˜](TIMEZONE_CONFIGURATION.md)
- [æ•°æ®åº“æ—¶é—´å­—æ®µè¯´æ˜](../README.md#æ—¶é—´å­—æ®µè¯´æ˜)

---

**ä¿®å¤å®Œæˆæ—¶é—´**: 2025-09-04  
**æµ‹è¯•çŠ¶æ€**: âœ… é€šè¿‡  
**å½±å“èŒƒå›´**: æ‰€æœ‰æ—¶é—´æ˜¾ç¤ºç›¸å…³åŠŸèƒ½
